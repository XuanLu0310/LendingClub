<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Xuan Lu" />

<meta name="date" content="2017-12-21" />

<title>Lending Club Past Loan Analysis and Prediction Working Progress</title>

<script src="LendingClub_xlu1__1__files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="LendingClub_xlu1__1__files/bootstrap-3.3.5/css/united.min.css" rel="stylesheet" />
<script src="LendingClub_xlu1__1__files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="LendingClub_xlu1__1__files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="LendingClub_xlu1__1__files/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="LendingClub_xlu1__1__files/navigation-1.1/tabsets.js"></script>
<script src="LendingClub_xlu1__1__files/htmlwidgets-0.9/htmlwidgets.js"></script>
<script src="LendingClub_xlu1__1__files/plotly-binding-4.7.1/plotly.js"></script>
<script src="LendingClub_xlu1__1__files/typedarray-0.1/typedarray.min.js"></script>
<link href="LendingClub_xlu1__1__files/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="LendingClub_xlu1__1__files/crosstalk-1.0.0/js/crosstalk.min.js"></script>
<link href="LendingClub_xlu1__1__files/plotlyjs-1.29.2/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="LendingClub_xlu1__1__files/plotlyjs-1.29.2/plotly-latest.min.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #f8f8f8; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
pre, code { background-color: #f8f8f8; }
code > span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code > span.dt { color: #204a87; } /* DataType */
code > span.dv { color: #0000cf; } /* DecVal */
code > span.bn { color: #0000cf; } /* BaseN */
code > span.fl { color: #0000cf; } /* Float */
code > span.ch { color: #4e9a06; } /* Char */
code > span.st { color: #4e9a06; } /* String */
code > span.co { color: #8f5902; font-style: italic; } /* Comment */
code > span.ot { color: #8f5902; } /* Other */
code > span.al { color: #ef2929; } /* Alert */
code > span.fu { color: #000000; } /* Function */
code > span.er { color: #a40000; font-weight: bold; } /* Error */
code > span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #000000; } /* Constant */
code > span.sc { color: #000000; } /* SpecialChar */
code > span.vs { color: #4e9a06; } /* VerbatimString */
code > span.ss { color: #4e9a06; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #000000; } /* Variable */
code > span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code > span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code > span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code > span.ex { } /* Extension */
code > span.at { color: #c4a000; } /* Attribute */
code > span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code > span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>



<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Lending Club Past Loan Analysis and Prediction Working Progress</h1>
<h4 class="author"><em>Xuan Lu</em></h4>
<h4 class="date"><em>December 21, 2017</em></h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction"><span class="toc-section-number">1</span> Introduction</a></li>
<li><a href="#data-wrangling-and-exploratory-data-analysis"><span class="toc-section-number">2</span> Data wrangling and exploratory data analysis</a><ul>
<li><a href="#download-and-preprocess-data"><span class="toc-section-number">2.1</span> Download and Preprocess Data</a></li>
<li><a href="#exploratory-data-analysis-and-feature-engineering"><span class="toc-section-number">2.2</span> Exploratory Data Analysis and Feature Engineering</a></li>
<li><a href="#examine-each-of-the-features"><span class="toc-section-number">2.3</span> Examine each of the features</a><ul>
<li><a href="#imputation-missing-value-and-feature-engineering-for-numeric-variables"><span class="toc-section-number">2.3.1</span> Imputation Missing Value and Feature Engineering for Numeric Variables</a></li>
<li><a href="#imputation-missing-value-and-feature-engineering-for-categorical-variables"><span class="toc-section-number">2.3.2</span> Imputation Missing Value and Feature Engineering for Categorical Variables</a><ul>
<li><a href="#zip3-and-emp_title"><span class="toc-section-number">2.3.2.1</span> ZIP3 and emp_title</a></li>
<li><a href="#title"><span class="toc-section-number">2.3.2.2</span> title</a></li>
</ul></li>
</ul></li>
<li><a href="#compute-relevance-between-i.v-d.v."><span class="toc-section-number">2.4</span> Compute relevance between &lt;i.v, d.v.&gt;</a><ul>
<li><a href="#exisiting-numeric-variables"><span class="toc-section-number">2.4.1</span> Exisiting Numeric Variables</a></li>
<li><a href="#new-continous-variables"><span class="toc-section-number">2.4.2</span> New Continous Variables</a></li>
<li><a href="#new-categorical-variables"><span class="toc-section-number">2.4.3</span> New Categorical Variables</a></li>
</ul></li>
<li><a href="#evaluate-relevance-between-selected-i.v."><span class="toc-section-number">2.5</span> Evaluate relevance between selected i.v.</a><ul>
<li><a href="#issue_d"><span class="toc-section-number">2.5.1</span> issue_d</a></li>
<li><a href="#earliest_cr_line-and-last_credit_pull_d"><span class="toc-section-number">2.5.2</span> earliest_cr_line and last_credit_pull_d</a></li>
</ul></li>
<li><a href="#final-model-data-preparation"><span class="toc-section-number">2.6</span> Final Model data Preparation</a></li>
</ul></li>
<li><a href="#build-prediction-model-on-past-loan"><span class="toc-section-number">3</span> Build Prediction Model on Past Loan</a><ul>
<li><a href="#regularized-glm"><span class="toc-section-number">3.1</span> Regularized GLM</a><ul>
<li><a href="#one-hot-encoding-for-nomial-variables"><span class="toc-section-number">3.1.1</span> One hot encoding for nomial variables</a></li>
<li><a href="#grid-search-for-alpha"><span class="toc-section-number">3.1.2</span> Grid Search for alpha</a></li>
<li><a href="#parameters-tunning-for-rf-grid-search"><span class="toc-section-number">3.1.3</span> Parameters Tunning for RF (Grid Search)</a></li>
</ul></li>
<li><a href="#gbm"><span class="toc-section-number">3.2</span> GBM</a><ul>
<li><a href="#default-setup"><span class="toc-section-number">3.2.1</span> Default Setup</a></li>
<li><a href="#tunning-parameters-for-gbm-random-disceret-search"><span class="toc-section-number">3.2.2</span> Tunning Parameters for GBM (Random Disceret search)</a></li>
</ul></li>
<li><a href="#building-models-on-different-feature-imputation-and-selections"><span class="toc-section-number">3.3</span> Building Models on Different Feature Imputation and Selections</a><ul>
<li><a href="#use--999-for-all-missing-values-in-numeric-features"><span class="toc-section-number">3.3.1</span> Use -999 For all missing values in numeric features</a></li>
</ul></li>
</ul></li>
<li><a href="#unsupervised-learning-model-practices"><span class="toc-section-number">4</span> Unsupervised Learning Model Practices</a><ul>
<li><a href="#k-mean-clustering"><span class="toc-section-number">4.1</span> K-mean Clustering</a><ul>
<li><a href="#standard-scaler"><span class="toc-section-number">4.1.1</span> Standard Scaler</a></li>
<li><a href="#minmax-scaler"><span class="toc-section-number">4.1.2</span> MinMax Scaler</a></li>
</ul></li>
<li><a href="#dimensionality-reduction-practices-and-clustering"><span class="toc-section-number">4.2</span> dimensionality Reduction Practices and Clustering</a><ul>
<li><a href="#pca"><span class="toc-section-number">4.2.1</span> PCA</a></li>
<li><a href="#lle"><span class="toc-section-number">4.2.2</span> LLE</a></li>
<li><a href="#mds"><span class="toc-section-number">4.2.3</span> MDS</a></li>
<li><a href="#isomap"><span class="toc-section-number">4.2.4</span> isomap</a></li>
<li><a href="#t-sne"><span class="toc-section-number">4.2.5</span> t-SNE</a></li>
</ul></li>
</ul></li>
</ul>
</div>

<div id="introduction" class="section level1">
<h1><span class="header-section-number">1</span> Introduction</h1>
<p>This is a one-month project that analyzes the loan data from lending clud and builds a model to predict whether a loan record will result in default, in order to rejects possible bad loan applications at the very beginning.</p>
<p>The data was downloaded from <a href="https://www.lendingclub.com/info/download-data.action" class="uri">https://www.lendingclub.com/info/download-data.action</a>. This dataset contains loan data from 2012 to 2016 and data from 2012 to 2015 will be used as training data and 2016 data for test.</p>
</div>
<div id="data-wrangling-and-exploratory-data-analysis" class="section level1">
<h1><span class="header-section-number">2</span> Data wrangling and exploratory data analysis</h1>
<div id="download-and-preprocess-data" class="section level2">
<h2><span class="header-section-number">2.1</span> Download and Preprocess Data</h2>
<p>The data can be downloaded from <a href="https://www.lendingclub.com/info/download-data.action" class="uri">https://www.lendingclub.com/info/download-data.action</a>. In this project, we only used data from 2012 to 2016. The discreptions of each field can be downloaded from <a href="https://resources.lendingclub.com/LCDataDictionary.xlsx" class="uri">https://resources.lendingclub.com/LCDataDictionary.xlsx</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(data.table)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(plyr)
<span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(kableExtra)
<span class="kw">library</span>(dygraphs)
<span class="kw">library</span>(knitr)
<span class="kw">library</span>(plotly)
<span class="kw">library</span>(stringr)
<span class="kw">library</span>(lubridate)
<span class="kw">library</span>(Matrix)</code></pre></div>
<p>The data is downloaded by year or in quater of year. I first combine them into 1 dataset after downloaded. After reading the raw data, I found several empty lines and summary sentence in the middle and at the end of the file,which will create problem when reading in. In r terminal, I used</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">grep <span class="op">-</span>v <span class="op">^</span>[Total<span class="op">|</span>Loan] LoanStats3b_securev1.csv <span class="op">&gt;</span><span class="st"> </span>temp1.csv <span class="co">#2012-2013</span>
grep <span class="op">-</span>v <span class="op">^</span>[Total<span class="op">|</span>Loan] LoanStats3c_securev1.csv <span class="op">&gt;</span><span class="st"> </span>temp2.csv <span class="co">#2014</span>
grep <span class="op">-</span>v <span class="op">^</span>[Total<span class="op">|</span>Loan] LoanStats3d_securev1.csv <span class="op">&gt;</span><span class="st"> </span>temp3.csv <span class="co">#2015</span>
grep <span class="op">-</span>v <span class="op">^</span>[Total<span class="op">|</span>Loan] LoanStats_securev1_2016Q1.csv <span class="op">&gt;</span><span class="st"> </span>temp4.csv
grep <span class="op">-</span>v <span class="op">^</span>[Total<span class="op">|</span>Loan] LoanStats_securev1_2016Q2.csv <span class="op">&gt;</span><span class="st"> </span>temp5.csv
grep <span class="op">-</span>v <span class="op">^</span>[Total<span class="op">|</span>Loan] LoanStats_securev1_2016Q3.csv <span class="op">&gt;</span><span class="st"> </span>temp6.csv
grep <span class="op">-</span>v <span class="op">^</span>[Total<span class="op">|</span>Loan] LoanStats_securev1_2016Q4.csv <span class="op">&gt;</span><span class="st"> </span>temp7.csv</code></pre></div>
<p>Then in r console, use read in those temp file again.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat1 &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;temp1.csv&quot;</span>, <span class="dt">na.strings=</span><span class="kw">c</span>(<span class="st">&quot;&quot;</span>,<span class="ot">NA</span>),<span class="dt">blank.lines.skip =</span> <span class="ot">TRUE</span>,<span class="dt">skip =</span> <span class="dv">1</span>)
dat2 &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;temp2.csv&quot;</span>, <span class="dt">na.strings=</span><span class="kw">c</span>(<span class="st">&quot;&quot;</span>,<span class="ot">NA</span>),<span class="dt">blank.lines.skip =</span> <span class="ot">TRUE</span>,<span class="dt">skip =</span> <span class="dv">1</span>)
dat3 &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;temp3.csv&quot;</span>, <span class="dt">na.strings=</span><span class="kw">c</span>(<span class="st">&quot;&quot;</span>,<span class="ot">NA</span>),<span class="dt">blank.lines.skip =</span> <span class="ot">TRUE</span>,<span class="dt">skip =</span> <span class="dv">1</span>)
dat4 &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;temp4.csv&quot;</span>, <span class="dt">na.strings=</span><span class="kw">c</span>(<span class="st">&quot;&quot;</span>,<span class="ot">NA</span>),<span class="dt">blank.lines.skip =</span> <span class="ot">TRUE</span>,<span class="dt">skip =</span> <span class="dv">1</span>)
dat5 &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;temp5.csv&quot;</span>, <span class="dt">na.strings=</span><span class="kw">c</span>(<span class="st">&quot;&quot;</span>,<span class="ot">NA</span>),<span class="dt">blank.lines.skip =</span> <span class="ot">TRUE</span>,<span class="dt">skip =</span> <span class="dv">1</span>)
dat6 &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;temp6.csv&quot;</span>, <span class="dt">na.strings=</span><span class="kw">c</span>(<span class="st">&quot;&quot;</span>,<span class="ot">NA</span>),<span class="dt">blank.lines.skip =</span> <span class="ot">TRUE</span>,<span class="dt">skip =</span> <span class="dv">1</span>)
dat7 &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;temp7.csv&quot;</span>, <span class="dt">na.strings=</span><span class="kw">c</span>(<span class="st">&quot;&quot;</span>,<span class="ot">NA</span>),<span class="dt">blank.lines.skip =</span> <span class="ot">TRUE</span>,<span class="dt">skip =</span> <span class="dv">1</span>)</code></pre></div>
<p>We are going to use data from 2012 to 2015 as trainning set, and 2016 as test set. There is no clear dates keeped in the records,so I will set an indicator “train” to each data set, where from year 2012-2015 it is 1, while 0 in 2016</p>
<p>The data frame is not consistant over years. Data from 2012 to 2014 has 151 columns, while rest of them have 143 each. When I use rbind.fill to convert all data into one,the columns are 154 in total.</p>
<p>Before combining them into one big data set, I add a “year” variable with 2012-2013 as the base 0, next year will be added 1 incrementally.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat1<span class="op">$</span>year &lt;-<span class="st"> </span><span class="dv">0</span>
dat2<span class="op">$</span>year &lt;-<span class="st"> </span><span class="dv">1</span>
dat3<span class="op">$</span>year &lt;-<span class="st"> </span><span class="dv">2</span>
dat.train&lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">&quot;rbind.fill&quot;</span>, <span class="kw">list</span>(dat1,dat2,dat3))
dat.test &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">&quot;rbind.fill&quot;</span>, <span class="kw">list</span>(dat4,dat5,dat6,dat7))
dat.test<span class="op">$</span>year &lt;-<span class="dv">3</span>
dat &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">&quot;rbind.fill&quot;</span>, <span class="kw">list</span>(dat.train,dat.test))</code></pre></div>
<p>Before going into checking each variable, I partitioned that data into 2 sets, one is completed loans, and the other one contains those that are still on going. A model can be build on the first data set to predict whether the loan will be charged off or fully paid. A second model is based exsting loan data, in order to predict whether the loan is going to be bad in the future.</p>
<p>The dependant variable used in both data set is <strong>loan_status</strong>. Records with next payment date as <strong>NA</strong>, are closed loan, otherwise they are still open. I will focus on closed loan in this project first.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span><span class="kw">filter</span>(dat, <span class="kw">is.na</span>(next_pymnt_d))</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dim</span>(dat)</code></pre></div>
<pre><code>## [1] 677564    154</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">unique</span>(dat<span class="op">$</span>loan_status)</code></pre></div>
<pre><code>## [1] &quot;Fully Paid&quot;  &quot;Charged Off&quot;</code></pre>
<p>There are only 2 levels in loan_status, fully paid or charged off, where charged off is the status that lenders want to avoid most. Therefore, a new dependet variable y is denoted as 1 when the loan is decharged fault, 0 otherwise.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dt &lt;-<span class="st"> </span><span class="kw">data.table</span>(dat)[,{temp =<span class="st"> </span><span class="kw">as.character</span>(loan_status); y =<span class="st"> </span><span class="kw">ifelse</span>(temp <span class="op">==</span><span class="st"> &quot;Charged Off&quot;</span>,<span class="dv">1</span>,<span class="dv">0</span>);<span class="kw">list</span>(<span class="dt">y=</span>y)}]
<span class="kw">sum</span>(dt<span class="op">$</span>y)</code></pre></div>
<pre><code>## [1] 141751</code></pre>
<p>In the data set, with 677564 records, there are 141751 bad loan, which is around 20.92%. We can set the new dependant variable to the data set. After building the prediction model, we hope can improve the payoff rates in the evaluation process.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat<span class="op">$</span>y &lt;-<span class="st"> </span>dt<span class="op">$</span>y</code></pre></div>
<p>Now we calculate the missing rate for each column</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> dat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sapply</span>(., <span class="cf">function</span>(x)<span class="kw">sum</span>(<span class="kw">is.na</span>(x))<span class="op">/</span><span class="kw">length</span>(x)) <span class="op">%&gt;%</span>
<span class="st">         </span><span class="kw">kable</span>(<span class="st">&quot;html&quot;</span>,<span class="dt">col.names =</span> <span class="st">&quot;Missing.Rate&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">         </span><span class="kw">kable_styling</span>(<span class="dt">bootstrap_options =</span> <span class="kw">c</span>(<span class="st">&quot;striped&quot;</span>, <span class="st">&quot;hover&quot;</span>))</code></pre></div>
<table class="table table-striped table-hover" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
Missing.Rate
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
id
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
member_id
</td>
<td style="text-align:right;">
1.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
loan_amnt
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
funded_amnt
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
funded_amnt_inv
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
term
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
int_rate
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
installment
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
grade
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
sub_grade
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
emp_title
</td>
<td style="text-align:right;">
0.0586867
</td>
</tr>
<tr>
<td style="text-align:left;">
emp_length
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
home_ownership
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
annual_inc
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
verification_status
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
issue_d
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
loan_status
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
pymnt_plan
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
url
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
desc
</td>
<td style="text-align:right;">
0.8636350
</td>
</tr>
<tr>
<td style="text-align:left;">
purpose
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
title
</td>
<td style="text-align:right;">
0.0092655
</td>
</tr>
<tr>
<td style="text-align:left;">
zip_code
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
addr_state
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
dti
</td>
<td style="text-align:right;">
0.0000177
</td>
</tr>
<tr>
<td style="text-align:left;">
delinq_2yrs
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
earliest_cr_line
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
fico_range_low
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
fico_range_high
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
inq_last_6mths
</td>
<td style="text-align:right;">
0.0000015
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_last_delinq
</td>
<td style="text-align:right;">
0.5085306
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_last_record
</td>
<td style="text-align:right;">
0.8350562
</td>
</tr>
<tr>
<td style="text-align:left;">
open_acc
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
pub_rec
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
revol_bal
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
revol_util
</td>
<td style="text-align:right;">
0.0005638
</td>
</tr>
<tr>
<td style="text-align:left;">
total_acc
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
initial_list_status
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
out_prncp
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
out_prncp_inv
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
total_pymnt
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
total_pymnt_inv
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
total_rec_prncp
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
total_rec_int
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
total_rec_late_fee
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
recoveries
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
collection_recovery_fee
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
last_pymnt_d
</td>
<td style="text-align:right;">
0.0016294
</td>
</tr>
<tr>
<td style="text-align:left;">
last_pymnt_amnt
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
next_pymnt_d
</td>
<td style="text-align:right;">
1.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
last_credit_pull_d
</td>
<td style="text-align:right;">
0.0000517
</td>
</tr>
<tr>
<td style="text-align:left;">
last_fico_range_high
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
last_fico_range_low
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
collections_12_mths_ex_med
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_last_major_derog
</td>
<td style="text-align:right;">
0.7385251
</td>
</tr>
<tr>
<td style="text-align:left;">
policy_code
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
application_type
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
annual_inc_joint
</td>
<td style="text-align:right;">
0.9972932
</td>
</tr>
<tr>
<td style="text-align:left;">
dti_joint
</td>
<td style="text-align:right;">
0.9972932
</td>
</tr>
<tr>
<td style="text-align:left;">
verification_status_joint
</td>
<td style="text-align:right;">
0.9972932
</td>
</tr>
<tr>
<td style="text-align:left;">
acc_now_delinq
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
tot_coll_amt
</td>
<td style="text-align:right;">
0.0409408
</td>
</tr>
<tr>
<td style="text-align:left;">
tot_cur_bal
</td>
<td style="text-align:right;">
0.0409408
</td>
</tr>
<tr>
<td style="text-align:left;">
open_acc_6m
</td>
<td style="text-align:right;">
0.8297165
</td>
</tr>
<tr>
<td style="text-align:left;">
open_act_il
</td>
<td style="text-align:right;">
1.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
open_il_12m
</td>
<td style="text-align:right;">
0.8297150
</td>
</tr>
<tr>
<td style="text-align:left;">
open_il_24m
</td>
<td style="text-align:right;">
0.8297150
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_rcnt_il
</td>
<td style="text-align:right;">
0.8334239
</td>
</tr>
<tr>
<td style="text-align:left;">
total_bal_il
</td>
<td style="text-align:right;">
0.8297150
</td>
</tr>
<tr>
<td style="text-align:left;">
il_util
</td>
<td style="text-align:right;">
0.8507506
</td>
</tr>
<tr>
<td style="text-align:left;">
open_rv_12m
</td>
<td style="text-align:right;">
0.8297150
</td>
</tr>
<tr>
<td style="text-align:left;">
open_rv_24m
</td>
<td style="text-align:right;">
0.8297150
</td>
</tr>
<tr>
<td style="text-align:left;">
max_bal_bc
</td>
<td style="text-align:right;">
0.8297150
</td>
</tr>
<tr>
<td style="text-align:left;">
all_util
</td>
<td style="text-align:right;">
0.8297253
</td>
</tr>
<tr>
<td style="text-align:left;">
total_rev_hi_lim
</td>
<td style="text-align:right;">
0.0409408
</td>
</tr>
<tr>
<td style="text-align:left;">
inq_fi
</td>
<td style="text-align:right;">
0.8297150
</td>
</tr>
<tr>
<td style="text-align:left;">
total_cu_tl
</td>
<td style="text-align:right;">
0.8297165
</td>
</tr>
<tr>
<td style="text-align:left;">
inq_last_12m
</td>
<td style="text-align:right;">
0.8297165
</td>
</tr>
<tr>
<td style="text-align:left;">
acc_open_past_24mths
</td>
<td style="text-align:right;">
0.0110617
</td>
</tr>
<tr>
<td style="text-align:left;">
avg_cur_bal
</td>
<td style="text-align:right;">
0.0409585
</td>
</tr>
<tr>
<td style="text-align:left;">
bc_open_to_buy
</td>
<td style="text-align:right;">
0.0211065
</td>
</tr>
<tr>
<td style="text-align:left;">
bc_util
</td>
<td style="text-align:right;">
0.0217308
</td>
</tr>
<tr>
<td style="text-align:left;">
chargeoff_within_12_mths
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
delinq_amnt
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
mo_sin_old_il_acct
</td>
<td style="text-align:right;">
0.0695152
</td>
</tr>
<tr>
<td style="text-align:left;">
mo_sin_old_rev_tl_op
</td>
<td style="text-align:right;">
0.0409423
</td>
</tr>
<tr>
<td style="text-align:left;">
mo_sin_rcnt_rev_tl_op
</td>
<td style="text-align:right;">
0.0409423
</td>
</tr>
<tr>
<td style="text-align:left;">
mo_sin_rcnt_tl
</td>
<td style="text-align:right;">
0.0409408
</td>
</tr>
<tr>
<td style="text-align:left;">
mort_acc
</td>
<td style="text-align:right;">
0.0110617
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_recent_bc
</td>
<td style="text-align:right;">
0.0203184
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_recent_bc_dlq
</td>
<td style="text-align:right;">
0.7568053
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_recent_inq
</td>
<td style="text-align:right;">
0.1017985
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_recent_revol_delinq
</td>
<td style="text-align:right;">
0.6593340
</td>
</tr>
<tr>
<td style="text-align:left;">
num_accts_ever_120_pd
</td>
<td style="text-align:right;">
0.0409408
</td>
</tr>
<tr>
<td style="text-align:left;">
num_actv_bc_tl
</td>
<td style="text-align:right;">
0.0409408
</td>
</tr>
<tr>
<td style="text-align:left;">
num_actv_rev_tl
</td>
<td style="text-align:right;">
0.0409408
</td>
</tr>
<tr>
<td style="text-align:left;">
num_bc_sats
</td>
<td style="text-align:right;">
0.0236952
</td>
</tr>
<tr>
<td style="text-align:left;">
num_bc_tl
</td>
<td style="text-align:right;">
0.0409408
</td>
</tr>
<tr>
<td style="text-align:left;">
num_il_tl
</td>
<td style="text-align:right;">
0.0409408
</td>
</tr>
<tr>
<td style="text-align:left;">
num_op_rev_tl
</td>
<td style="text-align:right;">
0.0409408
</td>
</tr>
<tr>
<td style="text-align:left;">
num_rev_accts
</td>
<td style="text-align:right;">
0.0409423
</td>
</tr>
<tr>
<td style="text-align:left;">
num_rev_tl_bal_gt_0
</td>
<td style="text-align:right;">
0.0409408
</td>
</tr>
<tr>
<td style="text-align:left;">
num_sats
</td>
<td style="text-align:right;">
0.0236952
</td>
</tr>
<tr>
<td style="text-align:left;">
num_tl_120dpd_2m
</td>
<td style="text-align:right;">
0.0727149
</td>
</tr>
<tr>
<td style="text-align:left;">
num_tl_30dpd
</td>
<td style="text-align:right;">
0.0409408
</td>
</tr>
<tr>
<td style="text-align:left;">
num_tl_90g_dpd_24m
</td>
<td style="text-align:right;">
0.0409408
</td>
</tr>
<tr>
<td style="text-align:left;">
num_tl_op_past_12m
</td>
<td style="text-align:right;">
0.0409408
</td>
</tr>
<tr>
<td style="text-align:left;">
pct_tl_nvr_dlq
</td>
<td style="text-align:right;">
0.0411400
</td>
</tr>
<tr>
<td style="text-align:left;">
percent_bc_gt_75
</td>
<td style="text-align:right;">
0.0214814
</td>
</tr>
<tr>
<td style="text-align:left;">
pub_rec_bankruptcies
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
tax_liens
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
tot_hi_cred_lim
</td>
<td style="text-align:right;">
0.0409408
</td>
</tr>
<tr>
<td style="text-align:left;">
total_bal_ex_mort
</td>
<td style="text-align:right;">
0.0110617
</td>
</tr>
<tr>
<td style="text-align:left;">
total_bc_limit
</td>
<td style="text-align:right;">
0.0110617
</td>
</tr>
<tr>
<td style="text-align:left;">
total_il_high_credit_limit
</td>
<td style="text-align:right;">
0.0409408
</td>
</tr>
<tr>
<td style="text-align:left;">
revol_bal_joint
</td>
<td style="text-align:right;">
1.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
sec_app_fico_range_low
</td>
<td style="text-align:right;">
1.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
sec_app_fico_range_high
</td>
<td style="text-align:right;">
1.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
sec_app_earliest_cr_line
</td>
<td style="text-align:right;">
1.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
sec_app_inq_last_6mths
</td>
<td style="text-align:right;">
1.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
sec_app_mort_acc
</td>
<td style="text-align:right;">
1.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
sec_app_open_acc
</td>
<td style="text-align:right;">
1.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
sec_app_revol_util
</td>
<td style="text-align:right;">
1.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
sec_app_open_act_il
</td>
<td style="text-align:right;">
1.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
sec_app_num_rev_accts
</td>
<td style="text-align:right;">
1.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
sec_app_chargeoff_within_12_mths
</td>
<td style="text-align:right;">
1.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
sec_app_collections_12_mths_ex_med
</td>
<td style="text-align:right;">
1.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
sec_app_mths_since_last_major_derog
</td>
<td style="text-align:right;">
1.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
hardship_flag
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
hardship_type
</td>
<td style="text-align:right;">
0.9997299
</td>
</tr>
<tr>
<td style="text-align:left;">
hardship_reason
</td>
<td style="text-align:right;">
0.9997299
</td>
</tr>
<tr>
<td style="text-align:left;">
hardship_status
</td>
<td style="text-align:right;">
0.9997299
</td>
</tr>
<tr>
<td style="text-align:left;">
deferral_term
</td>
<td style="text-align:right;">
0.9997299
</td>
</tr>
<tr>
<td style="text-align:left;">
hardship_amount
</td>
<td style="text-align:right;">
0.9997299
</td>
</tr>
<tr>
<td style="text-align:left;">
hardship_start_date
</td>
<td style="text-align:right;">
0.9997299
</td>
</tr>
<tr>
<td style="text-align:left;">
hardship_end_date
</td>
<td style="text-align:right;">
0.9997299
</td>
</tr>
<tr>
<td style="text-align:left;">
payment_plan_start_date
</td>
<td style="text-align:right;">
0.9997299
</td>
</tr>
<tr>
<td style="text-align:left;">
hardship_length
</td>
<td style="text-align:right;">
0.9997299
</td>
</tr>
<tr>
<td style="text-align:left;">
hardship_dpd
</td>
<td style="text-align:right;">
0.9997299
</td>
</tr>
<tr>
<td style="text-align:left;">
hardship_loan_status
</td>
<td style="text-align:right;">
0.9997299
</td>
</tr>
<tr>
<td style="text-align:left;">
orig_projected_additional_accrued_interest
</td>
<td style="text-align:right;">
0.9999734
</td>
</tr>
<tr>
<td style="text-align:left;">
hardship_payoff_balance_amount
</td>
<td style="text-align:right;">
0.9997299
</td>
</tr>
<tr>
<td style="text-align:left;">
hardship_last_payment_amount
</td>
<td style="text-align:right;">
0.9997299
</td>
</tr>
<tr>
<td style="text-align:left;">
disbursement_method
</td>
<td style="text-align:right;">
0.4452067
</td>
</tr>
<tr>
<td style="text-align:left;">
debt_settlement_flag
</td>
<td style="text-align:right;">
0.4452067
</td>
</tr>
<tr>
<td style="text-align:left;">
debt_settlement_flag_date
</td>
<td style="text-align:right;">
0.9885679
</td>
</tr>
<tr>
<td style="text-align:left;">
settlement_status
</td>
<td style="text-align:right;">
0.9935549
</td>
</tr>
<tr>
<td style="text-align:left;">
settlement_date
</td>
<td style="text-align:right;">
0.9935563
</td>
</tr>
<tr>
<td style="text-align:left;">
settlement_amount
</td>
<td style="text-align:right;">
0.9935549
</td>
</tr>
<tr>
<td style="text-align:left;">
settlement_percentage
</td>
<td style="text-align:right;">
0.9935549
</td>
</tr>
<tr>
<td style="text-align:left;">
settlement_term
</td>
<td style="text-align:right;">
0.9935549
</td>
</tr>
<tr>
<td style="text-align:left;">
year
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
open_il_6m
</td>
<td style="text-align:right;">
0.8297150
</td>
</tr>
<tr>
<td style="text-align:left;">
sec_app_open_il_6m
</td>
<td style="text-align:right;">
1.0000000
</td>
</tr>
<tr>
<td style="text-align:left;">
y
</td>
<td style="text-align:right;">
0.0000000
</td>
</tr>
</tbody>
</table>
<p>There are some columns with missing rate over 90%. Let’s take a further look at them before deleting.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">high.missing.col&lt;-<span class="st"> </span><span class="kw">names</span>(dat[,<span class="kw">which</span>(<span class="kw">colMeans</span>(<span class="kw">is.na</span>(dat)) <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.9</span>)])
<span class="co">#Some interesting fields</span>
<span class="co">#  [1]&quot;desc&quot;  </span>
####null as level 0, otherwise 1                                      
<span class="co">#  [2] &quot;annual_inc_joint&quot;                          </span>
<span class="co">#  [3] &quot;dti_joint&quot;                                  </span>
<span class="co">#  [4] &quot;verification_status_joint&quot;                 </span>
####[2] to [4] is joint related, one nomial var with 2 levels 
<span class="co">#  [5] &quot;hardship_type&quot;                             </span>
<span class="co">#  [6] &quot;hardship_reason&quot;                           </span>
<span class="co">#  [7] &quot;hardship_status&quot;                           </span>
<span class="co">#  [8] &quot;deferral_term&quot; drop                            </span>
<span class="co">#  [9] &quot;hardship_amount&quot;                           </span>
<span class="co"># [10] &quot;hardship_start_date&quot;                       </span>
<span class="co"># [11] &quot;hardship_end_date&quot;                         </span>
<span class="co"># [12] &quot;payment_plan_start_date&quot;  ##drop                 </span>
<span class="co"># [13] &quot;hardship_length&quot;                           </span>
<span class="co"># [14] &quot;hardship_dpd&quot;                              </span>
<span class="co"># [15] &quot;hardship_loan_status&quot;                      </span>
<span class="co"># [16] &quot;orig_projected_additional_accrued_interest&quot;</span>
<span class="co"># [17] &quot;hardship_payoff_balance_amount&quot;            </span>
<span class="co"># [18] &quot;hardship_last_payment_amount&quot;</span>
<span class="co">#Hardship related combined into 1 nomial var with 2 levels</span>
dat &lt;-<span class="st"> </span><span class="kw">data.table</span>(dat)[,desc_flag <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(desc),<span class="dv">0</span>,<span class="dv">1</span>)][,
        hardship_flag <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(hardship_type),<span class="dv">0</span>,<span class="dv">1</span>)][,
               joint_flag <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(dti_joint),<span class="dv">0</span>,<span class="dv">1</span>)][,
                        high.missing.col[<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(high.missing.col)]<span class="op">:</span><span class="er">=</span><span class="ot">NULL</span>][,desc <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
<span class="kw">dim</span>(dat)[<span class="dv">2</span>]</code></pre></div>
<pre><code>## [1] 116</code></pre>
<p>The column number was reduced to 116. Furthermore, column <strong>url</strong> is not a modeling feature,which is a web link for each record and can be dropped as well.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span><span class="kw">data.table</span>(dat)[, url<span class="op">:</span><span class="er">=</span><span class="ot">NULL</span>]</code></pre></div>
</div>
<div id="exploratory-data-analysis-and-feature-engineering" class="section level2">
<h2><span class="header-section-number">2.2</span> Exploratory Data Analysis and Feature Engineering</h2>
<p>Lets examineing each variable and catorgorize them into the Profile Features, Loan Features, Payment Features, and Miscellaneous Features. In the first model, all features related to payment shouldnt be consider.To loan or not to loan is based on the borrowers profile and loan features, which are our interest.</p>
<table class="table table-striped table-hover" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
Profile.Features
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
emp_title
</td>
</tr>
<tr>
<td style="text-align:left;">
emp_length
</td>
</tr>
<tr>
<td style="text-align:left;">
home_ownership
</td>
</tr>
<tr>
<td style="text-align:left;">
annual_inc
</td>
</tr>
<tr>
<td style="text-align:left;">
verification_status
</td>
</tr>
<tr>
<td style="text-align:left;">
zip_code
</td>
</tr>
<tr>
<td style="text-align:left;">
addr_state
</td>
</tr>
<tr>
<td style="text-align:left;">
dti
</td>
</tr>
<tr>
<td style="text-align:left;">
delinq_2yrs
</td>
</tr>
<tr>
<td style="text-align:left;">
earliest_cr_line
</td>
</tr>
<tr>
<td style="text-align:left;">
fico_range_low
</td>
</tr>
<tr>
<td style="text-align:left;">
fico_range_high
</td>
</tr>
<tr>
<td style="text-align:left;">
inq_last_6mths
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_last_delinq
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_last_record
</td>
</tr>
<tr>
<td style="text-align:left;">
open_acc
</td>
</tr>
<tr>
<td style="text-align:left;">
pub_rec
</td>
</tr>
<tr>
<td style="text-align:left;">
revol_bal
</td>
</tr>
<tr>
<td style="text-align:left;">
revol_util
</td>
</tr>
<tr>
<td style="text-align:left;">
total_acc
</td>
</tr>
<tr>
<td style="text-align:left;">
last_fico_range_high
</td>
</tr>
<tr>
<td style="text-align:left;">
last_fico_range_low
</td>
</tr>
<tr>
<td style="text-align:left;">
collections_12_mths_ex_med
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_last_major_derog
</td>
</tr>
<tr>
<td style="text-align:left;">
acc_now_delinq
</td>
</tr>
<tr>
<td style="text-align:left;">
tot_coll_amt
</td>
</tr>
<tr>
<td style="text-align:left;">
tot_cur_bal
</td>
</tr>
<tr>
<td style="text-align:left;">
open_acc_6m
</td>
</tr>
<tr>
<td style="text-align:left;">
open_il_12m
</td>
</tr>
<tr>
<td style="text-align:left;">
open_il_24m
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_rcnt_il
</td>
</tr>
<tr>
<td style="text-align:left;">
total_bal_il
</td>
</tr>
<tr>
<td style="text-align:left;">
il_util
</td>
</tr>
<tr>
<td style="text-align:left;">
open_rv_12m
</td>
</tr>
<tr>
<td style="text-align:left;">
open_rv_24m
</td>
</tr>
<tr>
<td style="text-align:left;">
max_bal_bc
</td>
</tr>
<tr>
<td style="text-align:left;">
all_util
</td>
</tr>
<tr>
<td style="text-align:left;">
total_rev_hi_lim
</td>
</tr>
<tr>
<td style="text-align:left;">
inq_fi
</td>
</tr>
<tr>
<td style="text-align:left;">
total_cu_tl
</td>
</tr>
<tr>
<td style="text-align:left;">
inq_last_12m
</td>
</tr>
<tr>
<td style="text-align:left;">
acc_open_past_24mths
</td>
</tr>
<tr>
<td style="text-align:left;">
avg_cur_bal
</td>
</tr>
<tr>
<td style="text-align:left;">
bc_open_to_buy
</td>
</tr>
<tr>
<td style="text-align:left;">
bc_util
</td>
</tr>
<tr>
<td style="text-align:left;">
chargeoff_within_12_mths
</td>
</tr>
<tr>
<td style="text-align:left;">
delinq_amnt
</td>
</tr>
<tr>
<td style="text-align:left;">
mo_sin_old_rev_tl_op
</td>
</tr>
<tr>
<td style="text-align:left;">
mo_sin_rcnt_rev_tl_op
</td>
</tr>
<tr>
<td style="text-align:left;">
mo_sin_rcnt_tl
</td>
</tr>
<tr>
<td style="text-align:left;">
mort_acc
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_recent_bc
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_recent_bc_dlq
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_recent_inq
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_recent_revol_delinq
</td>
</tr>
<tr>
<td style="text-align:left;">
num_accts_ever_120_pd
</td>
</tr>
<tr>
<td style="text-align:left;">
num_actv_bc_tl
</td>
</tr>
<tr>
<td style="text-align:left;">
num_actv_rev_tl
</td>
</tr>
<tr>
<td style="text-align:left;">
num_bc_sats
</td>
</tr>
<tr>
<td style="text-align:left;">
num_bc_tl
</td>
</tr>
<tr>
<td style="text-align:left;">
num_il_tl
</td>
</tr>
<tr>
<td style="text-align:left;">
num_op_rev_tl
</td>
</tr>
<tr>
<td style="text-align:left;">
num_rev_accts
</td>
</tr>
<tr>
<td style="text-align:left;">
num_rev_tl_bal_gt_0
</td>
</tr>
<tr>
<td style="text-align:left;">
num_sats
</td>
</tr>
<tr>
<td style="text-align:left;">
num_tl_120dpd_2m
</td>
</tr>
<tr>
<td style="text-align:left;">
num_tl_30dpd
</td>
</tr>
<tr>
<td style="text-align:left;">
num_tl_90g_dpd_24m
</td>
</tr>
<tr>
<td style="text-align:left;">
num_tl_op_past_12m
</td>
</tr>
<tr>
<td style="text-align:left;">
pct_tl_nvr_dlq
</td>
</tr>
<tr>
<td style="text-align:left;">
percent_bc_gt_75
</td>
</tr>
<tr>
<td style="text-align:left;">
pub_rec_bankruptcies
</td>
</tr>
<tr>
<td style="text-align:left;">
tax_liens
</td>
</tr>
<tr>
<td style="text-align:left;">
tot_hi_cred_lim
</td>
</tr>
<tr>
<td style="text-align:left;">
total_bal_ex_mort
</td>
</tr>
<tr>
<td style="text-align:left;">
total_bc_limit
</td>
</tr>
<tr>
<td style="text-align:left;">
total_il_high_credit_limit
</td>
</tr>
<tr>
<td style="text-align:left;">
open_il_6m
</td>
</tr>
<tr>
<td style="text-align:left;">
joint_flag
</td>
</tr>
<tr>
<td style="text-align:left;">
mo_sin_old_il_acct
</td>
</tr>
</tbody>
</table>
<table class="table table-striped table-hover" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
Payment.Features
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
out_prncp
</td>
</tr>
<tr>
<td style="text-align:left;">
out_prncp_inv
</td>
</tr>
<tr>
<td style="text-align:left;">
total_pymnt
</td>
</tr>
<tr>
<td style="text-align:left;">
total_pymnt_inv
</td>
</tr>
<tr>
<td style="text-align:left;">
total_rec_prncp
</td>
</tr>
<tr>
<td style="text-align:left;">
total_rec_int
</td>
</tr>
<tr>
<td style="text-align:left;">
total_rec_late_fee
</td>
</tr>
<tr>
<td style="text-align:left;">
last_pymnt_d
</td>
</tr>
<tr>
<td style="text-align:left;">
last_pymnt_amnt
</td>
</tr>
<tr>
<td style="text-align:left;">
next_pymnt_d
</td>
</tr>
</tbody>
</table>
<table class="table table-striped table-hover" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
Miscellaneous.Features
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
recoveries
</td>
</tr>
<tr>
<td style="text-align:left;">
collection_recovery_fee
</td>
</tr>
<tr>
<td style="text-align:left;">
hardship_flag
</td>
</tr>
<tr>
<td style="text-align:left;">
debt_settlement_flag
</td>
</tr>
<tr>
<td style="text-align:left;">
disbursement_method
</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">##Drop payment and miscellaneous features from the data set.
dat &lt;-<span class="st"> </span><span class="kw">data.table</span>(dat)[,Payment.Features[<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(Payment.Features)]<span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>][,
Miscellaneous.Features[<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(Miscellaneous.Features)]<span class="op">:</span><span class="er">=</span><span class="ot">NULL</span>]
<span class="co">#Check whether all are included</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">length</span>(<span class="kw">names</span>(dat))<span class="op">-</span><span class="dv">2</span><span class="op">==</span><span class="st"> </span><span class="kw">length</span>(<span class="kw">c</span>(Profile.Features,Loan.Features)) <span class="co">#y and loan_status</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="examine-each-of-the-features" class="section level2">
<h2><span class="header-section-number">2.3</span> Examine each of the features</h2>
<p>When reading the data using data.table, every column is in charactor type. There are 2 columns with only constant term. Remove them before checking.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">temp &lt;-<span class="st"> </span><span class="kw">sapply</span>(dat, <span class="cf">function</span>(x)(<span class="kw">length</span>(<span class="kw">unique</span>(x))))
temp[temp<span class="op">==</span><span class="dv">1</span>]</code></pre></div>
<pre><code>##  pymnt_plan policy_code 
##           1           1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span><span class="kw">data.table</span>(dat)[,<span class="kw">c</span>(<span class="st">&quot;pymnt_plan&quot;</span>,<span class="st">&quot;policy_code&quot;</span>)<span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]</code></pre></div>
<p>Set them into proper data type, such as numeric, factor,or date time.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(dat,<span class="dt">n=</span><span class="dv">3</span>)</code></pre></div>
<pre><code>##          id loan_amnt funded_amnt funded_amnt_inv       term int_rate
## 1: 10159611     10000       10000           10000  36 months    9.67%
## 2: 10129506     20800       20800           20800  36 months   13.53%
## 3: 10129403      7550        7550            7550  36 months   16.24%
##    installment grade sub_grade                       emp_title emp_length
## 1:      321.13     B        B1                Registered Nurse    7 years
## 2:      706.16     B        B5              Operations Manager  10+ years
## 3:      266.34     C        C5 Special Order Fulfillment Clerk    3 years
##    home_ownership annual_inc verification_status  issue_d loan_status
## 1:       MORTGAGE     102000        Not Verified Dec-2013  Fully Paid
## 2:           RENT      81500            Verified Dec-2013  Fully Paid
## 3:           RENT      28000        Not Verified Dec-2013  Fully Paid
##               purpose                          title zip_code addr_state
## 1: debt_consolidation                       Clean Up    027xx         MA
## 2: debt_consolidation Reducing Debt to Purchase Home    100xx         NY
## 3: debt_consolidation             Debt consolidation    951xx         CA
##      dti delinq_2yrs earliest_cr_line fico_range_low fico_range_high
## 1: 15.55           2         Oct-1989            670             674
## 2: 16.73           0         Jun-1998            685             689
## 3:   8.4           0         Oct-2010            660             664
##    inq_last_6mths mths_since_last_delinq mths_since_last_record open_acc
## 1:              0                     11                     NA        9
## 2:              2                     64                     NA       29
## 3:              0                     NA                     NA        4
##    pub_rec revol_bal revol_util total_acc initial_list_status
## 1:       0      9912      44.4%        22                   f
## 2:       0     23473      54.5%        41                   f
## 3:       0      5759        72%         5                   w
##    last_credit_pull_d last_fico_range_high last_fico_range_low
## 1:           Dec-2016                  629                 625
## 2:           Oct-2017                  629                 625
## 3:           Oct-2017                  599                 595
##    collections_12_mths_ex_med mths_since_last_major_derog application_type
## 1:                          0                          54       Individual
## 2:                          0                          71       Individual
## 3:                          0                          NA       Individual
##    acc_now_delinq tot_coll_amt tot_cur_bal open_acc_6m open_il_12m
## 1:              0            0       39143          NA          NA
## 2:              0            0       23473          NA          NA
## 3:              0            0        5759          NA          NA
##    open_il_24m mths_since_rcnt_il total_bal_il il_util open_rv_12m
## 1:          NA                 NA           NA      NA          NA
## 2:          NA                 NA           NA      NA          NA
## 3:          NA                 NA           NA      NA          NA
##    open_rv_24m max_bal_bc all_util total_rev_hi_lim inq_fi total_cu_tl
## 1:          NA         NA       NA            22300     NA          NA
## 2:          NA         NA       NA            43100     NA          NA
## 3:          NA         NA       NA             8000     NA          NA
##    inq_last_12m acc_open_past_24mths avg_cur_bal bc_open_to_buy bc_util
## 1:           NA                    3        4349            973    89.4
## 2:           NA                    9         869           6811    54.6
## 3:           NA                    1        1440            160      96
##    chargeoff_within_12_mths delinq_amnt mo_sin_old_il_acct
## 1:                        0           0                243
## 2:                        0           0                115
## 3:                        0           0                 NA
##    mo_sin_old_rev_tl_op mo_sin_rcnt_rev_tl_op mo_sin_rcnt_tl mort_acc
## 1:                  290                    23              8        0
## 2:                  186                     0              0        0
## 3:                   38                    17             17        0
##    mths_since_recent_bc mths_since_recent_bc_dlq mths_since_recent_inq
## 1:                   25                       11                     8
## 2:                    0                       70                     0
## 3:                   17                       NA                    17
##    mths_since_recent_revol_delinq num_accts_ever_120_pd num_actv_bc_tl
## 1:                             11                     1              3
## 2:                             70                     1              8
## 3:                             NA                     0              2
##    num_actv_rev_tl num_bc_sats num_bc_tl num_il_tl num_op_rev_tl
## 1:               4           3         6         9             6
## 2:              24          11        17         1            29
## 3:               4           2         2         0             4
##    num_rev_accts num_rev_tl_bal_gt_0 num_sats num_tl_120dpd_2m
## 1:            13                   4        9                0
## 2:            40                  24       29                0
## 3:             5                   4        4                0
##    num_tl_30dpd num_tl_90g_dpd_24m num_tl_op_past_12m pct_tl_nvr_dlq
## 1:            0                  0                  1           77.3
## 2:            0                  0                  3           90.2
## 3:            0                  0                  0            100
##    percent_bc_gt_75 pub_rec_bankruptcies tax_liens tot_hi_cred_lim
## 1:             66.7                    0         0           58486
## 2:               50                    0         0           43100
## 3:              100                    0         0            8000
##    total_bal_ex_mort total_bc_limit total_il_high_credit_limit year
## 1:             39143           9200                      36186    0
## 2:             23473          15000                          0    0
## 3:              5759           4000                          0    0
##    open_il_6m y desc_flag joint_flag
## 1:         NA 0         0          0
## 2:         NA 0         1          0
## 3:         NA 0         0          0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d.time &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;issue_d&quot;</span>,<span class="st">&quot;earliest_cr_line&quot;</span>,<span class="st">&quot;last_credit_pull_d&quot;</span>)
dat &lt;-<span class="st"> </span>dat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_all</span>(as.character)<span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">mutate_at</span>(<span class="st">&quot;term&quot;</span>,<span class="kw">funs</span>(<span class="kw">gsub</span>(<span class="st">&quot;months&quot;</span>,<span class="st">&quot;&quot;</span>,.))) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(int_rate,revol_util),<span class="kw">funs</span>(<span class="kw">gsub</span>(<span class="st">&quot;%&quot;</span>,<span class="st">&quot;&quot;</span>,.))) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">mutate_at</span>(<span class="st">&quot;emp_length&quot;</span>,<span class="kw">funs</span>(<span class="kw">gsub</span>(<span class="st">&quot;[^0-9]&quot;</span>,<span class="st">&quot;&quot;</span>,.)))</code></pre></div>
<p>re-read the file from rea.csv as data.frame will automatically make numbers to numeric type.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">write.csv</span>(dat,<span class="dt">file=</span><span class="st">&quot;dat_1.csv&quot;</span>,<span class="dt">row.names =</span> <span class="ot">FALSE</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat&lt;-<span class="kw">read.csv</span>(<span class="st">&quot;dat_1.csv&quot;</span>)
<span class="kw">str</span>(dat)</code></pre></div>
<pre><code>## &#39;data.frame&#39;:    677564 obs. of  99 variables:
##  $ id                            : int  10159611 10129506 10129403 10149577 10119623 10149526 10224583 10139658 10159584 10179520 ...
##  $ loan_amnt                     : int  10000 20800 7550 28000 12000 27600 11100 12000 9750 3000 ...
##  $ funded_amnt                   : int  10000 20800 7550 28000 12000 27600 11100 12000 9750 3000 ...
##  $ funded_amnt_inv               : num  10000 20800 7550 28000 12000 27600 11100 12000 9750 3000 ...
##  $ term                          : num  36 36 36 36 36 60 36 36 36 36 ...
##  $ int_rate                      : num  9.67 13.53 16.24 7.62 11.99 ...
##  $ installment                   : num  321 706 266 873 399 ...
##  $ grade                         : Factor w/ 7 levels &quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;,..: 2 2 3 1 2 4 3 2 3 2 ...
##  $ sub_grade                     : Factor w/ 35 levels &quot;A1&quot;,&quot;A2&quot;,&quot;A3&quot;,..: 6 10 15 3 8 20 13 10 11 9 ...
##  $ emp_title                     : Factor w/ 238465 levels &quot;-Winston County Board of Education&quot;,..: 172393 147431 197270 12495 122317 206726 212612 146588 131460 18594 ...
##  $ emp_length                    : int  7 10 3 5 10 6 10 10 1 10 ...
##  $ home_ownership                : Factor w/ 6 levels &quot;ANY&quot;,&quot;MORTGAGE&quot;,..: 2 6 6 2 2 2 2 6 6 6 ...
##  $ annual_inc                    : num  102000 81500 28000 325000 130000 73000 90000 40000 26000 25000 ...
##  $ verification_status           : Factor w/ 3 levels &quot;Not Verified&quot;,..: 1 3 1 2 2 2 1 2 1 3 ...
##  $ issue_d                       : Factor w/ 60 levels &quot;Apr-2012&quot;,&quot;Apr-2013&quot;,..: 12 12 12 12 12 12 12 12 12 12 ...
##  $ loan_status                   : Factor w/ 2 levels &quot;Charged Off&quot;,..: 2 2 2 2 2 1 2 2 2 2 ...
##  $ purpose                       : Factor w/ 14 levels &quot;car&quot;,&quot;credit_card&quot;,..: 3 3 3 3 3 3 10 3 3 3 ...
##  $ title                         : Factor w/ 44347 levels &quot;&#39;Cut the Cards&#39;&quot;,..: 6692 37722 13803 34364 13803 9047 32451 13803 13494 13012 ...
##  $ zip_code                      : Factor w/ 918 levels &quot;007xx&quot;,&quot;008xx&quot;,..: 20 91 873 867 751 744 94 802 849 308 ...
##  $ addr_state                    : Factor w/ 51 levels &quot;AK&quot;,&quot;AL&quot;,&quot;AR&quot;,..: 20 35 5 5 6 6 35 33 5 10 ...
##  $ dti                           : num  15.6 16.7 8.4 18.6 13 ...
##  $ delinq_2yrs                   : int  2 0 0 0 0 1 1 0 0 0 ...
##  $ earliest_cr_line              : Factor w/ 700 levels &quot;Apr-1955&quot;,&quot;Apr-1958&quot;,..: 619 394 640 566 569 385 397 628 285 501 ...
##  $ fico_range_low                : int  670 685 660 745 715 665 690 660 670 660 ...
##  $ fico_range_high               : int  674 689 664 749 719 669 694 664 674 664 ...
##  $ inq_last_6mths                : int  0 2 0 1 1 1 0 0 0 0 ...
##  $ mths_since_last_delinq        : int  11 64 NA NA NA 7 16 53 NA 58 ...
##  $ mths_since_last_record        : int  NA NA NA NA NA NA NA 33 NA 53 ...
##  $ open_acc                      : int  9 29 4 15 9 10 9 7 12 5 ...
##  $ pub_rec                       : int  0 0 0 0 0 0 0 2 0 2 ...
##  $ revol_bal                     : int  9912 23473 5759 29581 10805 27003 6619 5572 7967 2875 ...
##  $ revol_util                    : num  44.4 54.5 72 54.6 67 82.8 66.2 68.8 52.8 54.2 ...
##  $ total_acc                     : int  22 41 5 31 19 24 12 32 28 26 ...
##  $ initial_list_status           : Factor w/ 2 levels &quot;f&quot;,&quot;w&quot;: 1 1 2 2 1 1 1 2 1 1 ...
##  $ last_credit_pull_d            : Factor w/ 70 levels &quot;Apr-2012&quot;,&quot;Apr-2013&quot;,..: 17 64 64 9 64 64 11 35 64 63 ...
##  $ last_fico_range_high          : int  629 629 599 789 724 579 724 739 689 569 ...
##  $ last_fico_range_low           : int  625 625 595 785 720 575 720 735 685 565 ...
##  $ collections_12_mths_ex_med    : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ mths_since_last_major_derog   : int  54 71 NA NA NA 7 16 53 NA 69 ...
##  $ application_type              : Factor w/ 4 levels &quot;DIRECT_PAY&quot;,&quot;Individual&quot;,..: 2 2 2 2 2 2 2 2 2 2 ...
##  $ acc_now_delinq                : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ tot_coll_amt                  : int  0 0 0 0 0 0 0 15386 0 154 ...
##  $ tot_cur_bal                   : int  39143 23473 5759 799592 327264 241609 353402 13605 14123 19530 ...
##  $ open_acc_6m                   : int  NA NA NA NA NA NA NA NA NA NA ...
##  $ open_il_12m                   : int  NA NA NA NA NA NA NA NA NA NA ...
##  $ open_il_24m                   : int  NA NA NA NA NA NA NA NA NA NA ...
##  $ mths_since_rcnt_il            : int  NA NA NA NA NA NA NA NA NA NA ...
##  $ total_bal_il                  : int  NA NA NA NA NA NA NA NA NA NA ...
##  $ il_util                       : int  NA NA NA NA NA NA NA NA NA NA ...
##  $ open_rv_12m                   : int  NA NA NA NA NA NA NA NA NA NA ...
##  $ open_rv_24m                   : int  NA NA NA NA NA NA NA NA NA NA ...
##  $ max_bal_bc                    : int  NA NA NA NA NA NA NA NA NA NA ...
##  $ all_util                      : int  NA NA NA NA NA NA NA NA NA NA ...
##  $ total_rev_hi_lim              : int  22300 43100 8000 54200 16200 32600 10000 8100 15100 5300 ...
##  $ inq_fi                        : int  NA NA NA NA NA NA NA NA NA NA ...
##  $ total_cu_tl                   : int  NA NA NA NA NA NA NA NA NA NA ...
##  $ inq_last_12m                  : int  NA NA NA NA NA NA NA NA NA NA ...
##  $ acc_open_past_24mths          : int  3 9 1 6 4 2 2 4 2 3 ...
##  $ avg_cur_bal                   : int  4349 869 1440 53306 36362 24161 39267 2268 1177 3906 ...
##  $ bc_open_to_buy                : int  973 6811 160 13901 3567 4853 1016 1428 1752 2050 ...
##  $ bc_util                       : num  89.4 54.6 96 67.1 93 74.7 74.6 79.6 75.7 52.3 ...
##  $ chargeoff_within_12_mths      : int  0 0 0 0 0 1 0 0 0 0 ...
##  $ delinq_amnt                   : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ mo_sin_old_il_acct            : int  243 115 NA 125 173 173 NA 124 67 164 ...
##  $ mo_sin_old_rev_tl_op          : int  290 186 38 229 193 294 150 182 83 271 ...
##  $ mo_sin_rcnt_rev_tl_op         : int  23 0 17 5 4 4 11 1 12 7 ...
##  $ mo_sin_rcnt_tl                : int  8 0 17 2 4 4 11 1 12 7 ...
##  $ mort_acc                      : int  0 0 0 5 3 4 1 0 0 6 ...
##  $ mths_since_recent_bc          : int  25 0 17 5 85 4 11 11 12 14 ...
##  $ mths_since_recent_bc_dlq      : int  11 70 NA NA NA 7 35 53 NA 69 ...
##  $ mths_since_recent_inq         : int  8 0 17 3 4 6 11 17 20 8 ...
##  $ mths_since_recent_revol_delinq: int  11 70 NA NA NA 7 35 53 NA 69 ...
##  $ num_accts_ever_120_pd         : int  1 1 0 0 0 3 1 6 0 1 ...
##  $ num_actv_bc_tl                : int  3 8 2 4 3 5 4 2 6 2 ...
##  $ num_actv_rev_tl               : int  4 24 4 5 5 7 8 2 7 3 ...
##  $ num_bc_sats                   : int  3 11 2 6 4 5 4 3 6 3 ...
##  $ num_bc_tl                     : int  6 17 2 8 4 11 4 14 11 6 ...
##  $ num_il_tl                     : int  9 1 0 11 8 4 0 8 8 11 ...
##  $ num_op_rev_tl                 : int  6 29 4 9 5 7 8 6 9 4 ...
##  $ num_rev_accts                 : int  13 40 5 15 8 16 11 24 20 9 ...
##  $ num_rev_tl_bal_gt_0           : int  4 24 4 5 5 7 8 2 7 3 ...
##  $ num_sats                      : int  9 29 4 15 9 10 9 7 12 5 ...
##  $ num_tl_120dpd_2m              : int  0 0 0 0 NA 0 0 0 0 0 ...
##  $ num_tl_30dpd                  : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ num_tl_90g_dpd_24m            : int  0 0 0 0 0 1 1 0 0 0 ...
##  $ num_tl_op_past_12m            : int  1 3 0 5 3 1 1 2 2 1 ...
##  $ pct_tl_nvr_dlq                : num  77.3 90.2 100 100 100 87.5 75 81.2 100 91.3 ...
##  $ percent_bc_gt_75              : num  66.7 50 100 16.7 1 80 50 33.3 66.7 66.7 ...
##  $ pub_rec_bankruptcies          : int  0 0 0 0 0 0 0 0 0 2 ...
##  $ tax_liens                     : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ tot_hi_cred_lim               : int  58486 43100 8000 850886 365874 261675 385000 18130 21314 32082 ...
##  $ total_bal_ex_mort             : int  39143 23473 5759 199739 44327 37808 6619 13605 14123 19530 ...
##  $ total_bc_limit                : int  9200 15000 4000 42200 10700 19200 4000 7000 7200 4300 ...
##  $ total_il_high_credit_limit    : int  36186 0 0 196686 57674 14075 0 10030 6214 26782 ...
##  $ year                          : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ open_il_6m                    : int  NA NA NA NA NA NA NA NA NA NA ...
##  $ y                             : int  0 0 0 0 0 1 0 0 0 0 ...
##  $ desc_flag                     : int  0 1 0 0 0 1 0 0 1 0 ...
##  $ joint_flag                    : int  0 0 0 0 0 0 0 0 0 0 ...</code></pre>
<p>Note that <em>zip_code</em> has only first 3 digits, we need to extract them and create a new variable <em>ZIP3</em>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span>dat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">ZIP3 =</span> <span class="kw">substr</span>(zip_code,<span class="dv">1</span>,<span class="dv">3</span>)) 
<span class="co">#There are also some categorical variables in nember format. They are needed to convert as well.</span>
cat.vars &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;desc_flag&quot;</span>,<span class="st">&quot;term&quot;</span>)
dat &lt;-<span class="st"> </span>dat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(desc_flag,term,joint_flag),<span class="kw">funs</span>(<span class="kw">as.factor</span>(<span class="kw">as.character</span>(.))))</code></pre></div>
<div id="imputation-missing-value-and-feature-engineering-for-numeric-variables" class="section level3">
<h3><span class="header-section-number">2.3.1</span> Imputation Missing Value and Feature Engineering for Numeric Variables</h3>
<p>After a quick and general clean up for the whole data set, <em>min</em>, <em>IQR</em>,<em>max</em> are calculated for each numeric vairable from the scaled data sets. In that way, all variables distribution pattern can be measured and compared very easily. I also plot the corresponding histgram based on original data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Use only numeric variables</span>
nums &lt;-<span class="st"> </span><span class="kw">sapply</span>(dat, is.numeric)
dat.num &lt;-<span class="st"> </span>dat[ ,nums]
dat.num &lt;-<span class="st"> </span>dat.num[,<span class="op">-</span><span class="kw">length</span>(<span class="kw">names</span>(dat.num))] <span class="co">#Exclude y</span>
<span class="co">#Scale and Calculate distribution chractoristics</span>
MySumm &lt;-<span class="st"> </span><span class="cf">function</span>(f){
        x &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">scale</span>(<span class="kw">as.numeric</span>(f)))
       s &lt;-<span class="st"> </span><span class="kw">quantile</span>(x,<span class="dt">na.rm =</span> <span class="ot">TRUE</span>,<span class="dt">names =</span> <span class="ot">FALSE</span>)
       n &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">is.na</span>(x))
       range =<span class="st"> </span><span class="kw">round</span>((s[<span class="dv">4</span>]<span class="op">-</span>s[<span class="dv">2</span>])<span class="op">*</span><span class="dv">100</span><span class="op">/</span>(s[<span class="dv">5</span>]<span class="op">-</span>s[<span class="dv">1</span>]),<span class="dv">2</span>)
        res &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">min</span>(f,<span class="dt">na.rm =</span> <span class="ot">TRUE</span>),<span class="kw">max</span>(f,<span class="dt">na.rm=</span><span class="ot">TRUE</span>),range,n)<span class="co">#IQR% &lt;- (Q3-Q1)/(max-min)</span>
        res &lt;-<span class="st"> </span><span class="kw">as.vector</span>(res,<span class="dt">mode =</span> <span class="st">&quot;any&quot;</span>)
        <span class="kw">return</span>(res)
}
<span class="co">#dat.num %&gt;% sapply(function(x){summary(scale(x))})-&gt; tbl.num</span>
dat.num[,<span class="op">-</span><span class="dv">1</span>] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sapply</span>(MySumm) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.data.frame</span>(.)-&gt;<span class="st"> </span>tbl.num <span class="co">#exclude id</span>
<span class="co">#The top 9 widest and narrowest IQR</span>
IQR.List &lt;-<span class="st"> </span>tbl.num[,<span class="kw">order</span>(<span class="op">-</span>tbl.num[<span class="dv">3</span>,<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(tbl.num)])]<span class="op">%&gt;%</span><span class="kw">names</span>()

<span class="co">#There are 13 columns that more than 75% of the data are identical, with IQR range with 0, except for y</span>
IQR.List.n &lt;-<span class="kw">names</span>(tbl.num[,<span class="kw">which</span>(tbl.num[<span class="dv">3</span>,]<span class="op">==</span><span class="dv">0</span>)])
IQR.List.n</code></pre></div>
<pre><code>##  [1] &quot;delinq_2yrs&quot;                &quot;pub_rec&quot;                   
##  [3] &quot;collections_12_mths_ex_med&quot; &quot;acc_now_delinq&quot;            
##  [5] &quot;tot_coll_amt&quot;               &quot;chargeoff_within_12_mths&quot;  
##  [7] &quot;delinq_amnt&quot;                &quot;num_accts_ever_120_pd&quot;     
##  [9] &quot;num_tl_120dpd_2m&quot;           &quot;num_tl_30dpd&quot;              
## [11] &quot;num_tl_90g_dpd_24m&quot;         &quot;pub_rec_bankruptcies&quot;      
## [13] &quot;tax_liens&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">IQR.List.w &lt;-<span class="st"> </span>IQR.List[<span class="dv">1</span><span class="op">:</span><span class="dv">9</span>]
tbl.num<span class="op">$</span>Stat &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;min&quot;</span>,<span class="st">&quot;max&quot;</span>,<span class="st">&quot;IQR%&quot;</span>,<span class="st">&quot;MissingNum&quot;</span>)</code></pre></div>
<p>Create <em>My_hist</em> function to plot these feautures in histogram vs. d.v.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_hist &lt;-<span class="st"> </span><span class="cf">function</span>(df, variables,<span class="dt">n_col=</span><span class="dv">4</span>){
   <span class="co"># fig=plt.figure(figsize=(10, 10))</span>
    <span class="kw">require</span>(<span class="st">&quot;gridExtra&quot;</span>)
    <span class="co">#require(&#39;ggpubr&#39;)</span>
    plot_var_list &lt;-<span class="st"> </span><span class="kw">combn</span>(variables,<span class="dv">1</span>,<span class="dt">simplify =</span> <span class="ot">FALSE</span>)
    plots =<span class="st"> </span><span class="kw">list</span>()
    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span> <span class="op">:</span><span class="st"> </span><span class="kw">length</span>(variables)){
            g &lt;-<span class="st"> </span><span class="kw">ggplot</span>(df,<span class="kw">aes_string</span>(plot_var_list[[i]][[<span class="dv">1</span>]]))<span class="op">+</span>
<span class="st">                    </span><span class="kw">geom_histogram</span>(<span class="dt">na.rm =</span> <span class="ot">TRUE</span>,<span class="kw">aes</span>(<span class="dt">fill=</span>loan_status))<span class="op">+</span>
<span class="st">                    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)
                    <span class="kw">theme_bw</span>()
       plots[[i]]=g
    }
  <span class="co">#                aes(fill=..count..)</span>
        nrow=<span class="kw">ceiling</span>(<span class="kw">length</span>(variables)<span class="op">/</span>n_col)
        p1 &lt;-<span class="st"> </span><span class="kw">marrangeGrob</span>(plots,<span class="dt">nrow =</span> nrow,<span class="dt">ncol =</span> n_col)
        <span class="kw">return</span>(p1)
       
}
my_hist_cat &lt;-<span class="st"> </span><span class="cf">function</span>(df, variables,<span class="dt">n_col=</span><span class="dv">4</span>){
   <span class="co"># fig=plt.figure(figsize=(10, 10))</span>
    <span class="kw">require</span>(<span class="st">&quot;gridExtra&quot;</span>)
    <span class="kw">require</span>(<span class="st">&#39;RColorBrewer&#39;</span>)
    plot_var_list &lt;-<span class="st"> </span><span class="kw">combn</span>(variables,<span class="dv">1</span>,<span class="dt">simplify =</span> <span class="ot">FALSE</span>)
    plots =<span class="st"> </span><span class="kw">list</span>()
    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span> <span class="op">:</span><span class="st"> </span><span class="kw">length</span>(variables)){
            g &lt;-<span class="st"> </span><span class="kw">ggplot</span>(df,<span class="kw">aes_string</span>(plot_var_list[[i]][[<span class="dv">1</span>]]))<span class="op">+</span>
<span class="st">                    </span><span class="kw">geom_histogram</span>(<span class="dt">na.rm =</span> <span class="ot">TRUE</span>,<span class="kw">aes</span>(<span class="dt">fill=</span>loan_status),<span class="dt">stat =</span> <span class="st">&quot;count&quot;</span>,<span class="dt">show.legend=</span><span class="ot">FALSE</span>,<span class="dt">position =</span> <span class="st">&quot;fill&quot;</span>)<span class="op">+</span>
<span class="st">                    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>,
                          <span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle=</span><span class="dv">45</span>,<span class="dt">hjust=</span><span class="dv">1</span>,<span class="dt">vjust=</span><span class="fl">0.5</span>,<span class="dt">size =</span> <span class="dv">1</span>))<span class="op">+</span>
<span class="st">                    </span><span class="kw">theme_bw</span>()<span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette=</span><span class="st">&quot;Accent&quot;</span>)
       plots[[i]]=g
    }
  <span class="co">#                aes(fill=..count..)</span>
        nrow=<span class="kw">ceiling</span>(<span class="kw">length</span>(variables)<span class="op">/</span>n_col)
        p1 &lt;-<span class="st"> </span><span class="kw">marrangeGrob</span>(plots,<span class="dt">nrow =</span> nrow,<span class="dt">ncol =</span> n_col)
        <span class="kw">return</span>(p1)
       
}

<span class="kw">my_hist</span>(dat,IQR.List.n)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tbl.num[,<span class="kw">c</span>(<span class="st">&quot;Stat&quot;</span>,IQR.List.n)]</code></pre></div>
<pre><code>##         Stat delinq_2yrs pub_rec collections_12_mths_ex_med acc_now_delinq
## 1        min           0       0                          0              0
## 2        max          39      86                         20              6
## 3       IQR%           0       0                          0              0
## 4 MissingNum           0       0                          0              0
##   tot_coll_amt chargeoff_within_12_mths delinq_amnt num_accts_ever_120_pd
## 1            0                        0           0                     0
## 2      9152545                       10       88216                    51
## 3            0                        0           0                     0
## 4        27740                        0           0                 27740
##   num_tl_120dpd_2m num_tl_30dpd num_tl_90g_dpd_24m pub_rec_bankruptcies
## 1                0            0                  0                    0
## 2                6            4                 39                   12
## 3                0            0                  0                    0
## 4            49269        27740              27740                    0
##   tax_liens
## 1         0
## 2        85
## 3         0
## 4         0</code></pre>
<p>Missing value in these feature with narrow distribution will be grouped as 1 and then the feature will be further disctritized by unique values, or outlier(values outside of 1.5sigma of Q3, or maximizing chi squared with dependant variables)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tbl.num[,<span class="kw">c</span>(<span class="st">&quot;Stat&quot;</span>,IQR.List.n)]</code></pre></div>
<pre><code>##         Stat delinq_2yrs pub_rec collections_12_mths_ex_med acc_now_delinq
## 1        min           0       0                          0              0
## 2        max          39      86                         20              6
## 3       IQR%           0       0                          0              0
## 4 MissingNum           0       0                          0              0
##   tot_coll_amt chargeoff_within_12_mths delinq_amnt num_accts_ever_120_pd
## 1            0                        0           0                     0
## 2      9152545                       10       88216                    51
## 3            0                        0           0                     0
## 4        27740                        0           0                 27740
##   num_tl_120dpd_2m num_tl_30dpd num_tl_90g_dpd_24m pub_rec_bankruptcies
## 1                0            0                  0                    0
## 2                6            4                 39                   12
## 3                0            0                  0                    0
## 4            49269        27740              27740                    0
##   tax_liens
## 1         0
## 2        85
## 3         0
## 4         0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">imp_NumtoCat1 &lt;-<span class="st"> </span><span class="cf">function</span>(x){
        x.imp &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(x),<span class="dv">0</span>,<span class="kw">ifelse</span>(x<span class="op">==</span><span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>))
        x.imp &lt;-<span class="kw">as.factor</span>(x.imp)
        <span class="kw">return</span>(x.imp)
}

imp_Median2 &lt;-<span class="st"> </span><span class="cf">function</span>(x){ <span class="co">#Impute with median</span>
        x.imp &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(x),<span class="kw">median</span>(x,<span class="dt">na.rm =</span> <span class="ot">TRUE</span>),x)
}

imp_NumtoCat3 &lt;-<span class="st"> </span><span class="cf">function</span>(x){ <span class="co">#discritized by quantile with missing as 1 level total 5 levels</span>
        q &lt;-<span class="st"> </span><span class="kw">quantile</span>(x,<span class="dt">na.rm =</span> <span class="ot">TRUE</span>,<span class="dt">names =</span> <span class="ot">FALSE</span>)
        x.imp &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(x),<span class="dv">1</span>,<span class="kw">ifelse</span>(x<span class="op">&lt;</span>q[<span class="dv">2</span>],<span class="dv">2</span>,
                                          <span class="kw">ifelse</span>(x<span class="op">&lt;</span>q[<span class="dv">3</span>]<span class="op">&amp;</span>x<span class="op">&gt;=</span>q[<span class="dv">2</span>],<span class="dv">3</span>,
                                                 <span class="kw">ifelse</span>(x<span class="op">&gt;=</span>q[<span class="dv">3</span>]<span class="op">&amp;</span>x<span class="op">&lt;</span>q[<span class="dv">4</span>],<span class="dv">4</span>,<span class="dv">5</span>))))
        x.imp &lt;-<span class="kw">as.factor</span>(x.imp)
        <span class="kw">return</span>(x.imp)
}
imp_NumtoCat4 &lt;-<span class="st"> </span><span class="cf">function</span>(x){ <span class="co">#discritized by median with total 3 groups, where missing as 1 level.</span>
        q &lt;-<span class="st"> </span><span class="kw">quantile</span>(x,<span class="dt">na.rm =</span> <span class="ot">TRUE</span>,<span class="dt">names =</span> <span class="ot">FALSE</span>)
        x.imp &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(x),<span class="dv">1</span>,<span class="kw">ifelse</span>(x<span class="op">&lt;</span>q[<span class="dv">3</span>],<span class="dv">2</span>,<span class="dv">3</span>))
        x.imp &lt;-<span class="kw">as.factor</span>(x.imp)
        <span class="kw">return</span>(x.imp)
}

imp_NumtoCat5 &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">p =</span> <span class="fl">0.95</span>){ <span class="co">#discritized by 0.95 with total 3 groups, where missing as 1 level.</span>
        <span class="cf">if</span> (p <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.5</span>) q &lt;-<span class="st"> </span><span class="kw">quantile</span>(x,<span class="dt">probs =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="fl">0.5</span>,p,<span class="dv">1</span>),<span class="dt">na.rm =</span> <span class="ot">TRUE</span>,<span class="dt">names =</span> <span class="ot">FALSE</span>)
        <span class="cf">else</span> q &lt;-<span class="st"> </span><span class="kw">quantile</span>(x,<span class="dt">probs =</span> <span class="kw">c</span>(<span class="dv">0</span>,p,<span class="fl">0.5</span>,<span class="dv">1</span>),<span class="dt">na.rm =</span> <span class="ot">TRUE</span>,<span class="dt">names =</span> <span class="ot">FALSE</span>)
        x.imp &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(x),<span class="dv">1</span>,<span class="kw">ifelse</span>(x<span class="op">&lt;</span>q[<span class="dv">2</span>],<span class="dv">2</span>,<span class="kw">ifelse</span>(x<span class="op">&lt;</span>q[<span class="dv">3</span>]<span class="op">&amp;</span>x<span class="op">&gt;=</span>q[<span class="dv">2</span>],<span class="dv">3</span>,<span class="dv">4</span>)))
        x.imp &lt;-<span class="kw">as.factor</span>(x.imp)
        <span class="kw">return</span>(x.imp)
}
imp_NumtoNeg999 &lt;-<span class="st"> </span><span class="cf">function</span>(x){ ##This method is to impute numeric missing value when using non-linear machine learning
        x.imp &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(x),<span class="op">-</span><span class="dv">999</span>,x)
        x.imp &lt;-<span class="kw">as.factor</span>(x.imp)
        <span class="kw">return</span>(x.imp)
}

imp_list &lt;-<span class="st"> </span>tbl.num[,<span class="kw">c</span>(IQR.List.n)]
imp_list[,imp_list[<span class="dv">4</span>,]<span class="op">&gt;</span><span class="dv">0</span>]<span class="op">%&gt;%</span><span class="kw">names</span>()-&gt;imp_var1</code></pre></div>
<p>Note that for this kind of imputation, it doesn’t need to do it seperately for train and test sets. But it does matter when we impute the missing use median,mean or quantile. In order to be consistant, I will always keep them seperatly. A package in r named <strong>recipes</strong> is perfect for recording the preprocess in train and then <strong>Bake</strong> them into test at once. I will like to try that when I was given more time. Now it is time to look at the features with widest IQR%</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">my_hist</span>(dat,IQR.List.w, <span class="dt">n_col =</span> <span class="dv">3</span>)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tbl.num[,<span class="kw">c</span>(<span class="st">&quot;Stat&quot;</span>,IQR.List.w)]</code></pre></div>
<pre><code>##         Stat emp_length  year percent_bc_gt_75 mths_since_last_record
## 1        min       1.00  0.00              0.0                   0.00
## 2        max      10.00  3.00            100.0                 121.00
## 3       IQR%      77.78 66.67             58.3                  33.06
## 4 MissingNum   34922.00  0.00          14555.0              565804.00
##   mths_since_recent_inq loan_amnt funded_amnt funded_amnt_inv int_rate
## 1                     0   1000.00     1000.00          775.00     5.32
## 2                    25  40000.00    40000.00        40000.00    30.99
## 3                    32     30.77       30.77           30.59    24.70
## 4                 68975      0.00        0.00            0.00     0.00</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">imp_var2 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;emp_length&quot;</span>,<span class="st">&quot;percent_bc_gt_75&quot;</span>)<span class="co">#Impute with median</span>
imp_var3 &lt;-<span class="kw">c</span>(<span class="st">&quot;mths_since_last_record&quot;</span>,<span class="st">&quot;mths_since_recent_inq&quot;</span>)<span class="co">#impute by quantile with missing as 1 level</span></code></pre></div>
<p>Continue to look at the next 9 widest distribution</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">my_hist</span>(dat,IQR.List[<span class="dv">10</span><span class="op">:</span><span class="dv">18</span>],<span class="dt">n_col =</span> <span class="dv">3</span>)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tbl.num[,<span class="kw">c</span>(<span class="st">&quot;Stat&quot;</span>,IQR.List[<span class="dv">10</span><span class="op">:</span><span class="dv">18</span>])]</code></pre></div>
<pre><code>##         Stat fico_range_low mths_since_recent_bc_dlq fico_range_high
## 1        min         660.00                     0.00          664.00
## 2        max         845.00                   176.00          850.00
## 3       IQR%          21.62                    21.59           21.51
## 4 MissingNum           0.00                512784.00            0.00
##   installment mths_since_recent_revol_delinq mths_since_last_major_derog
## 1       14.01                              0                        0.00
## 2     1584.90                            180                      192.00
## 3       20.63                             20                       18.23
## 4        0.00                         446741                   500398.00
##   mths_since_last_delinq  all_util  bc_util
## 1                   0.00      0.00     0.00
## 2                 192.00    198.00   339.60
## 3                  17.71     14.14    13.16
## 4              344562.00 562192.00 14724.00</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Upate the imputation variable array based on first estimation</span>
imp_var2 &lt;-<span class="kw">c</span>(imp_var2,<span class="st">&quot;all_util&quot;</span>,<span class="st">&quot;bc_util&quot;</span>)
imp_var4 &lt;-<span class="kw">c</span>(<span class="st">&quot;mths_since_recent_bc_dlq&quot;</span>,<span class="st">&quot;mths_since_recent_revol_delinq&quot;</span>,<span class="st">&quot;mths_since_last_major_derog&quot;</span>,<span class="st">&quot;mths_since_last_delinq&quot;</span>) </code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">my_hist</span>(dat,IQR.List[<span class="dv">19</span><span class="op">:</span><span class="dv">27</span>],<span class="dt">n_col =</span> <span class="dv">3</span>)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tbl.num[,<span class="kw">c</span>(<span class="st">&quot;Stat&quot;</span>,IQR.List[<span class="dv">19</span><span class="op">:</span><span class="dv">27</span>])]</code></pre></div>
<pre><code>##         Stat mo_sin_old_rev_tl_op inq_last_6mths last_fico_range_low
## 1        min                  2.0            0.0                0.00
## 2        max                842.0            8.0              845.00
## 3       IQR%                 13.1           12.5               11.83
## 4 MissingNum              27741.0            1.0                0.00
##   last_fico_range_high open_acc_6m num_actv_bc_tl   il_util num_rev_accts
## 1                 0.00        0.00           0.00      0.00          0.00
## 2               850.00       17.00          33.00    291.00        112.00
## 3                11.76       11.76           9.09      8.93          8.93
## 4                 0.00   562186.00       27740.00 576438.00      27741.00
##   pct_tl_nvr_dlq
## 1            6.7
## 2          100.0
## 3            8.9
## 4        27875.0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">imp_var4 &lt;-<span class="kw">c</span>(imp_var4,<span class="st">&quot;mo_sin_old_rev_tl_op&quot;</span>)
imp_var2 &lt;-<span class="st"> </span><span class="kw">c</span>(imp_var2,<span class="st">&quot;inq_last_6mths&quot;</span>,<span class="st">&quot;open_acc_6m&quot;</span>,<span class="st">&quot;num_actv_bc_tl&quot;</span>)
imp_var3 &lt;-<span class="st"> </span><span class="kw">c</span>(imp_var3,<span class="st">&quot;il_util&quot;</span>,<span class="st">&quot;num_rev_accts&quot;</span>,<span class="st">&quot;pct_tl_nvr_dlq&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">my_hist</span>(dat,IQR.List[<span class="dv">28</span><span class="op">:</span><span class="dv">36</span>],<span class="dt">n_col =</span> <span class="dv">3</span>)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-30-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tbl.num[,<span class="kw">c</span>(<span class="st">&quot;Stat&quot;</span>,IQR.List[<span class="dv">28</span><span class="op">:</span><span class="dv">36</span>])]</code></pre></div>
<pre><code>##         Stat num_rev_tl_bal_gt_0 total_acc num_bc_tl num_actv_rev_tl
## 1        min                0.00      2.00      0.00            0.00
## 2        max               45.00    176.00     70.00           52.00
## 3       IQR%                8.89      8.62      8.57            7.69
## 4 MissingNum            27740.00      0.00  27740.00        27740.00
##   inq_last_12m mo_sin_old_il_acct open_rv_12m    inq_fi
## 1          0.0               0.00        0.00      0.00
## 2         40.0             724.00       28.00     28.00
## 3          7.5               7.46        7.14      7.14
## 4     562186.0           47101.00   562185.00 562185.00
##   acc_open_past_24mths
## 1                 0.00
## 2                56.00
## 3                 7.14
## 4              7495.00</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#It is interesting that in the plot of num_actv_rev_tl, open_rv_12m,inq_fi,the number of charg off increases sharply for the right most extrem value. A new discretization and impuation for this would be, the right most 5% of the records will be in one level, missing value as 1. Rest of them will be catergorized by median. This kind of variables will be in imp_var5. The function is imp_NumtoCat5</span>
imp_var5 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;num_actv_rev_tl&quot;</span>,<span class="st">&quot;open_rv_12m&quot;</span>,<span class="st">&quot;inq_fi&quot;</span>)<span class="co">#extrem value</span>
imp_var4 &lt;-<span class="kw">c</span>(imp_var4,<span class="st">&quot;num_rev_tl_bal_gt_0&quot;</span>,<span class="st">&quot;mo_sin_old_il_acct&quot;</span>)<span class="co">#by median</span>
imp_var2 &lt;-<span class="st"> </span><span class="kw">c</span>(imp_var2,<span class="st">&quot;inq_last_12m&quot;</span>,<span class="st">&quot;num_bc_tl&quot;</span>,<span class="st">&quot;acc_open_past_24mths&quot;</span>)<span class="co">#Median</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">my_hist</span>(dat,IQR.List[<span class="dv">37</span><span class="op">:</span><span class="dv">45</span>],<span class="dt">n_col =</span> <span class="dv">3</span>)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-31-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tbl.num[,<span class="kw">c</span>(<span class="st">&quot;Stat&quot;</span>,IQR.List[<span class="dv">37</span><span class="op">:</span><span class="dv">45</span>])]</code></pre></div>
<pre><code>##         Stat open_rv_24m open_acc num_sats num_tl_op_past_12m
## 1        min        0.00     0.00     0.00               0.00
## 2        max       43.00    90.00    90.00              30.00
## 3       IQR%        6.98     6.67     6.67               6.67
## 4 MissingNum   562185.00     0.00 16055.00           27740.00
##   num_op_rev_tl mort_acc num_bc_sats num_il_tl total_cu_tl
## 1          0.00     0.00        0.00      0.00        0.00
## 2         83.00    51.00       63.00    150.00       45.00
## 3          6.02     5.88        4.76      4.67        4.44
## 4      27740.00  7495.00    16055.00  27740.00   562186.00</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">imp_var5 &lt;-<span class="st"> </span><span class="kw">c</span>(imp_var5,<span class="st">&quot;open_rv_24m&quot;</span>,<span class="st">&quot;num_il_tl&quot;</span>,<span class="st">&quot;total_cu_tl&quot;</span>,<span class="st">&quot;num_bc_sats&quot;</span>)
imp_var2 &lt;-<span class="st"> </span><span class="kw">c</span>(imp_var2,<span class="st">&quot;num_sats&quot;</span>,<span class="st">&quot;num_tl_op_past_12m&quot;</span>,<span class="st">&quot;num_op_rev_tl&quot;</span>,<span class="st">&quot;mort_acc&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">my_hist</span>(dat,IQR.List[<span class="dv">46</span><span class="op">:</span><span class="dv">54</span>],<span class="dt">n_col =</span> <span class="dv">3</span>)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-32-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tbl.num[,<span class="kw">c</span>(<span class="st">&quot;Stat&quot;</span>,IQR.List[<span class="dv">46</span><span class="op">:</span><span class="dv">54</span>])]</code></pre></div>
<pre><code>##         Stat open_il_6m revol_util open_il_12m open_il_24m
## 1        min       0.00       0.00           0        0.00
## 2        max      48.00     892.30          25       51.00
## 3       IQR%       4.17       4.06           4        3.92
## 4 MissingNum  562185.00     382.00      562185   562185.00
##   mths_since_recent_bc mths_since_rcnt_il mo_sin_rcnt_rev_tl_op
## 1                 0.00               0.00                  0.00
## 2               616.00             415.00                372.00
## 3                 3.57               3.37                  2.96
## 4             13767.00          564698.00              27741.00
##   total_bal_il tot_cur_bal
## 1         0.00        0.00
## 2   1547285.00  8000078.00
## 3         2.41        2.25
## 4    562185.00    27740.00</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">imp_var5 &lt;-<span class="st"> </span><span class="kw">c</span>(imp_var5,<span class="st">&quot;open_il_6m&quot;</span>,<span class="st">&quot;open_il_24m&quot;</span>,<span class="st">&quot;mo_sin_rcnt_rev_tl_op&quot;</span>)
imp_var2 &lt;-<span class="st"> </span><span class="kw">c</span>(imp_var2,<span class="st">&quot;revol_util&quot;</span>,<span class="st">&quot;open_il_12m&quot;</span>,<span class="st">&quot;total_bal_il&quot;</span>,<span class="st">&quot;tot_cur_bal&quot;</span>)
imp_var3 &lt;-<span class="st"> </span><span class="kw">c</span>(imp_var3,<span class="st">&quot;mths_since_recent_bc&quot;</span>,<span class="st">&quot;mths_since_rcnt_il&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">my_hist</span>(dat,IQR.List[<span class="dv">55</span><span class="op">:</span><span class="dv">63</span>],<span class="dt">n_col =</span> <span class="dv">3</span>)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-33-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tbl.num[,<span class="kw">c</span>(<span class="st">&quot;Stat&quot;</span>,IQR.List[<span class="dv">55</span><span class="op">:</span><span class="dv">63</span>])]</code></pre></div>
<pre><code>##         Stat mo_sin_rcnt_tl tot_hi_cred_lim total_il_high_credit_limit
## 1        min           0.00               0                       0.00
## 2        max         314.00         9999999                 2101913.00
## 3       IQR%           2.23               2                       1.93
## 4 MissingNum       27740.00           27740                   27740.00
##   bc_open_to_buy total_bc_limit avg_cur_bal total_bal_ex_mort   dti
## 1           0.00           0.00        0.00              0.00  -1.0
## 2      559912.00     1105500.00   958084.00        2688920.00 999.0
## 3           1.75           1.75        1.64              1.49   1.2
## 4       14301.00        7495.00    27752.00           7495.00  12.0
##   max_bal_bc
## 1       0.00
## 2  776843.00
## 3       0.65
## 4  562185.00</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">imp_var5 &lt;-<span class="st"> </span><span class="kw">c</span>(imp_var5,<span class="st">&quot;mo_sin_rcnt_tl&quot;</span>,<span class="st">&quot;total_il_high_credit_limit&quot;</span>)
imp_var3 &lt;-<span class="st"> </span><span class="kw">c</span>(imp_var3,<span class="st">&quot;tot_hi_cred_lim&quot;</span>,<span class="st">&quot;bc_open_to_buy&quot;</span>)
imp_var4 &lt;-<span class="st"> </span><span class="kw">c</span>(imp_var4,<span class="st">&quot;total_bc_limit&quot;</span>,<span class="st">&quot;avg_cur_bal&quot;</span>,<span class="st">&quot;total_bal_ex_mort&quot;</span>,<span class="st">&quot;max_bal_bc&quot;</span>)
imp_var2 &lt;-<span class="st"> </span><span class="kw">c</span>(imp_var2,<span class="st">&quot;dti&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">my_hist</span>(dat,IQR.List[<span class="dv">64</span><span class="op">:</span><span class="dv">67</span>],<span class="dt">n_col =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-34-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tbl.num[,<span class="kw">c</span>(<span class="st">&quot;Stat&quot;</span>,IQR.List[<span class="dv">64</span><span class="op">:</span><span class="dv">67</span>])]</code></pre></div>
<pre><code>##         Stat  revol_bal annual_inc total_rev_hi_lim delinq_2yrs
## 1        min       0.00        0.0             0.00           0
## 2        max 2568995.00  8900060.0       9999999.00          39
## 3       IQR%       0.53        0.5             0.25           0
## 4 MissingNum       0.00        0.0         27740.00           0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">imp_var4 &lt;-<span class="st"> </span><span class="kw">c</span>(imp_var4,<span class="st">&quot;total_rev_hi_lim&quot;</span>)</code></pre></div>
<p>Up to now, we have a strategy for all numeric variables, features in imp_var1,3,4 and 5 will be categorical, so the numeric variables will be:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">var.keep.num &lt;-<span class="st"> </span><span class="kw">names</span>(tbl.num)[<span class="op">!</span><span class="kw">names</span>(tbl.num)<span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(imp_var1,imp_var3,imp_var4,imp_var5,<span class="st">&quot;y&quot;</span>,<span class="st">&quot;Stat&quot;</span>)]
<span class="kw">length</span>(var.keep.num)</code></pre></div>
<pre><code>## [1] 41</code></pre>
</div>
<div id="imputation-missing-value-and-feature-engineering-for-categorical-variables" class="section level3">
<h3><span class="header-section-number">2.3.2</span> Imputation Missing Value and Feature Engineering for Categorical Variables</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat.cat &lt;-<span class="st"> </span>dat[,<span class="op">!</span><span class="kw">names</span>(dat)<span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(d.time,<span class="kw">names</span>(tbl.num),<span class="st">&quot;loan_status&quot;</span>,<span class="st">&quot;y&quot;</span>,<span class="st">&quot;id&quot;</span>)]
<span class="kw">names</span>(dat.cat)</code></pre></div>
<pre><code>##  [1] &quot;term&quot;                &quot;grade&quot;               &quot;sub_grade&quot;          
##  [4] &quot;emp_title&quot;           &quot;home_ownership&quot;      &quot;verification_status&quot;
##  [7] &quot;purpose&quot;             &quot;title&quot;               &quot;zip_code&quot;           
## [10] &quot;addr_state&quot;          &quot;initial_list_status&quot; &quot;application_type&quot;   
## [13] &quot;desc_flag&quot;           &quot;joint_flag&quot;          &quot;ZIP3&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat.cat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sapply</span>(<span class="cf">function</span>(x)<span class="kw">length</span>(<span class="kw">unique</span>(x))) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.data.frame</span>() -&gt;<span class="st"> </span>tbl.cat
<span class="kw">names</span>(tbl.cat) &lt;-<span class="st"> &quot;levels&quot;</span>
tbl.cat<span class="op">$</span>MissingNum &lt;-<span class="kw">sapply</span>(dat.cat,<span class="cf">function</span>(x)<span class="kw">sum</span>(<span class="kw">is.na</span>(x)))
 <span class="kw">kable</span>(tbl.cat,<span class="st">&quot;html&quot;</span>)</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
levels
</th>
<th style="text-align:right;">
MissingNum
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
term
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
grade
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
sub_grade
</td>
<td style="text-align:right;">
35
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
emp_title
</td>
<td style="text-align:right;">
238466
</td>
<td style="text-align:right;">
39767
</td>
</tr>
<tr>
<td style="text-align:left;">
home_ownership
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
verification_status
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
purpose
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
title
</td>
<td style="text-align:right;">
44348
</td>
<td style="text-align:right;">
6278
</td>
</tr>
<tr>
<td style="text-align:left;">
zip_code
</td>
<td style="text-align:right;">
918
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
addr_state
</td>
<td style="text-align:right;">
51
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
initial_list_status
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
application_type
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
desc_flag
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
joint_flag
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
ZIP3
</td>
<td style="text-align:right;">
918
</td>
<td style="text-align:right;">
0
</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#for levels less than 35(levels of subgrade), we can plot the frequency directly While for high cardality features, we plot the first 20 most frequent levels.</span>
cat.list.s &lt;-<span class="st"> </span><span class="kw">rownames</span>(tbl.cat[tbl.cat<span class="op">$</span>levels<span class="op">&lt;</span><span class="dv">36</span>,])
cat.list.l &lt;-<span class="st"> </span><span class="kw">rownames</span>(tbl.cat[tbl.cat<span class="op">$</span>levels<span class="op">&gt;</span><span class="dv">35</span>,])
<span class="kw">my_hist_cat</span>(dat,cat.list.s,<span class="dt">n_col=</span><span class="dv">3</span>)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-37-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Grade and subgrade are two variables that strongly related to the final loan status. Note that all figuers with loan status are in percentile.</span></code></pre></div>
<p>Now take a look at those nomial variables with high cardinality one by one. ####addr_state We use <strong>googlevis</strong> to plot the charged off off rate in each state. In terms of encoding, If we use one-hot encoding for the state, we need 50 nomial variables to represent, which is not a bad idea when running under desired enviroment. However, using a pc with only 6gb RAM, size of the data is a major concern. Therefore, I will use mean encoder for the state.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dt &lt;-<span class="st"> </span><span class="kw">data.table</span>(dat)[,{temp =<span class="st"> </span>.N; bct =<span class="st"> </span><span class="kw">sum</span>(loan_status <span class="op">==</span><span class="st"> &quot;Charged Off&quot;</span>);pct =<span class="st"> </span>bct<span class="op">/</span>temp;<span class="kw">list</span>(<span class="dt">Charge.off.Rate =</span> pct)},by =<span class="st"> </span>addr_state]</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(googleVis)
op &lt;-<span class="st"> </span><span class="kw">options</span>(<span class="dt">gvis.plot.tag=</span><span class="st">&#39;chart&#39;</span>)

GeoStates &lt;-<span class="st"> </span><span class="kw">gvisGeoChart</span>(dt, <span class="st">&quot;addr_state&quot;</span>, <span class="st">&quot;Charge.off.Rate&quot;</span>,
                          <span class="dt">options=</span><span class="kw">list</span>(<span class="dt">region=</span><span class="st">&quot;US&quot;</span>, 
                                       <span class="dt">displayMode=</span><span class="st">&quot;regions&quot;</span>, 
                                       <span class="dt">resolution=</span><span class="st">&quot;provinces&quot;</span>,
                                       <span class="dt">width=</span><span class="dv">600</span>, <span class="dt">height=</span><span class="dv">400</span>))
<span class="kw">plot</span>(GeoStates)</code></pre></div>
<pre><code>## &lt;!-- GeoChart generated in R 3.4.2 by googleVis 0.6.2 package --&gt;
## &lt;!-- Fri Jan 26 01:05:25 2018 --&gt;
## 
## 
## &lt;!-- jsHeader --&gt;
## &lt;script type=&quot;text/javascript&quot;&gt;
##  
## // jsData 
## function gvisDataGeoChartID1e4c39c65025 () {
## var data = new google.visualization.DataTable();
## var datajson =
## [
##  [
## &quot;MA&quot;,
## 0.1982860133
## ],
## [
## &quot;NY&quot;,
## 0.2316984427
## ],
## [
## &quot;CA&quot;,
## 0.1992717835
## ],
## [
## &quot;CO&quot;,
## 0.161099173
## ],
## [
## &quot;NM&quot;,
## 0.2260133402
## ],
## [
## &quot;FL&quot;,
## 0.2247500424
## ],
## [
## &quot;MI&quot;,
## 0.2114019647
## ],
## [
## &quot;NC&quot;,
## 0.2191255698
## ],
## [
## &quot;TX&quot;,
## 0.2043116836
## ],
## [
## &quot;CT&quot;,
## 0.189298227
## ],
## [
## &quot;GA&quot;,
## 0.1923112638
## ],
## [
## &quot;OH&quot;,
## 0.2294894124
## ],
## [
## &quot;IN&quot;,
## 0.2277995887
## ],
## [
## &quot;NJ&quot;,
## 0.2184395994
## ],
## [
## &quot;DE&quot;,
## 0.2153344209
## ],
## [
## &quot;SC&quot;,
## 0.1766143555
## ],
## [
## &quot;PA&quot;,
## 0.2191572546
## ],
## [
## &quot;UT&quot;,
## 0.1817511521
## ],
## [
## &quot;MO&quot;,
## 0.2221803093
## ],
## [
## &quot;WI&quot;,
## 0.1799976982
## ],
## [
## &quot;IL&quot;,
## 0.1962792888
## ],
## [
## &quot;WA&quot;,
## 0.1684686456
## ],
## [
## &quot;MD&quot;,
## 0.2156057495
## ],
## [
## &quot;VA&quot;,
## 0.213421454
## ],
## [
## &quot;MN&quot;,
## 0.2149946682
## ],
## [
## &quot;WY&quot;,
## 0.1863636364
## ],
## [
## &quot;KY&quot;,
## 0.2192555364
## ],
## [
## &quot;TN&quot;,
## 0.2344978601
## ],
## [
## &quot;AZ&quot;,
## 0.2033619587
## ],
## [
## &quot;NV&quot;,
## 0.2362050377
## ],
## [
## &quot;NH&quot;,
## 0.1419910657
## ],
## [
## &quot;KS&quot;,
## 0.1727649292
## ],
## [
## &quot;AL&quot;,
## 0.2576644044
## ],
## [
## &quot;RI&quot;,
## 0.1995116847
## ],
## [
## &quot;WV&quot;,
## 0.1846314325
## ],
## [
## &quot;LA&quot;,
## 0.2407917815
## ],
## [
## &quot;OR&quot;,
## 0.1556446991
## ],
## [
## &quot;VT&quot;,
## 0.1474654378
## ],
## [
## &quot;AR&quot;,
## 0.2511727912
## ],
## [
## &quot;OK&quot;,
## 0.2508159269
## ],
## [
## &quot;MT&quot;,
## 0.1758186398
## ],
## [
## &quot;HI&quot;,
## 0.2060287611
## ],
## [
## &quot;SD&quot;,
## 0.2317927171
## ],
## [
## &quot;AK&quot;,
## 0.2097588334
## ],
## [
## &quot;DC&quot;,
## 0.1338753388
## ],
## [
## &quot;NE&quot;,
## 0.2702970297
## ],
## [
## &quot;IA&quot;,
## 0.5
## ],
## [
## &quot;MS&quot;,
## 0.2824567856
## ],
## [
## &quot;ID&quot;,
## 0.2037617555
## ],
## [
## &quot;ME&quot;,
## 0.1449579832
## ],
## [
## &quot;ND&quot;,
## 0.2558139535
## ] 
## ];
## data.addColumn(&#39;string&#39;,&#39;addr_state&#39;);
## data.addColumn(&#39;number&#39;,&#39;Charge.off.Rate&#39;);
## data.addRows(datajson);
## return(data);
## }
##  
## // jsDrawChart
## function drawChartGeoChartID1e4c39c65025() {
## var data = gvisDataGeoChartID1e4c39c65025();
## var options = {};
## options[&quot;width&quot;] = 600;
## options[&quot;height&quot;] = 400;
## options[&quot;region&quot;] = &quot;US&quot;;
## options[&quot;displayMode&quot;] = &quot;regions&quot;;
## options[&quot;resolution&quot;] = &quot;provinces&quot;;
## 
## 
##     var chart = new google.visualization.GeoChart(
##     document.getElementById(&#39;GeoChartID1e4c39c65025&#39;)
##     );
##     chart.draw(data,options);
##     
## 
## }
##   
##  
## // jsDisplayChart
## (function() {
## var pkgs = window.__gvisPackages = window.__gvisPackages || [];
## var callbacks = window.__gvisCallbacks = window.__gvisCallbacks || [];
## var chartid = &quot;geochart&quot;;
##   
## // Manually see if chartid is in pkgs (not all browsers support Array.indexOf)
## var i, newPackage = true;
## for (i = 0; newPackage &amp;&amp; i &lt; pkgs.length; i++) {
## if (pkgs[i] === chartid)
## newPackage = false;
## }
## if (newPackage)
##   pkgs.push(chartid);
##   
## // Add the drawChart function to the global list of callbacks
## callbacks.push(drawChartGeoChartID1e4c39c65025);
## })();
## function displayChartGeoChartID1e4c39c65025() {
##   var pkgs = window.__gvisPackages = window.__gvisPackages || [];
##   var callbacks = window.__gvisCallbacks = window.__gvisCallbacks || [];
##   window.clearTimeout(window.__gvisLoad);
##   // The timeout is set to 100 because otherwise the container div we are
##   // targeting might not be part of the document yet
##   window.__gvisLoad = setTimeout(function() {
##   var pkgCount = pkgs.length;
##   google.load(&quot;visualization&quot;, &quot;1&quot;, { packages:pkgs, callback: function() {
##   if (pkgCount != pkgs.length) {
##   // Race condition where another setTimeout call snuck in after us; if
##   // that call added a package, we must not shift its callback
##   return;
## }
## while (callbacks.length &gt; 0)
## callbacks.shift()();
## } });
## }, 100);
## }
##  
## // jsFooter
## &lt;/script&gt;
##  
## &lt;!-- jsChart --&gt;  
## &lt;script type=&quot;text/javascript&quot; src=&quot;https://www.google.com/jsapi?callback=displayChartGeoChartID1e4c39c65025&quot;&gt;&lt;/script&gt;
##  
## &lt;!-- divChart --&gt;
##   
## &lt;div id=&quot;GeoChartID1e4c39c65025&quot; 
##   style=&quot;width: 600; height: 400;&quot;&gt;
## &lt;/div&gt;</code></pre>
<p><em>Mean encoding function</em> for high cardinality nomial variables.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">###charged off rate sample mean (This need to be calculted in train set only.)
my_MeanEncoding &lt;-<span class="st"> </span><span class="cf">function</span>(df,var,<span class="dt">k=</span><span class="dv">2</span>,<span class="dt">f=</span><span class="dv">1</span>,<span class="dt">test.df=</span><span class="ot">NULL</span>){
              
<span class="kw">data.table</span>(df)[year <span class="op">&lt;</span><span class="st"> </span><span class="dv">3</span>][,
                    {mean_p =<span class="st"> </span><span class="kw">sum</span>(y);
                     total=.N;
                     mean_p=mean_p<span class="op">/</span>total;
                     <span class="kw">list</span>(<span class="dt">mean_p=</span>mean_p,
                          <span class="dt">var_key=</span><span class="kw">get</span>(var),
                          <span class="dt">y =</span> y)}][
                                   ,{temp =<span class="st"> </span>.N; 
                                   bct =<span class="st"> </span><span class="kw">sum</span>(y);
                                   pct =<span class="st"> </span>bct<span class="op">/</span>temp;
                                   var_mean =<span class="st"> </span>mean_p<span class="op">/</span>(<span class="dv">1</span><span class="op">+</span><span class="kw">exp</span>((temp<span class="op">-</span>k)<span class="op">/</span>f)) <span class="op">+</span><span class="st"> </span>pct <span class="op">*</span>(<span class="dv">1</span><span class="op">-</span><span class="dv">1</span><span class="op">/</span>(<span class="dv">1</span><span class="op">+</span><span class="kw">exp</span>((temp<span class="op">-</span>k)<span class="op">/</span>f)));
                                   <span class="kw">list</span>(<span class="dt">var_mean =</span> var_mean,<span class="dt">mean_p =</span> mean_p,<span class="dt">tot=</span>temp,<span class="dt">var =</span> var_key)},by =<span class="st"> </span>var_key]-&gt;<span class="st"> </span>dt_mean_tr
         
        <span class="cf">if</span>(<span class="kw">is.null</span>(test.df)){ test.df =<span class="st"> </span><span class="kw">data.table</span>(df)[year <span class="op">&lt;</span><span class="st"> </span><span class="dv">3</span>]}
                <span class="kw">require</span>(dplyr)
                <span class="kw">require</span>(tidyr)
                <span class="kw">require</span>(NLP)
                mean_p_forna =<span class="st"> </span>dt_mean_tr<span class="op">$</span>mean_p[<span class="dv">1</span>]
                lookup &lt;-<span class="st"> </span><span class="kw">unique</span>(dt_mean_tr)
                test.df <span class="op">%&gt;%</span>
<span class="st">                        </span><span class="kw">mutate</span>(<span class="dt">var_key =</span> <span class="kw">get</span>(var))<span class="op">%&gt;%</span>
<span class="st">                        </span><span class="kw">left_join</span>(lookup, <span class="dt">by =</span> <span class="st">&quot;var_key&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">                         </span><span class="kw">mutate_at</span>(<span class="st">&quot;var_mean&quot;</span>,<span class="kw">funs</span>(<span class="kw">ifelse</span>(<span class="kw">is.na</span>(.),mean_p_forna,.)))-&gt;dt_mean_te
        
                <span class="kw">return</span>(dt_mean_te[,<span class="st">&quot;var_mean&quot;</span>])
}</code></pre></div>
<div id="zip3-and-emp_title" class="section level4">
<h4><span class="header-section-number">2.3.2.1</span> ZIP3 and emp_title</h4>
<p><em>Trim.Cap</em> function to trim all the empty spaces before and after the charactor and then capitalized them all.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Apply mean encoding to ZIP3 and emp_title as well.</span>
<span class="co">#before mean encoding, </span>
Trim.Cap &lt;-<span class="st">  </span><span class="cf">function</span>(x) {
        x &lt;-<span class="st"> </span><span class="kw">as.character</span>(x)
                x &lt;-<span class="st"> </span><span class="kw">trimws</span>(x)
                x &lt;-<span class="st"> </span><span class="kw">toupper</span>(x)
                <span class="kw">return</span>(x)
}
dat<span class="op">$</span>emp_title &lt;-<span class="st"> </span><span class="kw">Trim.Cap</span>(dat<span class="op">$</span>emp_title)</code></pre></div>
</div>
<div id="title" class="section level4">
<h4><span class="header-section-number">2.3.2.2</span> title</h4>
<p>Title is where the borrowers gives a name to the lending application. Some text mining can be tried in the future, but I will drop this feature for now. It is the loan title provided by the borrower.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span><span class="kw">data.table</span>(dat)[,title <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">Trim.Cap</span>(title)]
<span class="kw">length</span>(<span class="kw">unique</span>(dat<span class="op">$</span>title))</code></pre></div>
<pre><code>## [1] 35309</code></pre>
<p>There are 35309 different title that borrowers named their loan. Lets look at the 20 most frequent used ones.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">title_list =<span class="st"> </span>plyr<span class="op">::</span><span class="kw">count</span>(dat<span class="op">$</span>title)<span class="op">%&gt;%</span><span class="kw">arrange</span>(<span class="op">-</span>freq)<span class="op">%&gt;%</span><span class="kw">head</span>(<span class="dv">20</span>)<span class="op">%&gt;%</span><span class="kw">arrange</span>(x) 

p &lt;-<span class="st"> </span>dat <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw">filter</span>(title <span class="op">%in%</span><span class="st"> </span>title_list[[<span class="dv">1</span>]]) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(title,<span class="dt">fill=</span>loan_status))<span class="op">+</span>
<span class="st">        </span><span class="kw">geom_bar</span>(<span class="dt">alpha=</span><span class="fl">0.8</span>)<span class="op">+</span>
<span class="st">        </span><span class="kw">scale_x_discrete</span>(<span class="dt">labels =</span> <span class="cf">function</span>(x)<span class="kw">str_wrap</span>(x, <span class="dt">width =</span> <span class="dv">20</span>))<span class="op">+</span>
<span class="st">        </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle=</span><span class="dv">45</span>,<span class="dt">hjust=</span><span class="dv">1</span>,<span class="dt">vjust=</span><span class="fl">0.5</span>,<span class="dt">size =</span> <span class="dv">5</span>))

<span class="kw">ggplotly</span>(p)</code></pre></div>
<div id="33884b5147a6" style="width:672px;height:480px;" class="plotly html-widget"></div>
<script type="application/json" data-for="33884b5147a6">{"x":{"data":[{"orientation":"v","width":[0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999],"base":[3894,3881,1523,5795,1871,2651,1926,1935,91673,258539,2318,1739,27742,8196,4327,2553,20972,1860,2787,4328],"x":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],"y":[1901,803,316,1102,317,349,283,279,21814,76502,413,583,6767,2227,1420,947,6387,365,739,1950],"text":["count:   1901<br />title: BUSINESS<br />loan_status: Charged Off","count:    803<br />title: CAR FINANCING<br />loan_status: Charged Off","count:    316<br />title: CONSOLIDATE<br />loan_status: Charged Off","count:   1102<br />title: CONSOLIDATION<br />loan_status: Charged Off","count:    317<br />title: CONSOLIDATION LOAN<br />loan_status: Charged Off","count:    349<br />title: CREDIT CARD CONSOLIDATION<br />loan_status: Charged Off","count:    283<br />title: CREDIT CARD PAYOFF<br />loan_status: Charged Off","count:    279<br />title: CREDIT CARD REFINANCE<br />loan_status: Charged Off","count:  21814<br />title: CREDIT CARD REFINANCING<br />loan_status: Charged Off","count:  76502<br />title: DEBT CONSOLIDATION<br />loan_status: Charged Off","count:    413<br />title: DEBT CONSOLIDATION LOAN<br />loan_status: Charged Off","count:    583<br />title: HOME BUYING<br />loan_status: Charged Off","count:   6767<br />title: HOME IMPROVEMENT<br />loan_status: Charged Off","count:   2227<br />title: MAJOR PURCHASE<br />loan_status: Charged Off","count:   1420<br />title: MEDICAL EXPENSES<br />loan_status: Charged Off","count:    947<br />title: MOVING AND RELOCATION<br />loan_status: Charged Off","count:   6387<br />title: OTHER<br />loan_status: Charged Off","count:    365<br />title: PERSONAL LOAN<br />loan_status: Charged Off","count:    739<br />title: VACATION<br />loan_status: Charged Off","count:   1950<br />title: NA<br />loan_status: Charged Off"],"type":"bar","marker":{"autocolorscale":false,"color":"rgba(248,118,109,0.8)","line":{"width":1.88976377952756,"color":"transparent"}},"name":"Charged Off","legendgroup":"Charged Off","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"orientation":"v","width":[0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999,0.899999999999999],"base":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"x":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],"y":[3894,3881,1523,5795,1871,2651,1926,1935,91673,258539,2318,1739,27742,8196,4327,2553,20972,1860,2787,4328],"text":["count:   3894<br />title: BUSINESS<br />loan_status: Fully Paid","count:   3881<br />title: CAR FINANCING<br />loan_status: Fully Paid","count:   1523<br />title: CONSOLIDATE<br />loan_status: Fully Paid","count:   5795<br />title: CONSOLIDATION<br />loan_status: Fully Paid","count:   1871<br />title: CONSOLIDATION LOAN<br />loan_status: Fully Paid","count:   2651<br />title: CREDIT CARD CONSOLIDATION<br />loan_status: Fully Paid","count:   1926<br />title: CREDIT CARD PAYOFF<br />loan_status: Fully Paid","count:   1935<br />title: CREDIT CARD REFINANCE<br />loan_status: Fully Paid","count:  91673<br />title: CREDIT CARD REFINANCING<br />loan_status: Fully Paid","count: 258539<br />title: DEBT CONSOLIDATION<br />loan_status: Fully Paid","count:   2318<br />title: DEBT CONSOLIDATION LOAN<br />loan_status: Fully Paid","count:   1739<br />title: HOME BUYING<br />loan_status: Fully Paid","count:  27742<br />title: HOME IMPROVEMENT<br />loan_status: Fully Paid","count:   8196<br />title: MAJOR PURCHASE<br />loan_status: Fully Paid","count:   4327<br />title: MEDICAL EXPENSES<br />loan_status: Fully Paid","count:   2553<br />title: MOVING AND RELOCATION<br />loan_status: Fully Paid","count:  20972<br />title: OTHER<br />loan_status: Fully Paid","count:   1860<br />title: PERSONAL LOAN<br />loan_status: Fully Paid","count:   2787<br />title: VACATION<br />loan_status: Fully Paid","count:   4328<br />title: NA<br />loan_status: Fully Paid"],"type":"bar","marker":{"autocolorscale":false,"color":"rgba(0,191,196,0.8)","line":{"width":1.88976377952756,"color":"transparent"}},"name":"Fully Paid","legendgroup":"Fully Paid","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":26.2283105022831,"r":7.30593607305936,"b":72.2457731926912,"l":54.7945205479452},"plot_bgcolor":"rgba(235,235,235,1)","paper_bgcolor":"rgba(255,255,255,1)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xaxis":{"domain":[0,1],"type":"linear","autorange":false,"tickmode":"array","range":[0.4,20.6],"ticktext":["BUSINESS","CAR FINANCING","CONSOLIDATE","CONSOLIDATION","CONSOLIDATION LOAN","CREDIT CARD<br />CONSOLIDATION","CREDIT CARD PAYOFF","CREDIT CARD<br />REFINANCE","CREDIT CARD<br />REFINANCING","DEBT CONSOLIDATION","DEBT CONSOLIDATION<br />LOAN","HOME BUYING","HOME IMPROVEMENT","MAJOR PURCHASE","MEDICAL EXPENSES","MOVING AND<br />RELOCATION","OTHER","PERSONAL LOAN","VACATION",null],"tickvals":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":6.6417600664176},"tickangle":-45,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"y","title":"title","titlefont":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"hoverformat":".2f"},"yaxis":{"domain":[0,1],"type":"linear","autorange":false,"tickmode":"array","range":[-16752.05,351793.05],"ticktext":["0e+00","1e+05","2e+05","3e+05"],"tickvals":[0,100000,200000,300000],"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"x","title":"count","titlefont":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":true,"legend":{"bgcolor":"rgba(255,255,255,1)","bordercolor":"transparent","borderwidth":1.88976377952756,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.689497716895},"y":0.913385826771654},"annotations":[{"text":"loan_status","x":1.02,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"left","yanchor":"bottom","legendTitle":true}],"barmode":"stack","hovermode":"closest"},"source":"A","attrs":{"33885be0332b":{"x":{},"fill":{},"type":"ggplotly"}},"cur_data":"33885be0332b","visdat":{"33885be0332b":["function (y) ","x"]},"config":{"modeBarButtonsToAdd":[{"name":"Collaborate","icon":{"width":1000,"ascent":500,"descent":-50,"path":"M487 375c7-10 9-23 5-36l-79-259c-3-12-11-23-22-31-11-8-22-12-35-12l-263 0c-15 0-29 5-43 15-13 10-23 23-28 37-5 13-5 25-1 37 0 0 0 3 1 7 1 5 1 8 1 11 0 2 0 4-1 6 0 3-1 5-1 6 1 2 2 4 3 6 1 2 2 4 4 6 2 3 4 5 5 7 5 7 9 16 13 26 4 10 7 19 9 26 0 2 0 5 0 9-1 4-1 6 0 8 0 2 2 5 4 8 3 3 5 5 5 7 4 6 8 15 12 26 4 11 7 19 7 26 1 1 0 4 0 9-1 4-1 7 0 8 1 2 3 5 6 8 4 4 6 6 6 7 4 5 8 13 13 24 4 11 7 20 7 28 1 1 0 4 0 7-1 3-1 6-1 7 0 2 1 4 3 6 1 1 3 4 5 6 2 3 3 5 5 6 1 2 3 5 4 9 2 3 3 7 5 10 1 3 2 6 4 10 2 4 4 7 6 9 2 3 4 5 7 7 3 2 7 3 11 3 3 0 8 0 13-1l0-1c7 2 12 2 14 2l218 0c14 0 25-5 32-16 8-10 10-23 6-37l-79-259c-7-22-13-37-20-43-7-7-19-10-37-10l-248 0c-5 0-9-2-11-5-2-3-2-7 0-12 4-13 18-20 41-20l264 0c5 0 10 2 16 5 5 3 8 6 10 11l85 282c2 5 2 10 2 17 7-3 13-7 17-13z m-304 0c-1-3-1-5 0-7 1-1 3-2 6-2l174 0c2 0 4 1 7 2 2 2 4 4 5 7l6 18c0 3 0 5-1 7-1 1-3 2-6 2l-173 0c-3 0-5-1-8-2-2-2-4-4-4-7z m-24-73c-1-3-1-5 0-7 2-2 3-2 6-2l174 0c2 0 5 0 7 2 3 2 4 4 5 7l6 18c1 2 0 5-1 6-1 2-3 3-5 3l-174 0c-3 0-5-1-7-3-3-1-4-4-5-6z"},"click":"function(gd) { \n        // is this being viewed in RStudio?\n        if (location.search == '?viewer_pane=1') {\n          alert('To learn about plotly for collaboration, visit:\\n https://cpsievert.github.io/plotly_book/plot-ly-for-collaboration.html');\n        } else {\n          window.open('https://cpsievert.github.io/plotly_book/plot-ly-for-collaboration.html', '_blank');\n        }\n      }"}],"cloud":false},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1}},"base_url":"https://plot.ly"},"evals":["config.modeBarButtonsToAdd.0.click"],"jsHooks":{"render":[{"code":"function(el, x) { var ctConfig = crosstalk.var('plotlyCrosstalkOpts').set({\"on\":\"plotly_click\",\"persistent\":false,\"dynamic\":false,\"selectize\":false,\"opacityDim\":0.2,\"selected\":{\"opacity\":1}}); }","data":null}]}}</script>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span><span class="kw">data.table</span>(dat)[,title<span class="op">:</span><span class="er">=</span><span class="ot">NULL</span>]</code></pre></div>
</div>
</div>
</div>
<div id="compute-relevance-between-i.v-d.v." class="section level2">
<h2><span class="header-section-number">2.4</span> Compute relevance between &lt;i.v, d.v.&gt;</h2>
<div id="exisiting-numeric-variables" class="section level3">
<h3><span class="header-section-number">2.4.1</span> Exisiting Numeric Variables</h3>
<p><em>Mutual information</em> Calculation</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#to compute relevance between numeric variables and DV, I use mutual information, which is perfect for continous IV and nomial DV</span>

my_MICal &lt;-<span class="st"> </span><span class="cf">function</span>(df,var){
        datalist =<span class="st"> </span><span class="kw">list</span>()
        j =<span class="dv">1</span>
        <span class="kw">require</span>(entropy)
        <span class="kw">require</span>(NLP)
        <span class="cf">for</span> (i <span class="cf">in</span> var){
        <span class="co">#Calculate joint distribution for IV and DV</span>
       <span class="kw">data.table</span>(df)[year<span class="op">&lt;</span><span class="dv">3</span>][
                ,total <span class="op">:</span><span class="er">=</span><span class="st"> </span>.N][
                        ,{temp0 =<span class="st"> </span>.N; 
                        temp1 =<span class="st"> </span><span class="kw">sum</span>(y)<span class="op">/</span>total; 
                        temp0 =<span class="st"> </span>temp0<span class="op">/</span>total<span class="op">-</span>temp1;
                        <span class="kw">list</span>(<span class="dt">pct0 =</span> temp0, <span class="dt">pct1 =</span> temp1)},by =<span class="st"> </span><span class="kw">get</span>(i)]<span class="op">%&gt;%</span>
<span class="st">                        </span><span class="kw">na.omit</span>(.) -&gt;dt
        dt &lt;-<span class="st"> </span>dt[<span class="op">!</span><span class="kw">duplicated</span>(dt[,<span class="kw">as.String</span>(i)])]
       
        MI &lt;-<span class="kw">mi.plugin</span>(dt[,<span class="dv">2</span><span class="op">:</span><span class="dv">3</span>])
        datalist[[j]] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">as.String</span>(i),MI)
        j =j<span class="op">+</span><span class="dv">1</span>
        }
        MI =<span class="st"> </span><span class="kw">do.call</span>(rbind, datalist)
<span class="co">#Sort them in descending order </span>
        MI.tbl &lt;-<span class="st"> </span>MI <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.data.frame</span>(.)<span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">mutate_at</span>(<span class="st">&quot;V2&quot;</span>,<span class="kw">funs</span>(<span class="kw">as.numeric</span>(<span class="kw">as.character</span>(.))))<span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">arrange</span>(<span class="op">-</span>V2)
        <span class="kw">return</span>(MI.tbl)
}
<span class="kw">my_MICal</span>(dat,var.keep.num) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">20</span>)</code></pre></div>
<pre><code>##                      V1          V2
## 1  last_fico_range_high 0.207397328
## 2   last_fico_range_low 0.207163217
## 3           tot_cur_bal 0.161027652
## 4           installment 0.030370518
## 5              int_rate 0.029750534
## 6             revol_bal 0.022286208
## 7              all_util 0.009886439
## 8                   dti 0.007218558
## 9          total_bal_il 0.006984252
## 10                 year 0.005431646
## 11       fico_range_low 0.004379458
## 12      fico_range_high 0.004379458
## 13     percent_bc_gt_75 0.003996801
## 14              bc_util 0.003088509
## 15 acc_open_past_24mths 0.002966398
## 16   num_tl_op_past_12m 0.002541873
## 17         inq_last_12m 0.002478204
## 18           revol_util 0.002171781
## 19           annual_inc 0.001791833
## 20            loan_amnt 0.001752224</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#last_fico_range_hig,last_fico_range_low,tot_cur_bal are higher than 0.15, which are quite strong indicators for loa status.</span></code></pre></div>
<p>impute missing values in continous variables based on previous analysis</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat&lt;-<span class="kw">as.data.frame</span>(dat)
dat.train.imp2 &lt;-<span class="st"> </span>dat[dat<span class="op">$</span>year<span class="op">&lt;</span><span class="dv">3</span>,imp_var2] <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">mutate_all</span>(imp_Median2)
<span class="co">#Same apply to test set</span>
dat.test.imp2 &lt;-<span class="st"> </span>dat[dat<span class="op">$</span>year<span class="op">==</span><span class="dv">3</span>,imp_var2] <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">mutate_all</span>(imp_Median2)
<span class="co">#Imputate other numerical variables to nomial variables</span>
dat.train.imp1 &lt;-<span class="st"> </span>dat[dat<span class="op">$</span>year<span class="op">&lt;</span><span class="dv">3</span>,imp_var1]<span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">mutate_all</span>(imp_NumtoCat1)
dat.train.imp3 &lt;-<span class="st"> </span>dat[dat<span class="op">$</span>year<span class="op">&lt;</span><span class="dv">3</span>,imp_var3] <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw">mutate_all</span>(imp_NumtoCat3)
dat.train.imp4 &lt;-<span class="st"> </span>dat[dat<span class="op">$</span>year<span class="op">&lt;</span><span class="dv">3</span>,imp_var4] <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw">mutate_all</span>(imp_NumtoCat4)
dat.train.imp5 &lt;-<span class="st"> </span>dat[dat<span class="op">$</span>year<span class="op">&lt;</span><span class="dv">3</span>,imp_var5] <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">mutate_all</span>(imp_NumtoCat5)
dat.train.imp &lt;-<span class="st"> </span><span class="kw">cbind</span>(dat.train.imp1,dat.train.imp3,dat.train.imp4,dat.train.imp5)

dat.test.imp1 &lt;-<span class="st"> </span>dat[dat<span class="op">$</span>year<span class="op">==</span><span class="dv">3</span>,imp_var1] <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">         </span><span class="kw">mutate_all</span>(imp_NumtoCat1)
dat.test.imp3 &lt;-<span class="st"> </span>dat[dat<span class="op">$</span>year<span class="op">==</span><span class="dv">3</span>,imp_var3] <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw">mutate_all</span>(imp_NumtoCat3)
dat.test.imp4 &lt;-<span class="st"> </span>dat[dat<span class="op">$</span>year<span class="op">==</span><span class="dv">3</span>,imp_var4] <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw">mutate_all</span>(imp_NumtoCat4)
dat.test.imp5 &lt;-<span class="st"> </span>dat[dat<span class="op">$</span>year<span class="op">==</span><span class="dv">3</span>,imp_var5] <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw">mutate_all</span>(imp_NumtoCat5)
dat.test.imp &lt;-<span class="st"> </span><span class="kw">cbind</span>(dat.test.imp1,dat.test.imp3,dat.test.imp4,dat.test.imp5)</code></pre></div>
</div>
<div id="new-continous-variables" class="section level3">
<h3><span class="header-section-number">2.4.2</span> New Continous Variables</h3>
<p>In this section, we will take a look at the MI between imputed continous variables from high-cardinality nomial variables, includig <em>emp_title</em>,<em>ZIP3</em> and <em>addr_state</em></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cat.list.l</code></pre></div>
<pre><code>## [1] &quot;emp_title&quot;  &quot;title&quot;      &quot;zip_code&quot;   &quot;addr_state&quot; &quot;ZIP3&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">emp_title_mean &lt;-<span class="st"> </span><span class="kw">my_MeanEncoding</span>(dat,<span class="dt">var=</span><span class="st">&quot;emp_title&quot;</span>)
ZIP3_mean &lt;-<span class="st"> </span><span class="kw">my_MeanEncoding</span>(dat,<span class="dt">var=</span><span class="st">&quot;ZIP3&quot;</span>)
state_mean &lt;-<span class="st"> </span><span class="kw">my_MeanEncoding</span>(dat,<span class="dt">var=</span><span class="st">&quot;addr_state&quot;</span>)
###Prepare these mean encoding in test features.
dat.test &lt;-<span class="st"> </span><span class="kw">data.table</span>(dat)[year<span class="op">==</span><span class="dv">3</span>]
emp_title_mean.ts &lt;-<span class="kw">my_MeanEncoding</span>(dat,<span class="dt">var=</span><span class="st">&quot;emp_title&quot;</span>,<span class="dt">test.df =</span>dat.test)
ZIP3_mean.ts &lt;-<span class="kw">my_MeanEncoding</span>(dat,<span class="dt">var=</span><span class="st">&quot;ZIP3&quot;</span>,<span class="dt">test.df =</span>dat.test)
state_mean.ts &lt;-<span class="kw">my_MeanEncoding</span>(dat,<span class="dt">var=</span><span class="st">&quot;addr_state&quot;</span>,<span class="dt">test.df =</span>dat.test)
<span class="kw">my_MICal</span>(dat,<span class="kw">c</span>(<span class="st">&quot;ZIP3_mean&quot;</span>,<span class="st">&quot;emp_title_mean&quot;</span>,<span class="st">&quot;state_mean&quot;</span>))</code></pre></div>
<pre><code>##               V1           V2
## 1 emp_title_mean 0.2027328342
## 2      ZIP3_mean 0.0024369657
## 3     state_mean 0.0007213942</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">var.drop &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;emp_title&quot;</span>,<span class="st">&quot;ZIP3&quot;</span>,<span class="st">&quot;addr_state&quot;</span>,<span class="st">&quot;zip_code&quot;</span>,<span class="st">&quot;title&quot;</span>)</code></pre></div>
<p>It shows the MI scores that emp_title_mean plays a important role, while state doesn’t. It seems that bad loan is not varied too much geologically. ### Exsisting Categorical Variables</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">my_MICal</span>(dat,cat.list.s)</code></pre></div>
<pre><code>##                     V1           V2
## 1            sub_grade 2.301481e-02
## 2                grade 2.192099e-02
## 3                 term 8.251958e-03
## 4  verification_status 4.034040e-03
## 5     application_type 3.782531e-03
## 6       home_ownership 2.337330e-03
## 7              purpose 6.195969e-04
## 8            desc_flag 3.427830e-04
## 9  initial_list_status 1.048890e-04
## 10          joint_flag 2.524826e-09</code></pre>
</div>
<div id="new-categorical-variables" class="section level3">
<h3><span class="header-section-number">2.4.3</span> New Categorical Variables</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Adding two variables in order to calculate MI</span>
dat.train.imp<span class="op">$</span>year &lt;-<span class="st"> </span>dat[dat<span class="op">$</span>year<span class="op">&lt;</span><span class="dv">3</span>,<span class="st">&quot;year&quot;</span>]
dat.train.imp<span class="op">$</span>y &lt;-<span class="st"> </span>dat[dat<span class="op">$</span>year<span class="op">&lt;</span><span class="dv">3</span>,<span class="st">&quot;y&quot;</span>]<span class="co">#Add this at last</span>

<span class="kw">my_MICal</span>(dat.train.imp,<span class="kw">names</span>(dat.train.imp)[<span class="dv">1</span><span class="op">:</span>(<span class="kw">length</span>(dat.train.imp)<span class="op">-</span><span class="dv">2</span>)])<span class="op">%&gt;%</span><span class="kw">head</span>(<span class="dv">20</span>)
<span class="co">#It seems that after imputation those new nomial variables are not very strong indicator. </span></code></pre></div>
</div>
</div>
<div id="evaluate-relevance-between-selected-i.v." class="section level2">
<h2><span class="header-section-number">2.5</span> Evaluate relevance between selected i.v.</h2>
<p>let’s look at the correlation between numeric variables</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res &lt;-<span class="st"> </span><span class="kw">cor</span>(dat[dat<span class="op">$</span>year<span class="op">&lt;</span><span class="dv">3</span>,<span class="kw">names</span>(dat)<span class="op">%in%</span>var.keep.num<span class="op">&amp;!</span><span class="kw">names</span>(dat)<span class="op">==</span><span class="st">&quot;year&quot;</span>],<span class="dt">use =</span> <span class="st">&quot;complete.obs&quot;</span>)
<span class="kw">require</span>(corrplot)
<span class="kw">corrplot</span>(res[<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(var.keep.num)<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(var.keep.num)<span class="op">-</span><span class="dv">1</span>], <span class="dt">type =</span> <span class="st">&quot;upper&quot;</span>, <span class="dt">order =</span> <span class="st">&quot;hclust&quot;</span>, 
         <span class="dt">tl.col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">tl.srt =</span> <span class="dv">45</span>)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-50-1.png" width="672" /> ##Date Time Variable analysis There are three variables are in date time format.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d.time</code></pre></div>
<pre><code>## [1] &quot;issue_d&quot;            &quot;earliest_cr_line&quot;   &quot;last_credit_pull_d&quot;</code></pre>
<div id="issue_d" class="section level3">
<h3><span class="header-section-number">2.5.1</span> issue_d</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dt0 &lt;-<span class="st"> </span><span class="kw">data.table</span>(dat)[,issue_d_new <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">mdy</span>(issue_d)]
dt0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>issue_d_new,<span class="dt">color =</span> loan_status))<span class="op">+</span><span class="kw">facet_grid</span>(loan_status<span class="op">~</span>.,<span class="dt">scales =</span> <span class="st">&quot;free&quot;</span>)<span class="op">+</span>
<span class="st">        </span><span class="kw">geom_freqpoly</span>(<span class="dt">bins=</span><span class="dv">60</span>,<span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">alpha =</span> <span class="fl">0.8</span>)-&gt;p

<span class="kw">ggplotly</span>(p)</code></pre></div>
<p><div id="33882d2e639e" style="width:672px;height:480px;" class="plotly html-widget"></div>
<script type="application/json" data-for="33882d2e639e">{"x":{"data":[{"x":[1325557586440.68,1328187661016.95,1330817735593.22,1333447810169.49,1336077884745.76,1338707959322.03,1341338033898.3,1343968108474.58,1346598183050.85,1349228257627.12,1351858332203.39,1354488406779.66,1357118481355.93,1359748555932.2,1362378630508.47,1365008705084.75,1367638779661.02,1370268854237.29,1372898928813.56,1375529003389.83,1378159077966.1,1380789152542.37,1383419227118.64,1386049301694.92,1388679376271.19,1391309450847.46,1393939525423.73,1396569600000,1399199674576.27,1401829749152.54,1404459823728.81,1407089898305.08,1409719972881.36,1412350047457.63,1414980122033.9,1417610196610.17,1420240271186.44,1422870345762.71,1425500420338.98,1428130494915.25,1430760569491.53,1433390644067.8,1436020718644.07,1438650793220.34,1441280867796.61,1443910942372.88,1446541016949.15,1449171091525.42,1451801166101.7,1454431240677.97,1457061315254.24,1459691389830.51,1462321464406.78,1464951538983.05,1467581613559.32,1470211688135.59,1472841762711.86,1475471837288.14,1478101911864.41,1480731986440.68,1483362061016.95,1485992135593.22],"y":[0,440,421,443,496,569,714,819,884,948,959,1025,902,1046,1148,1181,1474,1684,1723,1802,1873,1966,2113,2162,2181,2351,2372,2584,3058,3072,2863,4734,3032,1684,6252,3789,1434,5223,7009,0,4852,4308,3745,5635,4104,3228,4814,3699,4445,2915,3296,4983,2687,1923,1863,1846,1642,1092,873,720,651,0],"text":["count:     0<br />issue_d_new: 15342.10<br />loan_status: Charged Off","count:   440<br />issue_d_new: 15372.54<br />loan_status: Charged Off","count:   421<br />issue_d_new: 15402.98<br />loan_status: Charged Off","count:   443<br />issue_d_new: 15433.42<br />loan_status: Charged Off","count:   496<br />issue_d_new: 15463.86<br />loan_status: Charged Off","count:   569<br />issue_d_new: 15494.31<br />loan_status: Charged Off","count:   714<br />issue_d_new: 15524.75<br />loan_status: Charged Off","count:   819<br />issue_d_new: 15555.19<br />loan_status: Charged Off","count:   884<br />issue_d_new: 15585.63<br />loan_status: Charged Off","count:   948<br />issue_d_new: 15616.07<br />loan_status: Charged Off","count:   959<br />issue_d_new: 15646.51<br />loan_status: Charged Off","count:  1025<br />issue_d_new: 15676.95<br />loan_status: Charged Off","count:   902<br />issue_d_new: 15707.39<br />loan_status: Charged Off","count:  1046<br />issue_d_new: 15737.83<br />loan_status: Charged Off","count:  1148<br />issue_d_new: 15768.27<br />loan_status: Charged Off","count:  1181<br />issue_d_new: 15798.71<br />loan_status: Charged Off","count:  1474<br />issue_d_new: 15829.15<br />loan_status: Charged Off","count:  1684<br />issue_d_new: 15859.59<br />loan_status: Charged Off","count:  1723<br />issue_d_new: 15890.03<br />loan_status: Charged Off","count:  1802<br />issue_d_new: 15920.47<br />loan_status: Charged Off","count:  1873<br />issue_d_new: 15950.92<br />loan_status: Charged Off","count:  1966<br />issue_d_new: 15981.36<br />loan_status: Charged Off","count:  2113<br />issue_d_new: 16011.80<br />loan_status: Charged Off","count:  2162<br />issue_d_new: 16042.24<br />loan_status: Charged Off","count:  2181<br />issue_d_new: 16072.68<br />loan_status: Charged Off","count:  2351<br />issue_d_new: 16103.12<br />loan_status: Charged Off","count:  2372<br />issue_d_new: 16133.56<br />loan_status: Charged Off","count:  2584<br />issue_d_new: 16164.00<br />loan_status: Charged Off","count:  3058<br />issue_d_new: 16194.44<br />loan_status: Charged Off","count:  3072<br />issue_d_new: 16224.88<br />loan_status: Charged Off","count:  2863<br />issue_d_new: 16255.32<br />loan_status: Charged Off","count:  4734<br />issue_d_new: 16285.76<br />loan_status: Charged Off","count:  3032<br />issue_d_new: 16316.20<br />loan_status: Charged Off","count:  1684<br />issue_d_new: 16346.64<br />loan_status: Charged Off","count:  6252<br />issue_d_new: 16377.08<br />loan_status: Charged Off","count:  3789<br />issue_d_new: 16407.53<br />loan_status: Charged Off","count:  1434<br />issue_d_new: 16437.97<br />loan_status: Charged Off","count:  5223<br />issue_d_new: 16468.41<br />loan_status: Charged Off","count:  7009<br />issue_d_new: 16498.85<br />loan_status: Charged Off","count:     0<br />issue_d_new: 16529.29<br />loan_status: Charged Off","count:  4852<br />issue_d_new: 16559.73<br />loan_status: Charged Off","count:  4308<br />issue_d_new: 16590.17<br />loan_status: Charged Off","count:  3745<br />issue_d_new: 16620.61<br />loan_status: Charged Off","count:  5635<br />issue_d_new: 16651.05<br />loan_status: Charged Off","count:  4104<br />issue_d_new: 16681.49<br />loan_status: Charged Off","count:  3228<br />issue_d_new: 16711.93<br />loan_status: Charged Off","count:  4814<br />issue_d_new: 16742.37<br />loan_status: Charged Off","count:  3699<br />issue_d_new: 16772.81<br />loan_status: Charged Off","count:  4445<br />issue_d_new: 16803.25<br />loan_status: Charged Off","count:  2915<br />issue_d_new: 16833.69<br />loan_status: Charged Off","count:  3296<br />issue_d_new: 16864.14<br />loan_status: Charged Off","count:  4983<br />issue_d_new: 16894.58<br />loan_status: Charged Off","count:  2687<br />issue_d_new: 16925.02<br />loan_status: Charged Off","count:  1923<br />issue_d_new: 16955.46<br />loan_status: Charged Off","count:  1863<br />issue_d_new: 16985.90<br />loan_status: Charged Off","count:  1846<br />issue_d_new: 17016.34<br />loan_status: Charged Off","count:  1642<br />issue_d_new: 17046.78<br />loan_status: Charged Off","count:  1092<br />issue_d_new: 17077.22<br />loan_status: Charged Off","count:   873<br />issue_d_new: 17107.66<br />loan_status: Charged Off","count:   720<br />issue_d_new: 17138.10<br />loan_status: Charged Off","count:   651<br />issue_d_new: 17168.54<br />loan_status: Charged Off","count:     0<br />issue_d_new: 17198.98<br />loan_status: Charged Off"],"type":"scatter","mode":"lines","line":{"width":3.77952755905512,"color":"rgba(248,118,109,0.8)","dash":"solid"},"hoveron":"points","name":"Charged Off","legendgroup":"Charged Off","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[1325557586440.68,1328187661016.95,1330817735593.22,1333447810169.49,1336077884745.76,1338707959322.03,1341338033898.3,1343968108474.58,1346598183050.85,1349228257627.12,1351858332203.39,1354488406779.66,1357118481355.93,1359748555932.2,1362378630508.47,1365008705084.75,1367638779661.02,1370268854237.29,1372898928813.56,1375529003389.83,1378159077966.1,1380789152542.37,1383419227118.64,1386049301694.92,1388679376271.19,1391309450847.46,1393939525423.73,1396569600000,1399199674576.27,1401829749152.54,1404459823728.81,1407089898305.08,1409719972881.36,1412350047457.63,1414980122033.9,1417610196610.17,1420240271186.44,1422870345762.71,1425500420338.98,1428130494915.25,1430760569491.53,1433390644067.8,1436020718644.07,1438650793220.34,1441280867796.61,1443910942372.88,1446541016949.15,1449171091525.42,1451801166101.7,1454431240677.97,1457061315254.24,1459691389830.51,1462321464406.78,1464951538983.05,1467581613559.32,1470211688135.59,1472841762711.86,1475471837288.14,1478101911864.41,1480731986440.68,1483362061016.95,1485992135593.22],"y":[0,2162,2139,2471,2734,2831,3103,3808,4534,5132,5262,5171,4945,5584,6107,6692,7476,8112,8549,9360,9903,10034,10831,11497,11687,12025,11482,12295,13948,13896,12191,20969,13566,7525,24904,11979,4806,15546,19745,0,13303,11815,9959,15664,11293,8797,14656,10541,11792,8271,9368,13742,7365,5481,6510,6524,6424,4831,5242,4679,4555,0],"text":["count:     0<br />issue_d_new: 15342.10<br />loan_status: Fully Paid","count:  2162<br />issue_d_new: 15372.54<br />loan_status: Fully Paid","count:  2139<br />issue_d_new: 15402.98<br />loan_status: Fully Paid","count:  2471<br />issue_d_new: 15433.42<br />loan_status: Fully Paid","count:  2734<br />issue_d_new: 15463.86<br />loan_status: Fully Paid","count:  2831<br />issue_d_new: 15494.31<br />loan_status: Fully Paid","count:  3103<br />issue_d_new: 15524.75<br />loan_status: Fully Paid","count:  3808<br />issue_d_new: 15555.19<br />loan_status: Fully Paid","count:  4534<br />issue_d_new: 15585.63<br />loan_status: Fully Paid","count:  5132<br />issue_d_new: 15616.07<br />loan_status: Fully Paid","count:  5262<br />issue_d_new: 15646.51<br />loan_status: Fully Paid","count:  5171<br />issue_d_new: 15676.95<br />loan_status: Fully Paid","count:  4945<br />issue_d_new: 15707.39<br />loan_status: Fully Paid","count:  5584<br />issue_d_new: 15737.83<br />loan_status: Fully Paid","count:  6107<br />issue_d_new: 15768.27<br />loan_status: Fully Paid","count:  6692<br />issue_d_new: 15798.71<br />loan_status: Fully Paid","count:  7476<br />issue_d_new: 15829.15<br />loan_status: Fully Paid","count:  8112<br />issue_d_new: 15859.59<br />loan_status: Fully Paid","count:  8549<br />issue_d_new: 15890.03<br />loan_status: Fully Paid","count:  9360<br />issue_d_new: 15920.47<br />loan_status: Fully Paid","count:  9903<br />issue_d_new: 15950.92<br />loan_status: Fully Paid","count: 10034<br />issue_d_new: 15981.36<br />loan_status: Fully Paid","count: 10831<br />issue_d_new: 16011.80<br />loan_status: Fully Paid","count: 11497<br />issue_d_new: 16042.24<br />loan_status: Fully Paid","count: 11687<br />issue_d_new: 16072.68<br />loan_status: Fully Paid","count: 12025<br />issue_d_new: 16103.12<br />loan_status: Fully Paid","count: 11482<br />issue_d_new: 16133.56<br />loan_status: Fully Paid","count: 12295<br />issue_d_new: 16164.00<br />loan_status: Fully Paid","count: 13948<br />issue_d_new: 16194.44<br />loan_status: Fully Paid","count: 13896<br />issue_d_new: 16224.88<br />loan_status: Fully Paid","count: 12191<br />issue_d_new: 16255.32<br />loan_status: Fully Paid","count: 20969<br />issue_d_new: 16285.76<br />loan_status: Fully Paid","count: 13566<br />issue_d_new: 16316.20<br />loan_status: Fully Paid","count:  7525<br />issue_d_new: 16346.64<br />loan_status: Fully Paid","count: 24904<br />issue_d_new: 16377.08<br />loan_status: Fully Paid","count: 11979<br />issue_d_new: 16407.53<br />loan_status: Fully Paid","count:  4806<br />issue_d_new: 16437.97<br />loan_status: Fully Paid","count: 15546<br />issue_d_new: 16468.41<br />loan_status: Fully Paid","count: 19745<br />issue_d_new: 16498.85<br />loan_status: Fully Paid","count:     0<br />issue_d_new: 16529.29<br />loan_status: Fully Paid","count: 13303<br />issue_d_new: 16559.73<br />loan_status: Fully Paid","count: 11815<br />issue_d_new: 16590.17<br />loan_status: Fully Paid","count:  9959<br />issue_d_new: 16620.61<br />loan_status: Fully Paid","count: 15664<br />issue_d_new: 16651.05<br />loan_status: Fully Paid","count: 11293<br />issue_d_new: 16681.49<br />loan_status: Fully Paid","count:  8797<br />issue_d_new: 16711.93<br />loan_status: Fully Paid","count: 14656<br />issue_d_new: 16742.37<br />loan_status: Fully Paid","count: 10541<br />issue_d_new: 16772.81<br />loan_status: Fully Paid","count: 11792<br />issue_d_new: 16803.25<br />loan_status: Fully Paid","count:  8271<br />issue_d_new: 16833.69<br />loan_status: Fully Paid","count:  9368<br />issue_d_new: 16864.14<br />loan_status: Fully Paid","count: 13742<br />issue_d_new: 16894.58<br />loan_status: Fully Paid","count:  7365<br />issue_d_new: 16925.02<br />loan_status: Fully Paid","count:  5481<br />issue_d_new: 16955.46<br />loan_status: Fully Paid","count:  6510<br />issue_d_new: 16985.90<br />loan_status: Fully Paid","count:  6524<br />issue_d_new: 17016.34<br />loan_status: Fully Paid","count:  6424<br />issue_d_new: 17046.78<br />loan_status: Fully Paid","count:  4831<br />issue_d_new: 17077.22<br />loan_status: Fully Paid","count:  5242<br />issue_d_new: 17107.66<br />loan_status: Fully Paid","count:  4679<br />issue_d_new: 17138.10<br />loan_status: Fully Paid","count:  4555<br />issue_d_new: 17168.54<br />loan_status: Fully Paid","count:     0<br />issue_d_new: 17198.98<br />loan_status: Fully Paid"],"type":"scatter","mode":"lines","line":{"width":3.77952755905512,"color":"rgba(0,191,196,0.8)","dash":"solid"},"hoveron":"points","name":"Fully Paid","legendgroup":"Fully Paid","showlegend":true,"xaxis":"x","yaxis":"y2","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":37.9178082191781,"r":18.9954337899543,"b":40.1826484018265,"l":48.9497716894977},"plot_bgcolor":"rgba(235,235,235,1)","paper_bgcolor":"rgba(255,255,255,1)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xaxis":{"domain":[0,1],"type":"linear","autorange":false,"tickmode":"array","range":[1316089317966.1,1495460404067.8],"ticktext":["2012","2014","2016"],"tickvals":[1325376000000,1388534400000,1451606400000],"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"y2","title":"","titlefont":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"hoverformat":".2f"},"annotations":[{"text":"issue_d_new","x":0.5,"y":-0.0471841704718417,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"top","annotationType":"axis"},{"text":"count","x":-0.0510980647966949,"y":0.5,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xref":"paper","yref":"paper","textangle":-90,"xanchor":"right","yanchor":"center","annotationType":"axis"},{"text":"Charged Off","x":1,"y":0.757610350076104,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(26,26,26,1)","family":"","size":11.689497716895},"xref":"paper","yref":"paper","textangle":90,"xanchor":"left","yanchor":"middle"},{"text":"Fully Paid","x":1,"y":0.242389649923896,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(26,26,26,1)","family":"","size":11.689497716895},"xref":"paper","yref":"paper","textangle":90,"xanchor":"left","yanchor":"middle"},{"text":"loan_status","x":1.02,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"left","yanchor":"bottom","legendTitle":true}],"yaxis":{"domain":[0.515220700152207,1],"type":"linear","autorange":false,"tickmode":"array","range":[-350.45,7359.45],"ticktext":["0","2000","4000","6000"],"tickvals":[0,2000,4000,6000],"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"x","title":"","titlefont":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0.515220700152207,"y1":1},{"type":"rect","fillcolor":"rgba(217,217,217,1)","line":{"color":"transparent","width":0.66417600664176,"linetype":"solid"},"yref":"paper","xref":"paper","x0":1,"x1":1.04949381327334,"y0":0.515220700152207,"y1":1},{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":0.484779299847793},{"type":"rect","fillcolor":"rgba(217,217,217,1)","line":{"color":"transparent","width":0.66417600664176,"linetype":"solid"},"yref":"paper","xref":"paper","x0":1,"x1":1.04949381327334,"y0":0,"y1":0.484779299847793}],"yaxis2":{"type":"linear","autorange":false,"tickmode":"array","range":[-1245.2,26149.2],"ticktext":["0","5000","10000","15000","20000","25000"],"tickvals":[0,5000,10000,15000,20000,25000],"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"domain":[0,0.484779299847793],"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"x","title":"","titlefont":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"hoverformat":".2f"},"showlegend":true,"legend":{"bgcolor":"rgba(255,255,255,1)","bordercolor":"transparent","borderwidth":1.88976377952756,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.689497716895},"y":0.913385826771654},"hovermode":"closest"},"source":"A","attrs":{"3388355872ae":{"x":{},"colour":{},"type":"ggplotly"}},"cur_data":"3388355872ae","visdat":{"3388355872ae":["function (y) ","x"]},"config":{"modeBarButtonsToAdd":[{"name":"Collaborate","icon":{"width":1000,"ascent":500,"descent":-50,"path":"M487 375c7-10 9-23 5-36l-79-259c-3-12-11-23-22-31-11-8-22-12-35-12l-263 0c-15 0-29 5-43 15-13 10-23 23-28 37-5 13-5 25-1 37 0 0 0 3 1 7 1 5 1 8 1 11 0 2 0 4-1 6 0 3-1 5-1 6 1 2 2 4 3 6 1 2 2 4 4 6 2 3 4 5 5 7 5 7 9 16 13 26 4 10 7 19 9 26 0 2 0 5 0 9-1 4-1 6 0 8 0 2 2 5 4 8 3 3 5 5 5 7 4 6 8 15 12 26 4 11 7 19 7 26 1 1 0 4 0 9-1 4-1 7 0 8 1 2 3 5 6 8 4 4 6 6 6 7 4 5 8 13 13 24 4 11 7 20 7 28 1 1 0 4 0 7-1 3-1 6-1 7 0 2 1 4 3 6 1 1 3 4 5 6 2 3 3 5 5 6 1 2 3 5 4 9 2 3 3 7 5 10 1 3 2 6 4 10 2 4 4 7 6 9 2 3 4 5 7 7 3 2 7 3 11 3 3 0 8 0 13-1l0-1c7 2 12 2 14 2l218 0c14 0 25-5 32-16 8-10 10-23 6-37l-79-259c-7-22-13-37-20-43-7-7-19-10-37-10l-248 0c-5 0-9-2-11-5-2-3-2-7 0-12 4-13 18-20 41-20l264 0c5 0 10 2 16 5 5 3 8 6 10 11l85 282c2 5 2 10 2 17 7-3 13-7 17-13z m-304 0c-1-3-1-5 0-7 1-1 3-2 6-2l174 0c2 0 4 1 7 2 2 2 4 4 5 7l6 18c0 3 0 5-1 7-1 1-3 2-6 2l-173 0c-3 0-5-1-8-2-2-2-4-4-4-7z m-24-73c-1-3-1-5 0-7 2-2 3-2 6-2l174 0c2 0 5 0 7 2 3 2 4 4 5 7l6 18c1 2 0 5-1 6-1 2-3 3-5 3l-174 0c-3 0-5-1-7-3-3-1-4-4-5-6z"},"click":"function(gd) { \n        // is this being viewed in RStudio?\n        if (location.search == '?viewer_pane=1') {\n          alert('To learn about plotly for collaboration, visit:\\n https://cpsievert.github.io/plotly_book/plot-ly-for-collaboration.html');\n        } else {\n          window.open('https://cpsievert.github.io/plotly_book/plot-ly-for-collaboration.html', '_blank');\n        }\n      }"}],"cloud":false},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1}},"base_url":"https://plot.ly"},"evals":["config.modeBarButtonsToAdd.0.click"],"jsHooks":{"render":[{"code":"function(el, x) { var ctConfig = crosstalk.var('plotlyCrosstalkOpts').set({\"on\":\"plotly_click\",\"persistent\":false,\"dynamic\":false,\"selectize\":false,\"opacityDim\":0.2,\"selected\":{\"opacity\":1}}); }","data":null}]}}</script> The trends of number of fully paid and charged off loan are very similar over the year 2013 t0 2016.This is the decision that already made by the lender, so it can’t be use as a predictor.</p>
</div>
<div id="earliest_cr_line-and-last_credit_pull_d" class="section level3">
<h3><span class="header-section-number">2.5.2</span> earliest_cr_line and last_credit_pull_d</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(zoo)
temp &lt;-<span class="st"> </span><span class="kw">as.yearmon</span>(dat<span class="op">$</span>earliest_cr_line,<span class="st">&quot;%b-%Y&quot;</span>) 
dat &lt;-<span class="st"> </span>dat<span class="op">%&gt;%</span><span class="kw">mutate</span>(<span class="dt">ecl.mon=</span><span class="kw">month</span>(temp),<span class="dt">ecl.year=</span> <span class="kw">year</span>(temp))

temp &lt;-<span class="st"> </span><span class="kw">as.yearmon</span>(dat<span class="op">$</span>last_credit_pull_d,<span class="st">&quot;%b-%Y&quot;</span>) 
dat &lt;-<span class="st"> </span>dat<span class="op">%&gt;%</span><span class="kw">mutate</span>(<span class="dt">lcl.mon=</span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(<span class="kw">month</span>(temp)),<span class="dv">0</span>,<span class="kw">month</span>(temp)),<span class="dt">lcl.year=</span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(<span class="kw">year</span>(temp)),<span class="dv">0</span>,<span class="kw">year</span>(temp)))
var.drop &lt;-<span class="st"> </span><span class="kw">c</span>(var.drop,<span class="st">&quot;last_credit_pull_d&quot;</span>,<span class="st">&quot;earliest_cr_line&quot;</span>,<span class="st">&quot;issue_d&quot;</span>)</code></pre></div>
</div>
</div>
<div id="final-model-data-preparation" class="section level2">
<h2><span class="header-section-number">2.6</span> Final Model data Preparation</h2>
<p>In this section, data for modeling is prepared by replacing imputed data fields into the existing, dropping features that are not used.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat.train.imp &lt;-<span class="st"> </span><span class="kw">cbind</span>(dat.train.imp,dat.train.imp2)
dat.train&lt;-dat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(year<span class="op">&lt;</span><span class="dv">3</span>)<span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">select</span>(<span class="kw">which</span>(<span class="op">!</span><span class="kw">names</span>(.)<span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="kw">names</span>(dat.train.imp),var.drop)))<span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">cbind</span>(.,dat.train.imp)
<span class="co">#dat.train &lt;-data.table(dat)[year&lt;3]</span>
dat.train<span class="op">$</span>ZIP3_mean &lt;-ZIP3_mean
dat.train<span class="op">$</span>emp_title_mean &lt;-emp_title_mean
dat.train<span class="op">$</span>state_mean &lt;-state_mean
dat.train &lt;-<span class="st"> </span><span class="kw">data.table</span>(dat.train)[,<span class="kw">c</span>(<span class="st">&quot;id&quot;</span>,<span class="st">&quot;loan_status&quot;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]

dat.train &lt;-<span class="st"> </span>dat.train <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(y, <span class="kw">everything</span>()) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">mutate_at</span>(<span class="st">&quot;y&quot;</span>,<span class="kw">funs</span>(<span class="kw">as.factor</span>(.)))<span class="co">#move DV to the first</span>
<span class="co">#dat.train &lt;-as.data.frame(unclass(dat.train))</span>
##Check any na in the data set
<span class="kw">sum</span>(<span class="kw">is.na</span>(dat.train))</code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(dat.train)</code></pre></div>
<pre><code>## &#39;data.frame&#39;:    570081 obs. of  97 variables:
##  $ y                             : Factor w/ 2 levels &quot;0&quot;,&quot;1&quot;: 1 1 1 1 1 2 1 1 1 1 ...
##  $ loan_amnt                     : int  10000 20800 7550 28000 12000 27600 11100 12000 9750 3000 ...
##  $ funded_amnt                   : int  10000 20800 7550 28000 12000 27600 11100 12000 9750 3000 ...
##  $ funded_amnt_inv               : num  10000 20800 7550 28000 12000 27600 11100 12000 9750 3000 ...
##  $ term                          : Factor w/ 2 levels &quot;36&quot;,&quot;60&quot;: 1 1 1 1 1 2 1 1 1 1 ...
##  $ int_rate                      : num  9.67 13.53 16.24 7.62 11.99 ...
##  $ installment                   : num  321 706 266 873 399 ...
##  $ grade                         : Factor w/ 7 levels &quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;,..: 2 2 3 1 2 4 3 2 3 2 ...
##  $ sub_grade                     : Factor w/ 35 levels &quot;A1&quot;,&quot;A2&quot;,&quot;A3&quot;,..: 6 10 15 3 8 20 13 10 11 9 ...
##  $ home_ownership                : Factor w/ 6 levels &quot;ANY&quot;,&quot;MORTGAGE&quot;,..: 2 6 6 2 2 2 2 6 6 6 ...
##  $ annual_inc                    : num  102000 81500 28000 325000 130000 73000 90000 40000 26000 25000 ...
##  $ verification_status           : Factor w/ 3 levels &quot;Not Verified&quot;,..: 1 3 1 2 2 2 1 2 1 3 ...
##  $ purpose                       : Factor w/ 14 levels &quot;car&quot;,&quot;credit_card&quot;,..: 3 3 3 3 3 3 10 3 3 3 ...
##  $ delinq_2yrs                   : int  2 0 0 0 0 1 1 0 0 0 ...
##  $ fico_range_low                : int  670 685 660 745 715 665 690 660 670 660 ...
##  $ fico_range_high               : int  674 689 664 749 719 669 694 664 674 664 ...
##  $ open_acc                      : int  9 29 4 15 9 10 9 7 12 5 ...
##  $ pub_rec                       : int  0 0 0 0 0 0 0 2 0 2 ...
##  $ revol_bal                     : int  9912 23473 5759 29581 10805 27003 6619 5572 7967 2875 ...
##  $ total_acc                     : int  22 41 5 31 19 24 12 32 28 26 ...
##  $ initial_list_status           : Factor w/ 2 levels &quot;f&quot;,&quot;w&quot;: 1 1 2 2 1 1 1 2 1 1 ...
##  $ last_fico_range_high          : int  629 629 599 789 724 579 724 739 689 569 ...
##  $ last_fico_range_low           : int  625 625 595 785 720 575 720 735 685 565 ...
##  $ collections_12_mths_ex_med    : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ application_type              : Factor w/ 4 levels &quot;DIRECT_PAY&quot;,&quot;Individual&quot;,..: 2 2 2 2 2 2 2 2 2 2 ...
##  $ acc_now_delinq                : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ chargeoff_within_12_mths      : int  0 0 0 0 0 1 0 0 0 0 ...
##  $ delinq_amnt                   : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ pub_rec_bankruptcies          : int  0 0 0 0 0 0 0 0 0 2 ...
##  $ tax_liens                     : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ year                          : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ desc_flag                     : Factor w/ 2 levels &quot;0&quot;,&quot;1&quot;: 1 2 1 1 1 2 1 1 2 1 ...
##  $ joint_flag                    : Factor w/ 2 levels &quot;0&quot;,&quot;1&quot;: 1 1 1 1 1 1 1 1 1 1 ...
##  $ ecl.mon                       : num  10 6 10 11 11 6 6 10 1 5 ...
##  $ ecl.year                      : num  1989 1998 2010 1994 1997 ...
##  $ lcl.mon                       : num  12 10 10 8 10 10 8 7 10 10 ...
##  $ lcl.year                      : num  2016 2017 2017 2014 2017 ...
##  $ tot_coll_amt                  : Factor w/ 3 levels &quot;0&quot;,&quot;1&quot;,&quot;2&quot;: 2 2 2 2 2 2 2 3 2 3 ...
##  $ num_accts_ever_120_pd         : Factor w/ 3 levels &quot;0&quot;,&quot;1&quot;,&quot;2&quot;: 3 3 2 2 2 3 3 3 2 3 ...
##  $ num_tl_120dpd_2m              : Factor w/ 3 levels &quot;0&quot;,&quot;1&quot;,&quot;2&quot;: 2 2 2 2 1 2 2 2 2 2 ...
##  $ num_tl_30dpd                  : Factor w/ 3 levels &quot;0&quot;,&quot;1&quot;,&quot;2&quot;: 2 2 2 2 2 2 2 2 2 2 ...
##  $ num_tl_90g_dpd_24m            : Factor w/ 3 levels &quot;0&quot;,&quot;1&quot;,&quot;2&quot;: 2 2 2 2 2 3 3 2 2 2 ...
##  $ mths_since_last_record        : Factor w/ 5 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,..: 1 1 1 1 1 1 1 2 1 3 ...
##  $ mths_since_recent_inq         : Factor w/ 5 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,..: 4 2 5 3 3 4 5 5 5 4 ...
##  $ il_util                       : Factor w/ 5 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ num_rev_accts                 : Factor w/ 5 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,..: 3 5 2 4 2 4 3 5 5 3 ...
##  $ pct_tl_nvr_dlq                : Factor w/ 4 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;5&quot;: 2 2 4 4 4 2 2 2 4 2 ...
##  $ mths_since_recent_bc          : Factor w/ 5 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,..: 4 2 4 2 5 2 3 3 3 4 ...
##  $ mths_since_rcnt_il            : Factor w/ 5 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ tot_hi_cred_lim               : Factor w/ 5 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,..: 3 2 2 5 5 5 5 2 2 2 ...
##  $ bc_open_to_buy                : Factor w/ 5 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,..: 2 4 2 5 3 4 2 3 3 3 ...
##  $ mths_since_recent_bc_dlq      : Factor w/ 3 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;: 2 3 1 1 1 2 2 3 1 3 ...
##  $ mths_since_recent_revol_delinq: Factor w/ 3 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;: 2 3 1 1 1 2 3 3 1 3 ...
##  $ mths_since_last_major_derog   : Factor w/ 3 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;: 3 3 1 1 1 2 2 3 1 3 ...
##  $ mths_since_last_delinq        : Factor w/ 3 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;: 2 3 1 1 1 2 2 3 1 3 ...
##  $ mo_sin_old_rev_tl_op          : Factor w/ 3 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;: 3 3 2 3 3 3 2 3 2 3 ...
##  $ num_rev_tl_bal_gt_0           : Factor w/ 3 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;: 2 3 2 3 3 3 3 2 3 2 ...
##  $ mo_sin_old_il_acct            : Factor w/ 3 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;: 3 2 1 2 3 3 1 2 2 3 ...
##  $ total_bc_limit                : Factor w/ 3 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;: 2 3 2 3 2 3 2 2 2 2 ...
##  $ avg_cur_bal                   : Factor w/ 3 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;: 2 2 2 3 3 3 3 2 2 2 ...
##  $ total_bal_ex_mort             : Factor w/ 3 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;: 3 2 2 3 3 3 2 2 2 2 ...
##  $ max_bal_bc                    : Factor w/ 3 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;: 1 1 1 1 1 1 1 1 1 1 ...
##  $ total_rev_hi_lim              : Factor w/ 3 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;: 2 3 2 3 2 3 2 2 2 2 ...
##  $ num_actv_rev_tl               : Factor w/ 4 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;: 2 4 2 3 3 3 3 2 3 2 ...
##  $ open_rv_12m                   : Factor w/ 4 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;: 1 1 1 1 1 1 1 1 1 1 ...
##  $ inq_fi                        : Factor w/ 4 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;: 1 1 1 1 1 1 1 1 1 1 ...
##  $ open_rv_24m                   : Factor w/ 4 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;: 1 1 1 1 1 1 1 1 1 1 ...
##  $ num_il_tl                     : Factor w/ 4 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;: 3 2 2 3 3 2 2 3 3 3 ...
##  $ total_cu_tl                   : Factor w/ 3 levels &quot;1&quot;,&quot;3&quot;,&quot;4&quot;: 1 1 1 1 1 1 1 1 1 1 ...
##  $ num_bc_sats                   : Factor w/ 4 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;: 2 4 2 3 3 3 3 2 3 2 ...
##  $ open_il_6m                    : Factor w/ 4 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;: 1 1 1 1 1 1 1 1 1 1 ...
##  $ open_il_24m                   : Factor w/ 4 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;: 1 1 1 1 1 1 1 1 1 1 ...
##  $ mo_sin_rcnt_rev_tl_op         : Factor w/ 4 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;: 3 2 3 2 2 2 3 2 3 2 ...
##  $ mo_sin_rcnt_tl                : Factor w/ 4 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;: 3 2 3 2 2 2 3 2 3 3 ...
##  $ total_il_high_credit_limit    : Factor w/ 4 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;: 3 2 2 4 3 2 2 2 2 2 ...
##  $ emp_length                    : num  7 10 3 5 10 6 10 10 1 10 ...
##  $ percent_bc_gt_75              : num  66.7 50 100 16.7 1 80 50 33.3 66.7 66.7 ...
##  $ all_util                      : num  62 62 62 62 62 62 62 62 62 62 ...
##  $ bc_util                       : num  89.4 54.6 96 67.1 93 74.7 74.6 79.6 75.7 52.3 ...
##  $ inq_last_6mths                : int  0 2 0 1 1 1 0 0 0 0 ...
##  $ open_acc_6m                   : num  1 1 1 1 1 1 1 1 1 1 ...
##  $ num_actv_bc_tl                : int  3 8 2 4 3 5 4 2 6 2 ...
##  $ inq_last_12m                  : num  2 2 2 2 2 2 2 2 2 2 ...
##  $ num_bc_tl                     : int  6 17 2 8 4 11 4 14 11 6 ...
##  $ acc_open_past_24mths          : num  3 9 1 6 4 2 2 4 2 3 ...
##  $ num_sats                      : num  9 29 4 15 9 10 9 7 12 5 ...
##  $ num_tl_op_past_12m            : int  1 3 0 5 3 1 1 2 2 1 ...
##  $ num_op_rev_tl                 : int  6 29 4 9 5 7 8 6 9 4 ...
##  $ mort_acc                      : num  0 0 0 5 3 4 1 0 0 6 ...
##  $ revol_util                    : num  44.4 54.5 72 54.6 67 82.8 66.2 68.8 52.8 54.2 ...
##  $ open_il_12m                   : num  1 1 1 1 1 1 1 1 1 1 ...
##  $ total_bal_il                  : num  25553 25553 25553 25553 25553 ...
##  $ tot_cur_bal                   : int  39143 23473 5759 799592 327264 241609 353402 13605 14123 19530 ...
##  $ dti                           : num  15.6 16.7 8.4 18.6 13 ...
##  $ ZIP3_mean                     : num  0.205 0.178 0.19 0.179 0.191 ...
##  $ emp_title_mean                : num  0.20132 0.20059 0.15037 0.31944 0.00976 ...
##  $ state_mean                    : num  0.196 0.227 0.195 0.195 0.159 ...</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#saveRDS(dat.train,&quot;modeldata.rds&quot;)</span>
###Test
dat.test.imp &lt;-<span class="st"> </span><span class="kw">cbind</span>(dat.test.imp,dat.test.imp2)
dat.test&lt;-<span class="kw">data.table</span>(dat)[year<span class="op">==</span><span class="dv">3</span>]<span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">select</span>(<span class="kw">which</span>(<span class="op">!</span><span class="kw">names</span>(.)<span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(dat.test.imp)))<span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">select</span>(<span class="kw">which</span>(<span class="op">!</span><span class="kw">names</span>(.)<span class="op">%in%</span><span class="st"> </span>var.drop))<span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">cbind</span>(.,dat.test.imp)

dat.test<span class="op">$</span>ZIP3_mean &lt;-ZIP3_mean.ts
dat.test<span class="op">$</span>emp_title_mean &lt;-emp_title_mean.ts
dat.test<span class="op">$</span>state_mean &lt;-state_mean.ts
dat.test &lt;-<span class="st"> </span><span class="kw">data.table</span>(dat.test)[,<span class="kw">c</span>(<span class="st">&quot;id&quot;</span>,<span class="st">&quot;loan_status&quot;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
dat.test &lt;-<span class="st"> </span>dat.test <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(y, <span class="kw">everything</span>()) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">mutate_at</span>(<span class="st">&quot;y&quot;</span>,<span class="kw">funs</span>(<span class="kw">as.factor</span>(.)))<span class="co">#move DV to the first</span>
<span class="co">#dat.test &lt;- as.data.frame(unclass(dat.test))</span>
<span class="co">#saveRDS(dat.test,&quot;testdata.rds&quot;)</span>
<span class="kw">sum</span>(<span class="kw">is.na</span>(dat.test))</code></pre></div>
<pre><code>## [1] 0</code></pre>
</div>
</div>
<div id="build-prediction-model-on-past-loan" class="section level1">
<h1><span class="header-section-number">3</span> Build Prediction Model on Past Loan</h1>
<div id="regularized-glm" class="section level2">
<h2><span class="header-section-number">3.1</span> Regularized GLM</h2>
<div id="one-hot-encoding-for-nomial-variables" class="section level3">
<h3><span class="header-section-number">3.1.1</span> One hot encoding for nomial variables</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat.train <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sapply</span>(.,is.factor) <span class="op">%&gt;%</span><span class="kw">as.data.frame</span>(.)-&gt;list
#####Take 1/10 to test
<span class="co">#set.seed(310)</span>
<span class="co">#n=dim(dat.train)[1]</span>
<span class="co">#dat.train &lt;- dat.train[sample(n,round(n/10))]</span>
ohe_feats =<span class="st"> </span><span class="kw">row.names</span>(<span class="kw">subset</span>(list,list[,<span class="dv">1</span>]<span class="op">==</span><span class="ot">TRUE</span>))
ohe_feats =<span class="st"> </span>ohe_feats[<span class="op">-</span><span class="dv">1</span>] ##exclude dv y
num_feats =<span class="st"> </span><span class="kw">row.names</span>(<span class="kw">subset</span>(list,list[,<span class="dv">1</span>]<span class="op">==</span><span class="ot">FALSE</span>))
num_feats =<span class="st"> </span>num_feats[<span class="dv">2</span><span class="op">:</span><span class="kw">length</span>(num_feats)]

<span class="cf">for</span> (f <span class="cf">in</span> ohe_feats){
  dat.dummy &lt;-<span class="st"> </span><span class="kw">with</span>(dat.train,
       <span class="kw">data.frame</span>(<span class="kw">model.matrix</span>(<span class="op">~</span><span class="kw">get</span>(f)<span class="op">-</span><span class="dv">1</span>,dat.train)))
       <span class="kw">names</span>(dat.dummy) &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;get.f&quot;</span>,f,<span class="kw">names</span>(dat.dummy)) 
       dat.train =<span class="st"> </span><span class="kw">cbind</span>(dat.train, dat.dummy)
}
dat.train &lt;-<span class="st"> </span><span class="kw">data.table</span>(dat.train)[,ohe_feats[<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(ohe_feats)]<span class="op">:</span><span class="er">=</span><span class="ot">NULL</span>]

<span class="cf">for</span> (f <span class="cf">in</span> ohe_feats){
  dat.dummy &lt;-<span class="st"> </span><span class="kw">with</span>(dat.test,
       <span class="kw">data.frame</span>(<span class="kw">model.matrix</span>(<span class="op">~</span><span class="kw">get</span>(f)<span class="op">-</span><span class="dv">1</span>,dat.test)))
       <span class="kw">names</span>(dat.dummy) &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;get.f&quot;</span>,f,<span class="kw">names</span>(dat.dummy)) 
       dat.test =<span class="st"> </span><span class="kw">cbind</span>(dat.test, dat.dummy)
}
dat.test &lt;-<span class="st"> </span><span class="kw">data.table</span>(dat.test)[,ohe_feats[<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(ohe_feats)]<span class="op">:</span><span class="er">=</span><span class="ot">NULL</span>]

<span class="kw">dim</span>(dat.train)[<span class="dv">2</span>] </code></pre></div>
<pre><code>## [1] 268</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dim</span>(dat.test)[<span class="dv">2</span>]</code></pre></div>
<pre><code>## [1] 250</code></pre>
<p>After changing all nomial variables to dummy variables, now we have 268 variables. Comparing to the n with 570081, the number of predictors is acceptable. I didn’t do any feature selection based on their colinearility before building a model. So it will be better to use lasso regularized general linear regression, which will decrease the number of feature when fitting. Note that when doing one-hot encoding for test set, there are only 250 variables.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">setdiff</span>(<span class="kw">names</span>(dat.train),<span class="kw">names</span>(dat.test))</code></pre></div>
<pre><code>##  [1] &quot;tot_coll_amt.0&quot;               &quot;num_accts_ever_120_pd.0&quot;     
##  [3] &quot;num_tl_30dpd.0&quot;               &quot;num_tl_90g_dpd_24m.0&quot;        
##  [5] &quot;num_rev_accts.1&quot;              &quot;pct_tl_nvr_dlq.1&quot;            
##  [7] &quot;tot_hi_cred_lim.1&quot;            &quot;mo_sin_old_rev_tl_op.1&quot;      
##  [9] &quot;num_rev_tl_bal_gt_0.1&quot;        &quot;total_bc_limit.1&quot;            
## [11] &quot;avg_cur_bal.1&quot;                &quot;total_bal_ex_mort.1&quot;         
## [13] &quot;total_rev_hi_lim.1&quot;           &quot;num_actv_rev_tl.1&quot;           
## [15] &quot;num_il_tl.1&quot;                  &quot;num_bc_sats.1&quot;               
## [17] &quot;mo_sin_rcnt_rev_tl_op.1&quot;      &quot;mo_sin_rcnt_tl.1&quot;            
## [19] &quot;total_il_high_credit_limit.1&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">setdiff</span>(<span class="kw">names</span>(dat.test),<span class="kw">names</span>(dat.train))</code></pre></div>
<pre><code>## [1] &quot;pct_tl_nvr_dlq.4&quot;</code></pre>
<p>There are 19 variables in the trainning set, but not in test set. While one variable in test set that haven’t been seen in trainning set. One-hot encoding can handle this situation automatically. ###L1 Regulized Logistic Classifier I used h2o platform.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(h2o)
<span class="kw">h2o.init</span>(<span class="dt">nthreads=</span><span class="op">-</span><span class="dv">1</span>,<span class="dt">min_mem_size =</span><span class="st">&quot;10g&quot;</span>,<span class="dt">max_mem_size =</span> <span class="st">&quot;20g&quot;</span>)

tr.hex &lt;-<span class="st"> </span><span class="kw">as.h2o</span>(dat.train, <span class="dt">destination_frame=</span><span class="st">&quot;tr.hex&quot;</span>)
splits &lt;-<span class="st"> </span><span class="kw">h2o.splitFrame</span>(
  tr.hex,           ##  splitting the H2O frame we read above
  <span class="fl">0.7</span>,   ##  create splits of 70% and 30%; 
                ##  H2O will create one more split of 1-(sum of these parameters)
  <span class="dt">seed=</span><span class="dv">310</span>)    ##  setting a seed will ensure reproducible results (not R&#39;s seed)

train &lt;-<span class="st"> </span><span class="kw">h2o.assign</span>(splits[[<span class="dv">1</span>]], <span class="st">&quot;train.hex&quot;</span>)   
valid &lt;-<span class="st"> </span><span class="kw">h2o.assign</span>(splits[[<span class="dv">2</span>]], <span class="st">&quot;valid.hex&quot;</span>)   

te.hex &lt;-<span class="st"> </span><span class="kw">as.h2o</span>(dat.test, <span class="dt">destination_frame=</span><span class="st">&quot;te.hex&quot;</span>)
glm.base &lt;-<span class="st"> </span><span class="kw">h2o.glm</span>(<span class="dt">x=</span><span class="dv">2</span><span class="op">:</span><span class="dv">268</span>, <span class="dt">y=</span><span class="dv">1</span>, 
               <span class="dt">training_frame =</span> train, 
               <span class="dt">validation_frame =</span> valid, 
               <span class="dt">model_id =</span> <span class="st">&quot;h2o.glm1&quot;</span>, 
               <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>,
               <span class="dt">link =</span> <span class="st">&quot;logit&quot;</span>,
               <span class="dt">alpha =</span> <span class="fl">0.1</span>,
               <span class="dt">lambda_search =</span> <span class="ot">TRUE</span>,
               <span class="dt">standardize =</span> <span class="ot">TRUE</span>)
<span class="co">#mdl</span>
perf &lt;-<span class="st"> </span><span class="kw">h2o.performance</span>(glm.base,<span class="dt">valid=</span><span class="ot">TRUE</span>)
<span class="kw">h2o.auc</span>(perf)
<span class="co">#[1] 0.9698663</span></code></pre></div>
</div>
<div id="grid-search-for-alpha" class="section level3">
<h3><span class="header-section-number">3.1.2</span> Grid Search for alpha</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hyper_params &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">alpha =</span> <span class="kw">c</span>(<span class="dv">0</span>, .<span class="dv">01</span>, .<span class="dv">2</span>, .<span class="dv">5</span>, .<span class="dv">75</span>))

<span class="co"># this example uses cartesian grid search because the search space is small</span>
<span class="co"># and we want to see the performance of all models. For a larger search space use</span>
<span class="co"># random grid search instead: {&#39;strategy&#39;: &quot;RandomDiscrete&quot;}</span>

<span class="co"># build grid search with previously selected hyperparameters</span>
glm.grid &lt;-<span class="st"> </span><span class="kw">h2o.grid</span>(<span class="dt">x =</span> <span class="dv">2</span><span class="op">:</span><span class="dv">268</span>, 
                 <span class="dt">y =</span> <span class="dv">1</span>, 
                 <span class="dt">training_frame =</span> train, 
                 <span class="dt">validation_frame =</span> valid,
                 <span class="dt">algorithm =</span> <span class="st">&quot;glm&quot;</span>, 
                 <span class="dt">grid_id =</span> <span class="st">&quot;glm_grid&quot;</span>, 
                 <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>,
                 <span class="dt">link =</span> <span class="st">&quot;logit&quot;</span>,
                 <span class="dt">lambda_search =</span> <span class="ot">TRUE</span>,
                 <span class="dt">standardize =</span> <span class="ot">TRUE</span>,
                 <span class="dt">hyper_params =</span> hyper_params 
                 )

<span class="co"># Sort the grid models by mse</span>
sortedGrid &lt;-<span class="st"> </span><span class="kw">h2o.getGrid</span>(<span class="st">&quot;glm_grid&quot;</span>, <span class="dt">sort_by =</span> <span class="st">&quot;auc&quot;</span>, <span class="dt">decreasing =</span> <span class="ot">TRUE</span>)
sortedGrid

<span class="co"># H2O Grid Details</span>
<span class="co"># ================</span>
<span class="co"># </span>
<span class="co"># Grid ID: glm_grid </span>
<span class="co"># Used hyper parameters: </span>
<span class="co">#   -  alpha </span>
<span class="co"># Number of models: 5 </span>
<span class="co"># Number of failed models: 0 </span>
<span class="co"># </span>
<span class="co"># Hyper-Parameter Search Summary: ordered by decreasing auc</span>
<span class="co">#    alpha        model_ids                auc</span>
<span class="co"># 1  [0.2] glm_grid_model_2 0.9698849577846405</span>
<span class="co"># 2  [0.5] glm_grid_model_3 0.9698763708880743</span>
<span class="co"># 3  [0.0] glm_grid_model_0 0.9698738761283971</span>
<span class="co"># 4 [0.01] glm_grid_model_1 0.9696412545468338</span>
<span class="co"># 5 [0.75] glm_grid_model_4 0.9687404078713304</span></code></pre></div>
<p>It looks like changing alpha doesn’t improve the performance. I’m going to switch gear and use random forest and gradiant boosting model (GBM) ##Random forest ###Default Setup Machine learning algorithms in h2o, like random forest and GBM have build-in encoding methods for catergorical variables, including binary, one-hot and mean responding etc. I’m going to use the data set before encoding for glm.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat.train &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;modeldata.rds&quot;</span>)
dat.test &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;testdata.rds&quot;</span>)
<span class="kw">dim</span>(dat.train)</code></pre></div>
<pre><code>## [1] 570081     97</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tr.hex &lt;-<span class="st"> </span><span class="kw">as.h2o</span>(dat.train, <span class="dt">destination_frame=</span><span class="st">&quot;tr.hex&quot;</span>)
splits &lt;-<span class="st"> </span><span class="kw">h2o.splitFrame</span>(
  tr.hex,           ##  splitting the H2O frame we read above
  <span class="fl">0.7</span>,   ##  create splits of 70% and 30%; 
                ##  H2O will create one more split of 1-(sum of these parameters)
  <span class="dt">seed=</span><span class="dv">310</span>)    ##  setting a seed will ensure reproducible results (not R&#39;s seed)

train &lt;-<span class="st"> </span><span class="kw">h2o.assign</span>(splits[[<span class="dv">1</span>]], <span class="st">&quot;train.hex&quot;</span>)   
valid &lt;-<span class="st"> </span><span class="kw">h2o.assign</span>(splits[[<span class="dv">2</span>]], <span class="st">&quot;valid.hex&quot;</span>)   

te.hex &lt;-<span class="st"> </span><span class="kw">as.h2o</span>(dat.test, <span class="dt">destination_frame=</span><span class="st">&quot;te.hex&quot;</span>)

rf1 &lt;-<span class="st"> </span><span class="kw">h2o.randomForest</span>(         ## h2o.randomForest function
  <span class="dt">training_frame =</span> train,        ## the H2O frame for training
  <span class="dt">validation_frame =</span> valid,      ## the H2O frame for validation (not required)
  <span class="dt">x=</span><span class="dv">2</span><span class="op">:</span><span class="dv">97</span>,                        ## the predictor columns, by column index
  <span class="dt">y=</span><span class="dv">1</span>,                          ## the target index (what we are predicting)
  <span class="dt">model_id =</span> <span class="st">&quot;rf_v1&quot;</span>,    ## name the model in H2O
                                 ##   not required, but helps use Flow
  <span class="dt">ntrees =</span> <span class="dv">200</span>,                  ## use a maximum of 200 trees to create the
                                 ##  random forest model. The default is 50.
                                 ##  I have increased it because I will let 
                                 ##  the early stopping criteria decide when
                                 ##  the random forest is sufficiently accurate
  <span class="dt">stopping_rounds =</span> <span class="dv">2</span>,           ## Stop fitting new trees when the 2-tree
                                 ##  average is within 0.001 (default) of 
                                 ##  the prior two 2-tree averages.
                                 ##  Can be thought of as a convergence setting
  <span class="dt">score_each_iteration =</span> T,      ## Predict against training and validation for
                                 ##  each tree. Default will skip several.
 <span class="dt">categorical_encoding =</span> 
         <span class="st">&quot;SortByResponse&quot;</span>,
 <span class="dt">seed =</span> <span class="dv">310</span>)                     ## Set the random seed so that this can be
                                 ##  reproduced.
###############################################################################
<span class="kw">summary</span>(rf1)                     ## View information about the model.
                                 ## Keys to look for are validation performance
                                 ##  and variable importance
##Here are some of the results
<span class="co"># H2OBinomialMetrics: drf</span>
<span class="co"># ** Reported on validation data. **</span>
<span class="co"># </span>
<span class="co"># MSE:  0.0433079</span>
<span class="co"># RMSE:  0.2081055</span>
<span class="co"># LogLoss:  0.1552396</span>
<span class="co"># Mean Per-Class Error:  0.0781748</span>
<span class="co"># AUC:  0.9764058</span>
<span class="co"># Gini:  0.9528116</span>
<span class="co"># </span>
<span class="co"># Confusion Matrix (vertical: actual; across: predicted) for F1-optimal threshold:</span>
<span class="co">#             0     1    Error          Rate</span>
<span class="co"># 0      130302  5351 0.039446  =5351/135653</span>
<span class="co"># 1        4124 31153 0.116903   =4124/35277</span>
<span class="co"># Totals 134426 36504 0.055432  =9475/170930</span>
<span class="co"># </span>
<span class="co"># Gains/Lift Table: Extract with `h2o.gainsLift(&lt;model&gt;, &lt;data&gt;)` or `h2o.gainsLift(&lt;model&gt;, valid=&lt;T/F&gt;, xval=&lt;T/F&gt;)`</span>
<span class="co"># </span>
<span class="co"># </span>
<span class="co"># Scoring History: </span>
<span class="co">#             timestamp   duration number_of_trees training_rmse training_logloss training_auc</span>
<span class="co"># 1 2018-01-24 00:43:37  0.046 sec               0                                            </span>
<span class="co"># 2 2018-01-24 00:43:43  5.515 sec               1       0.29265          2.40384      0.86209</span>
<span class="co"># 3 2018-01-24 00:43:49 11.910 sec               2       0.28160          1.97574      0.87659</span>
<span class="co"># 4 2018-01-24 00:43:57 19.788 sec               3       0.27481          1.66203      0.88902</span>
<span class="co"># 5 2018-01-24 00:44:07 29.464 sec               4       0.27096          1.45803      0.89625</span>
<span class="co">#   training_lift training_classification_error validation_rmse validation_logloss validation_auc</span>
<span class="co"># 1                                                                                              </span>
<span class="co"># 2       3.76829                       0.09169         0.29052            2.36971        0.86437</span>
<span class="co"># 3       3.82080                       0.09099         0.25090            0.79859        0.93160</span>
<span class="co"># 4       3.89458                       0.09045         0.23710            0.43202        0.95258</span>
<span class="co"># 5       3.95686                       0.09046         0.23169            0.31511        0.95955</span>
<span class="co">#   validation_lift validation_classification_error</span>
<span class="co"># 1                                                </span>
<span class="co"># 2         3.78530                         0.09048</span>
<span class="co"># 3         4.28920                         0.09045</span>
<span class="co"># 4         4.46595                         0.07103</span>
<span class="co"># 5         4.55278                         0.06989</span>
<span class="co"># </span>
<span class="co"># Variable Importances: (Extract with `h2o.varimp`) </span>
<span class="co"># =================================================</span>
<span class="co"># </span>
<span class="co"># Variable Importances: </span>
<span class="co">#               variable relative_importance scaled_importance percentage</span>
<span class="co"># 1  last_fico_range_low       382080.343750          1.000000   0.341670</span>
<span class="co"># 2 last_fico_range_high       231268.921875          0.605289   0.206809</span>
<span class="co"># 3       emp_title_mean       166227.890625          0.435060   0.148647</span>
<span class="co"># 4             int_rate        29820.078125          0.078047   0.026666</span>
<span class="co"># 5              lcl.mon        23661.041016          0.061927   0.021159</span>
<span class="co"># </span>
<span class="co"># ---</span>
<span class="co">#                variable relative_importance scaled_importance percentage</span>
<span class="co"># 90         sub_grade.G2           74.096519          0.000194   0.000066</span>
<span class="co"># 91         sub_grade.G5           59.689659          0.000156   0.000053</span>
<span class="co"># 92         sub_grade.G4           54.631962          0.000143   0.000049</span>
<span class="co"># 93         sub_grade.G3           50.795631          0.000133   0.000045</span>
<span class="co"># 94  home_ownership.NONE           10.826398          0.000028   0.000010</span>
<span class="co"># 95 home_ownership.OTHER            1.591554          0.000004   0.000001</span>
perf &lt;-<span class="st"> </span><span class="kw">h2o.performance</span>(rf1,<span class="dt">valid=</span><span class="ot">TRUE</span>)
<span class="kw">h2o.auc</span>(perf)
<span class="co"># [1] 0.9764058</span></code></pre></div>
</div>
<div id="parameters-tunning-for-rf-grid-search" class="section level3">
<h3><span class="header-section-number">3.1.3</span> Parameters Tunning for RF (Grid Search)</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rf_params1 &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">max_depth =</span> <span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">20</span>),
                   <span class="dt">ntrees =</span> <span class="kw">c</span>(<span class="dv">50</span>,<span class="dv">100</span>),
                   <span class="dt">stopping_rounds=</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>),
                   <span class="dt">categorical_encoding =</span> <span class="kw">c</span>(<span class="st">&quot;OneHotExplicit&quot;</span>,<span class="st">&quot;SortByResponse&quot;</span>))

<span class="co"># Train and validate a grid of GBMs</span>
rf_grid1 &lt;-<span class="st"> </span><span class="kw">h2o.grid</span>(<span class="st">&quot;randomForest&quot;</span>, <span class="dt">x =</span> <span class="dv">2</span><span class="op">:</span><span class="dv">97</span>, <span class="dt">y =</span> <span class="dv">1</span>,
                      <span class="dt">grid_id =</span> <span class="st">&quot;rf_grid1&quot;</span>,
                      <span class="dt">training_frame =</span> train,
                      <span class="dt">validation_frame =</span> valid,
                      <span class="dt">seed =</span> <span class="dv">310</span>,
                      <span class="dt">min_rows =</span> <span class="dv">2</span>,
                      <span class="dt">hyper_params =</span> rf_params1)

<span class="co"># Get the grid results, sorted by AUC</span>
rf_gridperf1 &lt;-<span class="st"> </span><span class="kw">h2o.getGrid</span>(<span class="dt">grid_id =</span> <span class="st">&quot;rf_grid1&quot;</span>, 
                             <span class="dt">sort_by =</span> <span class="st">&quot;auc&quot;</span>, 
                             <span class="dt">decreasing =</span> <span class="ot">TRUE</span>)
<span class="kw">print</span>(rf_gridperf1)
<span class="co"># H2O Grid Details</span>
<span class="co"># ================</span>
<span class="co"># </span>
<span class="co"># Grid ID: rf_grid1 </span>
<span class="co"># Used hyper parameters: </span>
<span class="co">#   -  categorical_encoding </span>
<span class="co">#   -  max_depth </span>
<span class="co">#   -  ntrees </span>
<span class="co"># Number of models: 16 </span>
<span class="co"># Number of failed models: 1 </span>
<span class="co"># </span>
<span class="co"># Hyper-Parameter Search Summary: ordered by decreasing auc</span>
<span class="co">#    categorical_encoding max_depth ntrees         model_ids                auc</span>
<span class="co"># 1        OneHotExplicit        20    100 rf_grid1_model_14 0.9785284886449914</span>
<span class="co"># 2        OneHotExplicit        20    100  rf_grid1_model_6 0.9785284886449914</span>
<span class="co"># 3        SortByResponse        20    100 rf_grid1_model_15 0.9785284886449914</span>
<span class="co"># 4        SortByResponse        20    100  rf_grid1_model_7 0.9783905028467591</span>
<span class="co"># 5        OneHotExplicit        20     50  rf_grid1_model_2 0.9779967901285419</span>
<span class="co"># 6        SortByResponse        20     50  rf_grid1_model_3 0.9779967901285419</span>
<span class="co"># 7        OneHotExplicit        20     50 rf_grid1_model_10 0.9779967901285419</span>
<span class="co"># 8        SortByResponse        20     50 rf_grid1_model_11 0.9779967901285419</span>
<span class="co"># 9        OneHotExplicit        10     50  rf_grid1_model_8 0.9723520544356182</span>
<span class="co"># 10       OneHotExplicit        10     50  rf_grid1_model_0 0.9723520544356182</span>
<span class="co"># 11       SortByResponse        10     50  rf_grid1_model_9 0.9723520544356182</span>
<span class="co"># 12       SortByResponse        10     50  rf_grid1_model_1 0.9723520544356182</span>
<span class="co"># 13       SortByResponse        10    100 rf_grid1_model_13 0.9722642959849284</span>
<span class="co"># 14       OneHotExplicit        10    100  rf_grid1_model_4 0.9722642959849284</span>
<span class="co"># 15       SortByResponse        10    100  rf_grid1_model_5 0.9722642959849284</span>
<span class="co"># 16       OneHotExplicit        10    100 rf_grid1_model_12 0.9722642959849284</span>
rf &lt;-<span class="st"> </span><span class="kw">h2o.getModel</span>(rf_grid1<span class="op">@</span>model_ids[[<span class="dv">14</span>]])
rf_model_path &lt;-<span class="st"> </span><span class="kw">h2o.saveModel</span>(<span class="dt">object=</span>rf, <span class="dt">path=</span><span class="kw">getwd</span>(), <span class="dt">force=</span><span class="ot">TRUE</span>)</code></pre></div>
</div>
</div>
<div id="gbm" class="section level2">
<h2><span class="header-section-number">3.2</span> GBM</h2>
<div id="default-setup" class="section level3">
<h3><span class="header-section-number">3.2.1</span> Default Setup</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gbm1 &lt;-<span class="st"> </span><span class="kw">h2o.gbm</span>(
        <span class="dt">training_frame =</span> train,        ## the H2O frame for training
        <span class="dt">validation_frame =</span> valid,      ## the H2O frame for validation (not required)
        <span class="dt">x=</span><span class="dv">2</span><span class="op">:</span><span class="dv">97</span>,                        ## the predictor columns, by column index
        <span class="dt">y=</span><span class="dv">1</span>,                          ## the target index (what we are predicting)
        <span class="dt">model_id =</span> <span class="st">&quot;gbm_v1&quot;</span>,    ## name the model in H2O
        <span class="dt">seed =</span> <span class="dv">310</span>
        )
gbm1_perf &lt;-<span class="st"> </span><span class="kw">h2o.performance</span>(gbm1,<span class="dt">valid=</span><span class="ot">TRUE</span>)
<span class="kw">h2o.auc</span>(gbm1_perf)
<span class="co"># [1] 0.9845397</span></code></pre></div>
</div>
<div id="tunning-parameters-for-gbm-random-disceret-search" class="section level3">
<h3><span class="header-section-number">3.2.2</span> Tunning Parameters for GBM (Random Disceret search)</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gbm_params1 &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">learn_rate =</span> <span class="kw">seq</span>(<span class="fl">0.02</span>, <span class="fl">0.2</span>, <span class="fl">0.02</span>),
                    <span class="dt">max_depth =</span> <span class="kw">seq</span>(<span class="dv">2</span>, <span class="dv">10</span>, <span class="dv">1</span>),
                    <span class="dt">sample_rate =</span> <span class="kw">seq</span>(<span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>),
                    <span class="dt">col_sample_rate =</span> <span class="kw">seq</span>(<span class="fl">0.2</span>, <span class="fl">1.0</span>, <span class="fl">0.2</span>))
search_criteria1 &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">strategy =</span> <span class="st">&quot;RandomDiscrete&quot;</span>, 
                         <span class="dt">max_models =</span> <span class="dv">40</span>)

<span class="co"># Train and validate a grid of GBMs</span>
gbm_grid1 &lt;-<span class="st"> </span><span class="kw">h2o.grid</span>(<span class="st">&quot;gbm&quot;</span>, <span class="dt">x =</span> <span class="dv">2</span><span class="op">:</span><span class="dv">97</span>, <span class="dt">y =</span> <span class="dv">1</span>,
                      <span class="dt">grid_id =</span> <span class="st">&quot;gbm_grid1&quot;</span>,
                      <span class="dt">training_frame =</span> train,
                      <span class="dt">validation_frame =</span> valid,
                      <span class="dt">ntrees =</span> <span class="dv">100</span>,
                      <span class="dt">seed =</span> <span class="dv">310</span>,
                      <span class="dt">hyper_params =</span> gbm_params1,
                      <span class="dt">search_criteria =</span> search_criteria1)

gbm_gridperf1 &lt;-<span class="st"> </span><span class="kw">h2o.getGrid</span>(<span class="dt">grid_id =</span> <span class="st">&quot;gbm_grid1&quot;</span>, 
                             <span class="dt">sort_by =</span> <span class="st">&quot;auc&quot;</span>, 
                             <span class="dt">decreasing =</span> <span class="ot">TRUE</span>)
<span class="kw">print</span>(gbm_gridperf1)

gbm_grid &lt;-<span class="st"> </span><span class="kw">h2o.getModel</span>(gbm_grid1<span class="op">@</span>model_ids[[<span class="dv">3</span>]])
model_path &lt;-<span class="st"> </span><span class="kw">h2o.saveModel</span>(<span class="dt">object=</span>gbm_grid, <span class="dt">path=</span><span class="kw">getwd</span>(), <span class="dt">force=</span><span class="ot">TRUE</span>)
 
<span class="co"># H2O Grid Details</span>
<span class="co"># ================</span>
<span class="co"># </span>
<span class="co"># Grid ID: gbm_grid1 </span>
<span class="co"># Used hyper parameters: </span>
<span class="co">#   -  col_sample_rate </span>
<span class="co">#   -  learn_rate </span>
<span class="co">#   -  max_depth </span>
<span class="co">#   -  sample_rate </span>
<span class="co"># Number of models: 42 </span>
<span class="co"># Number of failed models: 1 </span>
<span class="co"># </span>
<span class="co"># Hyper-Parameter Search Summary: ordered by decreasing auc</span>
<span class="co">#   col_sample_rate learn_rate max_depth sample_rate          model_ids                auc</span>
<span class="co"># 1             1.0       0.08         9         0.8  gbm_grid1_model_3  0.987274894149704</span>
<span class="co"># 2             0.8       0.16         6         0.9 gbm_grid1_model_26 0.9872639541734924</span>
<span class="co"># 3             0.6       0.18         7         0.9 gbm_grid1_model_38 0.9872549636560094</span>
<span class="co"># 4             1.0        0.1         7         0.7 gbm_grid1_model_20 0.9871489843800337</span>
<span class="co"># 5             0.6       0.08         9         0.8 gbm_grid1_model_27  0.987109628258363</span>
<span class="co"># </span>
<span class="co"># ---</span>
<span class="co">#    col_sample_rate learn_rate max_depth sample_rate          model_ids                auc</span>
<span class="co"># 37             0.4       0.04         4         0.6 gbm_grid1_model_14 0.9807710758365877</span>
<span class="co"># 38             0.4       0.14         2         0.5 gbm_grid1_model_30 0.9807119623508779</span>
<span class="co"># 39             0.2       0.08         3         1.0 gbm_grid1_model_19 0.9790705239526789</span>
<span class="co"># 40             0.2       0.04         4         0.9 gbm_grid1_model_29 0.9774791089496461</span>
<span class="co"># 41             0.6       0.02         3         0.8 gbm_grid1_model_15  0.974281826535486</span>
<span class="co"># 42             0.6       0.04         2         0.9  gbm_grid1_model_1 0.9729248761037532</span>
<span class="co"># Failed models</span>
<span class="co"># -------------</span>
<span class="co">#  col_sample_rate learn_rate max_depth sample_rate status_failed msgs_failed</span>
<span class="co">#              0.4       0.08        10         0.7          FAIL        &quot;NA&quot;</span></code></pre></div>
</div>
</div>
<div id="building-models-on-different-feature-imputation-and-selections" class="section level2">
<h2><span class="header-section-number">3.3</span> Building Models on Different Feature Imputation and Selections</h2>
<div id="use--999-for-all-missing-values-in-numeric-features" class="section level3">
<h3><span class="header-section-number">3.3.1</span> Use -999 For all missing values in numeric features</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat.num.imp &lt;-<span class="st"> </span>dat.num<span class="op">%&gt;%</span><span class="kw">mutate_all</span>(<span class="cf">function</span>(x)<span class="kw">ifelse</span>(<span class="kw">is.na</span>(x),<span class="op">-</span><span class="dv">999</span>,x))
dat.num.imp.tr &lt;-<span class="st"> </span><span class="kw">data.table</span>(dat.num.imp)[year <span class="op">&lt;</span><span class="dv">3</span>][,<span class="kw">c</span>(<span class="st">&quot;id&quot;</span>,<span class="st">&quot;loan_status&quot;</span>) <span class="op">:</span><span class="er">=</span><span class="ot">NULL</span>]
dat.num.imp.te &lt;-<span class="st"> </span><span class="kw">data.table</span>(dat.num.imp)[year <span class="op">==</span><span class="dv">3</span>][,<span class="kw">c</span>(<span class="st">&quot;id&quot;</span>,<span class="st">&quot;loan_status&quot;</span>) <span class="op">:</span><span class="er">=</span><span class="ot">NULL</span>]
dat.train2 &lt;-<span class="st"> </span>dat.train <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">which</span>(<span class="op">!</span><span class="kw">names</span>(.)<span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(dat.num.imp.tr)))<span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">cbind</span>(.,dat.num.imp.tr) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(y,<span class="kw">everything</span>()) <span class="op">%&gt;%</span><span class="kw">mutate_at</span>(<span class="st">&quot;y&quot;</span>, <span class="kw">funs</span>(<span class="kw">as.factor</span>(.)))
dat.test2 &lt;-<span class="st"> </span>dat.test <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">which</span>(<span class="op">!</span><span class="kw">names</span>(.)<span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(dat.num.imp.te)))<span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">cbind</span>(.,dat.num.imp.te) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(y,<span class="kw">everything</span>()) <span class="op">%&gt;%</span><span class="kw">mutate_at</span>(<span class="st">&quot;y&quot;</span>, <span class="kw">funs</span>(<span class="kw">as.factor</span>(.)))
<span class="co">#save data tp h2o format</span>
tr.hex &lt;-<span class="st"> </span><span class="kw">as.h2o</span>(dat.train2, <span class="dt">destination_frame=</span><span class="st">&quot;tr.hex&quot;</span>)
splits &lt;-<span class="st"> </span><span class="kw">h2o.splitFrame</span>(
  tr.hex,           ##  splitting the H2O frame we read above
  <span class="fl">0.7</span>,              ##  create splits of 70% and 30%; 
                    ##  H2O will create one more split of 1-(sum of these parameters)
  <span class="dt">seed=</span><span class="dv">310</span>)         ##  setting a seed will ensure reproducible results 

train &lt;-<span class="st"> </span><span class="kw">h2o.assign</span>(splits[[<span class="dv">1</span>]], <span class="st">&quot;train.hex&quot;</span>)   
valid &lt;-<span class="st"> </span><span class="kw">h2o.assign</span>(splits[[<span class="dv">2</span>]], <span class="st">&quot;valid.hex&quot;</span>)   
te.hex &lt;-<span class="st"> </span><span class="kw">as.h2o</span>(dat.test, <span class="dt">destination_frame=</span><span class="st">&quot;te.hex&quot;</span>)

gbm_grid2 &lt;-<span class="st"> </span><span class="kw">h2o.grid</span>(<span class="st">&quot;gbm&quot;</span>, <span class="dt">x =</span> <span class="dv">2</span><span class="op">:</span><span class="dv">97</span>, <span class="dt">y =</span> <span class="dv">1</span>,
                      <span class="dt">grid_id =</span> <span class="st">&quot;gbm_grid2&quot;</span>,
                      <span class="dt">training_frame =</span> train,
                      <span class="dt">validation_frame =</span> valid,
                      <span class="dt">ntrees =</span> <span class="dv">100</span>,
                      <span class="dt">seed =</span> <span class="dv">310</span>,
                      <span class="dt">hyper_params =</span> gbm_params1,
                      <span class="dt">search_criteria =</span> search_criteria1)

gbm_gridperf2 &lt;-<span class="st"> </span><span class="kw">h2o.getGrid</span>(<span class="dt">grid_id =</span> <span class="st">&quot;gbm_grid2&quot;</span>, 
                             <span class="dt">sort_by =</span> <span class="st">&quot;auc&quot;</span>, 
                             <span class="dt">decreasing =</span> <span class="ot">TRUE</span>)
<span class="kw">print</span>(gbm_gridperf2)

gbm_grid2 &lt;-<span class="st"> </span><span class="kw">h2o.getModel</span>(gbm_grid2<span class="op">@</span>model_ids[[<span class="dv">32</span>]])
model_path &lt;-<span class="st"> </span><span class="kw">h2o.saveModel</span>(<span class="dt">object=</span>gbm_grid2, <span class="dt">path=</span><span class="kw">getwd</span>(), <span class="dt">force=</span><span class="ot">TRUE</span>)

<span class="co"># H2O Grid Details</span>
<span class="co"># ================</span>
<span class="co"># </span>
<span class="co"># Grid ID: gbm_grid2 </span>
<span class="co"># Used hyper parameters: </span>
<span class="co">#   -  col_sample_rate </span>
<span class="co">#   -  learn_rate </span>
<span class="co">#   -  max_depth </span>
<span class="co">#   -  sample_rate </span>
<span class="co"># Number of models: 40 </span>
<span class="co"># Number of failed models: 0 </span>
<span class="co"># </span>
<span class="co"># Hyper-Parameter Search Summary: ordered by decreasing auc</span>
<span class="co">#   col_sample_rate learn_rate max_depth sample_rate          model_ids                auc</span>
<span class="co"># 1             0.8       0.08         8         1.0 gbm_grid2_model_32 0.9872060216681666</span>
<span class="co"># 2             0.8       0.16         7         1.0 gbm_grid2_model_39 0.9871970675110457</span>
<span class="co"># 3             0.6        0.2         6         1.0 gbm_grid2_model_12 0.9871603114687219</span>
<span class="co"># 4             0.8       0.08         7         0.7 gbm_grid2_model_14  0.986930200214922</span>
<span class="co"># 5             1.0       0.12         6         0.7 gbm_grid2_model_34   0.98690702090197</span>
<span class="co"># </span>
<span class="co"># ---</span>
<span class="co">#    col_sample_rate learn_rate max_depth sample_rate          model_ids                auc</span>
<span class="co"># 35             0.8       0.08         2         0.5 gbm_grid2_model_16  0.977823857738423</span>
<span class="co"># 36             0.2       0.08         2         0.9 gbm_grid2_model_25 0.9762207799402546</span>
<span class="co"># 37             1.0       0.06         2         0.5 gbm_grid2_model_31 0.9757513492754175</span>
<span class="co"># 38             0.6       0.04         2         0.7 gbm_grid2_model_36 0.9734772111109298</span>
<span class="co"># 39             0.8       0.04         2         0.5  gbm_grid2_model_4 0.9733014591210016</span>
<span class="co"># 40             0.2       0.04         2         0.6 gbm_grid2_model_23  0.970879386210907</span></code></pre></div>
<p>Performance for impute -999 to missing data is actually quite good, from the 40 prediction model, auc ranging from 0.971 to 0.987. However, the final model I select is gbm from grid 1. ##Final Model selecttion I picked the model with the best performance from gbm_grid1. This is because with -999 imputed missing values, linear model won’t be able to use and the GBM AUCs are very close between using original imputation method and -999 imputation. Moreover, imputation all missing values with -999 has higher possibility to overfit the data, which is the situation I want to avoid.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> finalModel &lt;-<span class="st"> </span><span class="kw">h2o.loadModel</span>(<span class="st">&quot;gbm_grid1_model_3&quot;</span>)
 Finalperf &lt;-<span class="st"> </span><span class="kw">h2o.performance</span>(finalModel, <span class="dt">newdata =</span> te.hex)
 <span class="kw">h2o.auc</span>(Finalperf)
<span class="co"># [1] 0.972536 </span></code></pre></div>
</div>
</div>
</div>
<div id="unsupervised-learning-model-practices" class="section level1">
<h1><span class="header-section-number">4</span> Unsupervised Learning Model Practices</h1>
<p>This is a practice to get more information from the data. I’m going to use the data set before any imputation. There are a lot more interesting test can be done, but with the concern of timeline, I would just use the complete cases here. ##Clustering based on Profile Variables</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Profile.var &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;pub_rec_bankruptcies&#39;</span>, <span class="st">&#39;tax_liens&#39;</span>, <span class="st">&#39;inq_last_6mths&#39;</span>, <span class="st">&#39;tot_cur_bal&#39;</span>, <span class="st">&#39;mo_sin_old_il_acct&#39;</span>, <span class="st">&#39;pct_tl_nvr_dlq&#39;</span>,  <span class="st">&#39;num_rev_tl_bal_gt_0&#39;</span>, <span class="st">&#39;total_bal_ex_mort&#39;</span>, <span class="st">&#39;annual_inc&#39;</span>, <span class="st">&#39;total_acc&#39;</span>, <span class="st">&#39;num_sats&#39;</span>,  <span class="st">&#39;total_rev_hi_lim&#39;</span>, <span class="st">&#39;num_bc_tl&#39;</span>, <span class="st">&#39;percent_bc_gt_75&#39;</span>, <span class="st">&#39;num_il_tl&#39;</span>, <span class="st">&#39;bc_util&#39;</span>, <span class="st">&#39;mo_sin_old_rev_tl_op&#39;</span>, <span class="st">&#39;pub_rec&#39;</span>, <span class="st">&#39;acc_open_past_24mths&#39;</span>, <span class="st">&#39;num_tl_30dpd&#39;</span>, <span class="st">&#39;mths_since_recent_bc&#39;</span>, <span class="st">&#39;total_bc_limit&#39;</span>,<span class="st">&#39;num_actv_bc_tl&#39;</span>, <span class="st">&#39;avg_cur_bal&#39;</span>, <span class="st">&#39;num_accts_ever_120_pd&#39;</span>, <span class="st">&#39;open_acc&#39;</span>, <span class="st">&#39;num_bc_sats&#39;</span>, <span class="st">&#39;mort_acc&#39;</span>, <span class="st">&#39;tot_coll_amt&#39;</span>, <span class="st">&#39;num_tl_120dpd_2m&#39;</span>, <span class="st">&#39;bc_open_to_buy&#39;</span>, <span class="st">&#39;acc_now_delinq&#39;</span>, <span class="st">&#39;chargeoff_within_12_mths&#39;</span>, <span class="st">&#39;num_op_rev_tl&#39;</span>, <span class="st">&#39;revol_bal&#39;</span>, <span class="st">&#39;num_actv_rev_tl&#39;</span>, <span class="st">&#39;mo_sin_rcnt_rev_tl_op&#39;</span>, <span class="st">&#39;num_rev_accts&#39;</span>, <span class="st">&#39;num_tl_90g_dpd_24m&#39;</span>, <span class="st">&#39;mths_since_recent_inq&#39;</span>, <span class="st">&#39;mo_sin_rcnt_tl&#39;</span>, <span class="st">&#39;total_il_high_credit_limit&#39;</span>, <span class="st">&#39;tot_hi_cred_lim&#39;</span>, <span class="st">&#39;dti&#39;</span>,<span class="st">&#39;num_tl_op_past_12m&#39;</span>)

dat &lt;-<span class="st"> </span>dat[dat<span class="op">$</span>year<span class="op">&lt;</span><span class="dv">3</span>,]
dat.cluster &lt;-<span class="st"> </span>dat <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw">select</span>(<span class="kw">which</span>(<span class="kw">names</span>(.) <span class="op">%in%</span><span class="st"> </span>Profile.var)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw">mutate_all</span>(as.numeric) <span class="co">#Change all variables from charactor to numeric</span>
dat.cluster<span class="op">$</span>y &lt;-<span class="st"> </span>dat<span class="op">$</span>y
dat.cluster &lt;-<span class="st"> </span>dat.cluster <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(y, <span class="kw">everything</span>())<span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_at</span>(<span class="st">&quot;y&quot;</span>, <span class="kw">funs</span>(<span class="kw">as.numeric</span>(.)))
<span class="kw">str</span>(dat.cluster)</code></pre></div>
<pre><code>## &#39;data.frame&#39;:    570081 obs. of  46 variables:
##  $ y                         : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ annual_inc                : num  102000 81500 28000 325000 130000 73000 90000 40000 26000 25000 ...
##  $ dti                       : num  15.6 16.7 8.4 18.6 13 ...
##  $ inq_last_6mths            : num  0 2 0 1 1 1 0 0 0 0 ...
##  $ open_acc                  : num  9 29 4 15 9 10 9 7 12 5 ...
##  $ pub_rec                   : num  0 0 0 0 0 0 0 2 0 2 ...
##  $ revol_bal                 : num  9912 23473 5759 29581 10805 ...
##  $ total_acc                 : num  22 41 5 31 19 24 12 32 28 26 ...
##  $ acc_now_delinq            : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ tot_coll_amt              : num  0 0 0 0 0 ...
##  $ tot_cur_bal               : num  39143 23473 5759 799592 327264 ...
##  $ total_rev_hi_lim          : num  22300 43100 8000 54200 16200 32600 10000 8100 15100 5300 ...
##  $ acc_open_past_24mths      : num  3 9 1 6 4 2 2 4 2 3 ...
##  $ avg_cur_bal               : num  4349 869 1440 53306 36362 ...
##  $ bc_open_to_buy            : num  973 6811 160 13901 3567 ...
##  $ bc_util                   : num  89.4 54.6 96 67.1 93 74.7 74.6 79.6 75.7 52.3 ...
##  $ chargeoff_within_12_mths  : num  0 0 0 0 0 1 0 0 0 0 ...
##  $ mo_sin_old_il_acct        : num  243 115 NA 125 173 173 NA 124 67 164 ...
##  $ mo_sin_old_rev_tl_op      : num  290 186 38 229 193 294 150 182 83 271 ...
##  $ mo_sin_rcnt_rev_tl_op     : num  23 0 17 5 4 4 11 1 12 7 ...
##  $ mo_sin_rcnt_tl            : num  8 0 17 2 4 4 11 1 12 7 ...
##  $ mort_acc                  : num  0 0 0 5 3 4 1 0 0 6 ...
##  $ mths_since_recent_bc      : num  25 0 17 5 85 4 11 11 12 14 ...
##  $ mths_since_recent_inq     : num  8 0 17 3 4 6 11 17 20 8 ...
##  $ num_accts_ever_120_pd     : num  1 1 0 0 0 3 1 6 0 1 ...
##  $ num_actv_bc_tl            : num  3 8 2 4 3 5 4 2 6 2 ...
##  $ num_actv_rev_tl           : num  4 24 4 5 5 7 8 2 7 3 ...
##  $ num_bc_sats               : num  3 11 2 6 4 5 4 3 6 3 ...
##  $ num_bc_tl                 : num  6 17 2 8 4 11 4 14 11 6 ...
##  $ num_il_tl                 : num  9 1 0 11 8 4 0 8 8 11 ...
##  $ num_op_rev_tl             : num  6 29 4 9 5 7 8 6 9 4 ...
##  $ num_rev_accts             : num  13 40 5 15 8 16 11 24 20 9 ...
##  $ num_rev_tl_bal_gt_0       : num  4 24 4 5 5 7 8 2 7 3 ...
##  $ num_sats                  : num  9 29 4 15 9 10 9 7 12 5 ...
##  $ num_tl_120dpd_2m          : num  0 0 0 0 NA 0 0 0 0 0 ...
##  $ num_tl_30dpd              : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ num_tl_90g_dpd_24m        : num  0 0 0 0 0 1 1 0 0 0 ...
##  $ num_tl_op_past_12m        : num  1 3 0 5 3 1 1 2 2 1 ...
##  $ pct_tl_nvr_dlq            : num  77.3 90.2 100 100 100 87.5 75 81.2 100 91.3 ...
##  $ percent_bc_gt_75          : num  66.7 50 100 16.7 1 80 50 33.3 66.7 66.7 ...
##  $ pub_rec_bankruptcies      : num  0 0 0 0 0 0 0 0 0 2 ...
##  $ tax_liens                 : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ tot_hi_cred_lim           : num  58486 43100 8000 850886 365874 ...
##  $ total_bal_ex_mort         : num  39143 23473 5759 199739 44327 ...
##  $ total_bc_limit            : num  9200 15000 4000 42200 10700 19200 4000 7000 7200 4300 ...
##  $ total_il_high_credit_limit: num  36186 0 0 196686 57674 ...</code></pre>
<div id="k-mean-clustering" class="section level2">
<h2><span class="header-section-number">4.1</span> K-mean Clustering</h2>
<div id="standard-scaler" class="section level3">
<h3><span class="header-section-number">4.1.1</span> Standard Scaler</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Take 10,000 sample from the data train set.</span>
<span class="kw">set.seed</span>(<span class="dv">310</span>)
dat.cluster &lt;-<span class="st"> </span><span class="kw">na.omit</span>(dat.cluster)
dat.cluster.p &lt;-<span class="st"> </span><span class="kw">data.table</span>(dat.cluster)[<span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">dim</span>(dat.cluster)[<span class="dv">1</span>],<span class="dv">10000</span>,<span class="dt">replace =</span> <span class="ot">FALSE</span>)]</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Normalize the dataset by scaling and centering it.</span>
##Use 10000 sample to practice
dat.scaled &lt;-<span class="st"> </span><span class="kw">scale</span>(dat.cluster.p[,<span class="dv">2</span><span class="op">:</span><span class="dv">46</span>])
<span class="co"># cluster.mtx = as.matrix(dat.cluster.p[,1])</span>
<span class="co"># cluster.mtx &lt;- cbind2(test,cluster.mtx)</span>
<span class="co">#Elbow method</span>
k.max =<span class="st"> </span><span class="dv">10</span>
<span class="kw">set.seed</span>(<span class="dv">310</span>)
<span class="co">#cluster.mtx &lt;- na.omit(cluster.mtx)</span>
wss &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>k.max, 
              <span class="cf">function</span>(k){<span class="kw">kmeans</span>(dat.scaled, k, <span class="dt">nstart=</span><span class="dv">3</span>,<span class="dt">iter.max =</span> <span class="dv">300</span>,<span class="dt">algorithm =</span> <span class="st">&quot;MacQueen&quot;</span> )<span class="op">$</span>tot.withinss})
wss &lt;-<span class="st"> </span><span class="kw">data.frame</span>(wss)
x&lt;-<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)
wss<span class="op">$</span>x &lt;-<span class="st"> </span>x
p &lt;-<span class="st"> </span><span class="kw">plot_ly</span>(wss,<span class="dt">x=</span><span class="op">~</span>x, <span class="dt">y=</span><span class="op">~</span>wss,<span class="dt">type=</span><span class="st">&quot;scatter&quot;</span>,<span class="dt">mode =</span> <span class="st">&quot;lines+markers&quot;</span>)
p</code></pre></div>
<p><div id="33885dd820c2" style="width:672px;height:480px;" class="plotly html-widget"></div>
<script type="application/json" data-for="33885dd820c2">{"x":{"visdat":{"338838d86738":["function () ","plotlyVisDat"]},"cur_data":"338838d86738","attrs":{"338838d86738":{"x":{},"y":{},"mode":"lines+markers","alpha":1,"sizes":[10,100],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"title":"x"},"yaxis":{"domain":[0,1],"title":"wss"},"hovermode":"closest","showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":[{"name":"Collaborate","icon":{"width":1000,"ascent":500,"descent":-50,"path":"M487 375c7-10 9-23 5-36l-79-259c-3-12-11-23-22-31-11-8-22-12-35-12l-263 0c-15 0-29 5-43 15-13 10-23 23-28 37-5 13-5 25-1 37 0 0 0 3 1 7 1 5 1 8 1 11 0 2 0 4-1 6 0 3-1 5-1 6 1 2 2 4 3 6 1 2 2 4 4 6 2 3 4 5 5 7 5 7 9 16 13 26 4 10 7 19 9 26 0 2 0 5 0 9-1 4-1 6 0 8 0 2 2 5 4 8 3 3 5 5 5 7 4 6 8 15 12 26 4 11 7 19 7 26 1 1 0 4 0 9-1 4-1 7 0 8 1 2 3 5 6 8 4 4 6 6 6 7 4 5 8 13 13 24 4 11 7 20 7 28 1 1 0 4 0 7-1 3-1 6-1 7 0 2 1 4 3 6 1 1 3 4 5 6 2 3 3 5 5 6 1 2 3 5 4 9 2 3 3 7 5 10 1 3 2 6 4 10 2 4 4 7 6 9 2 3 4 5 7 7 3 2 7 3 11 3 3 0 8 0 13-1l0-1c7 2 12 2 14 2l218 0c14 0 25-5 32-16 8-10 10-23 6-37l-79-259c-7-22-13-37-20-43-7-7-19-10-37-10l-248 0c-5 0-9-2-11-5-2-3-2-7 0-12 4-13 18-20 41-20l264 0c5 0 10 2 16 5 5 3 8 6 10 11l85 282c2 5 2 10 2 17 7-3 13-7 17-13z m-304 0c-1-3-1-5 0-7 1-1 3-2 6-2l174 0c2 0 4 1 7 2 2 2 4 4 5 7l6 18c0 3 0 5-1 7-1 1-3 2-6 2l-173 0c-3 0-5-1-8-2-2-2-4-4-4-7z m-24-73c-1-3-1-5 0-7 2-2 3-2 6-2l174 0c2 0 5 0 7 2 3 2 4 4 5 7l6 18c1 2 0 5-1 6-1 2-3 3-5 3l-174 0c-3 0-5-1-7-3-3-1-4-4-5-6z"},"click":"function(gd) { \n        // is this being viewed in RStudio?\n        if (location.search == '?viewer_pane=1') {\n          alert('To learn about plotly for collaboration, visit:\\n https://cpsievert.github.io/plotly_book/plot-ly-for-collaboration.html');\n        } else {\n          window.open('https://cpsievert.github.io/plotly_book/plot-ly-for-collaboration.html', '_blank');\n        }\n      }"}],"cloud":false},"data":[{"x":[1,2,3,4,5,6,7,8,9,10],"y":[449954.999999692,396171.406553117,378478.533375625,364243.393552219,354422.988292248,342026.109327895,333530.221940759,324150.609794887,316878.522905563,310233.673739665],"mode":"lines+markers","type":"scatter","line":{"fillcolor":"rgba(31,119,180,1)","color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1}},"base_url":"https://plot.ly"},"evals":["config.modeBarButtonsToAdd.0.click"],"jsHooks":{"render":[{"code":"function(el, x) { var ctConfig = crosstalk.var('plotlyCrosstalkOpts').set({\"on\":\"plotly_click\",\"persistent\":false,\"dynamic\":false,\"selectize\":false,\"opacityDim\":0.2,\"selected\":{\"opacity\":1}}); }","data":null}]}}</script> Therefore for k=8 the between_ss/total_ss ratio tends to change slowly and remain less changing as compared to other k.so for this data k=8 should be a good choice for number of clusters. k = 2 is a good elbow point as well. Notice that I used only the compelet cases to find out an optimal number of cluster.</p>
</div>
<div id="minmax-scaler" class="section level3">
<h3><span class="header-section-number">4.1.2</span> MinMax Scaler</h3>
<p>MinMax scaling for continuos variables will shrink the distance of the outlier to the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat.scaled &lt;-<span class="st"> </span>dat.cluster.p <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(<span class="dv">2</span><span class="op">:</span><span class="dv">46</span>),<span class="kw">funs</span>((.<span class="op">-</span><span class="kw">min</span>(.))<span class="op">/</span>(<span class="kw">max</span>(.)<span class="op">-</span><span class="kw">min</span>(.)))) 
dat.scaled &lt;-<span class="st"> </span>dat.scaled[,<span class="op">-</span><span class="dv">1</span>]
k.max =<span class="st"> </span><span class="dv">10</span>
<span class="kw">set.seed</span>(<span class="dv">310</span>)
<span class="co">#cluster.mtx &lt;- na.omit(cluster.mtx)</span>
wss &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>k.max, 
              <span class="cf">function</span>(k){<span class="kw">kmeans</span>(dat.scaled, k, <span class="dt">nstart=</span><span class="dv">3</span>,<span class="dt">iter.max =</span> <span class="dv">300</span>,<span class="dt">algorithm =</span> <span class="st">&quot;MacQueen&quot;</span> )<span class="op">$</span>tot.withinss})

wss &lt;-<span class="st"> </span><span class="kw">data.frame</span>(wss)
x&lt;-<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)
wss<span class="op">$</span>x &lt;-<span class="st"> </span>x
p &lt;-<span class="st"> </span><span class="kw">plot_ly</span>(wss,<span class="dt">x=</span><span class="op">~</span>x, <span class="dt">y=</span><span class="op">~</span>wss,<span class="dt">type=</span><span class="st">&quot;scatter&quot;</span>,<span class="dt">mode =</span> <span class="st">&quot;lines+markers&quot;</span>)
p</code></pre></div>
<p><div id="338874e14bcf" style="width:672px;height:480px;" class="plotly html-widget"></div>
<script type="application/json" data-for="338874e14bcf">{"x":{"visdat":{"33885e387e7d":["function () ","plotlyVisDat"]},"cur_data":"33885e387e7d","attrs":{"33885e387e7d":{"x":{},"y":{},"mode":"lines+markers","alpha":1,"sizes":[10,100],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"title":"x"},"yaxis":{"domain":[0,1],"title":"wss"},"hovermode":"closest","showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":[{"name":"Collaborate","icon":{"width":1000,"ascent":500,"descent":-50,"path":"M487 375c7-10 9-23 5-36l-79-259c-3-12-11-23-22-31-11-8-22-12-35-12l-263 0c-15 0-29 5-43 15-13 10-23 23-28 37-5 13-5 25-1 37 0 0 0 3 1 7 1 5 1 8 1 11 0 2 0 4-1 6 0 3-1 5-1 6 1 2 2 4 3 6 1 2 2 4 4 6 2 3 4 5 5 7 5 7 9 16 13 26 4 10 7 19 9 26 0 2 0 5 0 9-1 4-1 6 0 8 0 2 2 5 4 8 3 3 5 5 5 7 4 6 8 15 12 26 4 11 7 19 7 26 1 1 0 4 0 9-1 4-1 7 0 8 1 2 3 5 6 8 4 4 6 6 6 7 4 5 8 13 13 24 4 11 7 20 7 28 1 1 0 4 0 7-1 3-1 6-1 7 0 2 1 4 3 6 1 1 3 4 5 6 2 3 3 5 5 6 1 2 3 5 4 9 2 3 3 7 5 10 1 3 2 6 4 10 2 4 4 7 6 9 2 3 4 5 7 7 3 2 7 3 11 3 3 0 8 0 13-1l0-1c7 2 12 2 14 2l218 0c14 0 25-5 32-16 8-10 10-23 6-37l-79-259c-7-22-13-37-20-43-7-7-19-10-37-10l-248 0c-5 0-9-2-11-5-2-3-2-7 0-12 4-13 18-20 41-20l264 0c5 0 10 2 16 5 5 3 8 6 10 11l85 282c2 5 2 10 2 17 7-3 13-7 17-13z m-304 0c-1-3-1-5 0-7 1-1 3-2 6-2l174 0c2 0 4 1 7 2 2 2 4 4 5 7l6 18c0 3 0 5-1 7-1 1-3 2-6 2l-173 0c-3 0-5-1-8-2-2-2-4-4-4-7z m-24-73c-1-3-1-5 0-7 2-2 3-2 6-2l174 0c2 0 5 0 7 2 3 2 4 4 5 7l6 18c1 2 0 5-1 6-1 2-3 3-5 3l-174 0c-3 0-5-1-7-3-3-1-4-4-5-6z"},"click":"function(gd) { \n        // is this being viewed in RStudio?\n        if (location.search == '?viewer_pane=1') {\n          alert('To learn about plotly for collaboration, visit:\\n https://cpsievert.github.io/plotly_book/plot-ly-for-collaboration.html');\n        } else {\n          window.open('https://cpsievert.github.io/plotly_book/plot-ly-for-collaboration.html', '_blank');\n        }\n      }"}],"cloud":false},"data":[{"x":[1,2,3,4,5,6,7,8,9,10],"y":[5511.17558942031,4296.85503213386,3929.51842740463,3680.40089224572,3471.33702910935,3327.02929930207,3192.97138873161,3118.2081293078,3053.53439521132,2999.32789819598],"mode":"lines+markers","type":"scatter","line":{"fillcolor":"rgba(31,119,180,1)","color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1}},"base_url":"https://plot.ly"},"evals":["config.modeBarButtonsToAdd.0.click"],"jsHooks":{"render":[{"code":"function(el, x) { var ctConfig = crosstalk.var('plotlyCrosstalkOpts').set({\"on\":\"plotly_click\",\"persistent\":false,\"dynamic\":false,\"selectize\":false,\"opacityDim\":0.2,\"selected\":{\"opacity\":1}}); }","data":null}]}}</script> ##Density-Based Clustering(dbscan) To apply dbscan, we need to decide on the neighborhood radius and the density threshold minPts. The rule of thumb for minPts is to use at least the number of dimensions of the data set plus one. In our case, it is 80. We used the normolized data using MinMax scaler in K-mean clustering.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dbscan)
<span class="kw">kNNdistplot</span>(dat.scaled,<span class="dt">k=</span><span class="dv">80</span>)<span class="op">+</span>
<span class="kw">abline</span>(<span class="dt">h=</span>.<span class="dv">75</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-72-1.png" width="672" /></p>
<pre><code>## integer(0)</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res &lt;-<span class="st"> </span><span class="kw">dbscan</span>(dat.scaled,<span class="dt">eps =</span>.<span class="dv">75</span> ,<span class="dt">minPts =</span> <span class="dv">80</span>)</code></pre></div>
</div>
</div>
<div id="dimensionality-reduction-practices-and-clustering" class="section level2">
<h2><span class="header-section-number">4.2</span> dimensionality Reduction Practices and Clustering</h2>
<div id="pca" class="section level3">
<h3><span class="header-section-number">4.2.1</span> PCA</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#In order to adjust the skewed distribution of the data set, I used min max scaler.</span>
 
<span class="co"># apply PCA - scale. = TRUE is highly </span>
<span class="co"># advisable, but default is FALSE. </span>
lc.pca &lt;-<span class="st"> </span><span class="kw">prcomp</span>(dat.scaled)
<span class="kw">plot</span>(lc.pca, <span class="dt">type =</span> <span class="st">&quot;l&quot;</span>)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-73-1.png" width="672" /></p>
</div>
<div id="lle" class="section level3">
<h3><span class="header-section-number">4.2.2</span> LLE</h3>
<p>local linear embedding</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(lle)
<span class="co">#neighbours &lt;- find_nn_k(dat.sample, k=15)</span>
<span class="co">#weights &lt;- find_weights(neighbours, dat.sample, m=2, reg=2)</span>
dat &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat.scaled)
k5 &lt;-<span class="st"> </span><span class="kw">lle</span>(dat, <span class="dt">m=</span><span class="dv">2</span>, <span class="dt">k=</span><span class="dv">5</span>, <span class="dt">reg=</span><span class="dv">2</span>, <span class="dt">ss=</span><span class="ot">FALSE</span>, <span class="dt">id=</span><span class="ot">TRUE</span>, <span class="dt">v=</span><span class="fl">0.9</span>)</code></pre></div>
<pre><code>## finding neighbours
## calculating weights
## intrinsic dim: mean=3.8792, mode=4
## computing coordinates</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#k10 &lt;- lle(dat.sample.lle, m=2, k=10, reg=2, ss=FALSE, id=TRUE, v=0.9)</span>

<span class="co">#plot_lle(k5$Y, dat.sample, FALSE, col=&quot;red&quot;, inter=TRUE)</span>
<span class="kw">plot</span>(k5<span class="op">$</span>Y, <span class="dt">main=</span><span class="st">&quot;K=5 data&quot;</span>, <span class="dt">xlab=</span><span class="kw">expression</span>(y[<span class="dv">1</span>]), <span class="dt">ylab=</span><span class="kw">expression</span>(y[<span class="dv">2</span>]))</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-74-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#plot(k10$Y, main=&quot;K=10 data&quot;, xlab=expression(y[1]), ylab=expression(y[2]))</span>

<span class="co">#plot_lle(k10$Y, dat.sample, main=&quot;K=10 data&quot;,FALSE, col=&quot;red&quot;, inter=TRUE,xlab=expression(y[1]), ylab=expression(y[2]))</span></code></pre></div>
</div>
<div id="mds" class="section level3">
<h3><span class="header-section-number">4.2.3</span> MDS</h3>
<p>MDS tries to maintain distances in high- and low-dimensional space, it has the advantage over PCA that arbitrary distance functions can be used, but it is computationally more demanding.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dimRed)
mds &lt;-<span class="st"> </span><span class="kw">MDS</span>()
dat &lt;-<span class="st"> </span><span class="kw">dimRedData</span>(dat.scaled)
### with meta information:
<span class="co">#dimRedData(iris[, 1:4], iris[, 5])</span>
<span class="co">#mds@stdpars$ndim = 10</span>
<span class="co">#emb.mds &lt;- mds@fun(dat.sample.MDS, mds@stdpars)</span>
## use embed():
emb2.mds &lt;-<span class="st"> </span><span class="kw">embed</span>(dat, <span class="st">&quot;MDS&quot;</span>, <span class="dt">d =</span> <span class="cf">function</span>(x) <span class="kw">exp</span>(stats<span class="op">::</span><span class="kw">dist</span>(x)),<span class="dt">ndim =</span> <span class="dv">10</span>)
<span class="co">#plot(emb, type = &quot;2vars&quot;,main = &quot;emb&quot;)</span>
<span class="kw">plot</span>(emb2.mds, <span class="dt">type =</span> <span class="st">&quot;3vars&quot;</span>,<span class="dt">main =</span> <span class="st">&quot;emb2&quot;</span>)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-75-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df.emb2.mds &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(emb2.mds, <span class="dt">meta.prefix =</span> <span class="st">&quot;meta.&quot;</span>, <span class="dt">data.prefix =</span> <span class="st">&quot;&quot;</span>)
<span class="kw">saveRDS</span>(df.emb2.mds,<span class="st">&quot;df.emb2.mds.rds&quot;</span>)</code></pre></div>
</div>
<div id="isomap" class="section level3">
<h3><span class="header-section-number">4.2.4</span> isomap</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> <span class="kw">set.seed</span>(<span class="dv">310</span>)
 <span class="co">#Get the unscaled the data set</span>
 samp &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">nrow</span>(dat.cluster.p), <span class="dt">size =</span> <span class="dv">2000</span>)
 dat &lt;-<span class="st"> </span><span class="kw">dimRedData</span>(dat.cluster.p[,<span class="op">-</span><span class="dv">1</span>])
 emb2 &lt;-<span class="st"> </span><span class="kw">embed</span>(dat[samp], <span class="st">&quot;Isomap&quot;</span>, <span class="dt">mute =</span> <span class="ot">NULL</span>, <span class="dt">knn =</span> <span class="dv">50</span>, <span class="dt">ndim =</span><span class="dv">10</span>)
 emb3 &lt;-<span class="st"> </span>emb2<span class="op">@</span><span class="kw">apply</span>(dat[<span class="op">-</span>samp])
 <span class="kw">plot</span>(emb2, <span class="dt">type =</span> <span class="st">&quot;3vars&quot;</span>)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-76-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> <span class="kw">plot</span>(emb3, <span class="dt">type =</span> <span class="st">&quot;3vars&quot;</span>)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-76-2.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df.emb2 &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(emb2, <span class="dt">meta.prefix =</span> <span class="st">&quot;meta.&quot;</span>, <span class="dt">data.prefix =</span> <span class="st">&quot;&quot;</span>)
df.emb3 &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(emb3, <span class="dt">meta.prefix =</span> <span class="st">&quot;meta.&quot;</span>, <span class="dt">data.prefix =</span> <span class="st">&quot;&quot;</span>)
df.emb &lt;-<span class="st"> </span><span class="kw">rbind</span>(df.emb2[,<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>],df.emb3)
##Clustering on deminsion reduced data set
<span class="kw">saveRDS</span>(df.emb,<span class="st">&quot;df.emb.rds&quot;</span>)
<span class="kw">kNNdistplot</span>(df.emb,<span class="dt">k=</span><span class="dv">11</span>)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-76-3.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res.iso &lt;-<span class="st"> </span><span class="kw">dbscan</span>(df.emb,<span class="dt">eps =</span><span class="fl">0.3e+6</span> ,<span class="dt">minPts =</span> <span class="dv">11</span>)</code></pre></div>
</div>
<div id="t-sne" class="section level3">
<h3><span class="header-section-number">4.2.5</span> t-SNE</h3>
<p>t-SNE,t-Distributed Stochastic Neighbor Embedding is a non-linear dimensionality reduction algorithm used for exploring high-dimensional data. It maps multi-dimensional data to two or more dimensions suitable for human observation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">310</span>)
<span class="kw">require</span>(Rtsne)
tsne_out &lt;-<span class="st"> </span><span class="kw">Rtsne</span>(<span class="kw">as.matrix</span>(dat.cluster.p[,<span class="op">-</span><span class="dv">1</span>]))
<span class="kw">plot</span>(tsne_out<span class="op">$</span>Y)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-77-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat.tsne &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(tsne_out<span class="op">$</span>Y)
<span class="kw">kNNdistplot</span>(dat.tsne,<span class="dt">k=</span><span class="dv">4</span>)</code></pre></div>
<p><img src="LendingClub_xlu1__1__files/figure-html/unnamed-chunk-77-2.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res.tsne &lt;-<span class="st"> </span><span class="kw">dbscan</span>(dat.tsne,<span class="dt">eps =</span><span class="fl">1.2</span> ,<span class="dt">minPts =</span> <span class="dv">4</span>)</code></pre></div>
<p>Some use of clustering after dimension reduction includes using the results as a new feature to predict the final results.</p>
</div>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
